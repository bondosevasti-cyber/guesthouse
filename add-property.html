<!DOCTYPE html>
<html lang="ka">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>áƒ’áƒáƒœáƒªáƒ®áƒáƒ“áƒ”áƒ‘áƒ˜áƒ¡ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ | GuesthouseGE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Georgian:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            font-family: 'Noto Sans Georgian', sans-serif;
        }

        .custom-scrollbar::-webkit-scrollbar {
            height: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 4px;
        }

        .current-month-col {
            background-color: #f0fdf4;
            border-left: 2px solid #22c55e;
            border-right: 2px solid #22c55e;
        }

        .current-month-header {
            background-color: #22c55e;
            color: white;
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="bg-gray-50 pb-32">

    <!-- NAVBAR -->
    <nav class="fixed top-0 left-0 w-full z-50 bg-white shadow-sm py-3 transition-all duration-300">
        <div class="max-w-7xl mx-auto px-4 flex justify-between items-center">
            <a href="index.html">
                <img src="images/gh_logo.webp" alt="GuesthouseGE" class="h-10 w-auto object-contain cursor-pointer">
            </a>
            <div class="flex items-center space-x-3">
                <a href="pricing.html"
                    class="hidden md:flex items-center bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-sm transition-all text-sm">
                    áƒ¤áƒáƒ¡áƒ”áƒ‘áƒ˜áƒ¡ áƒœáƒáƒ®áƒ•áƒ
                </a>
                <button onclick="window.location.href='add-property.html'"
                    class="bg-amber-500 hover:bg-amber-600 text-white font-bold p-2 rounded-full transition-all shadow-md flex items-center justify-center">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                </button>
                <div id="navAuthBtnContainer"></div>
            </div>
        </div>
    </nav>

    <!-- MAIN FORM -->
    <main class="max-w-5xl mx-auto px-4 mt-24 space-y-8">

        <!-- SECTION 1: MAIN EXTERIOR PHOTOS -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
            <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <span class="bg-amber-100 text-amber-600 p-1.5 rounded-md">ğŸ“¸</span>
                áƒ’áƒáƒ áƒ” áƒ•áƒ˜áƒ–áƒ£áƒáƒšáƒ˜ (áƒ›áƒ—áƒáƒ•áƒáƒ áƒ˜ áƒ¤áƒáƒ¢áƒáƒ”áƒ‘áƒ˜)
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3" id="mainImagesGrid">
                <!-- Add Button -->
                <label
                    class="aspect-square border-2 border-dashed border-gray-300 rounded-xl hover:border-amber-500 hover:bg-amber-50 cursor-pointer flex flex-col items-center justify-center transition group">
                    <input type="file" multiple accept="image/*" class="hidden"
                        onchange="window.handleMainImages(this)">
                    <div
                        class="w-8 h-8 bg-gray-100 text-gray-400 rounded-full flex items-center justify-center mb-1 group-hover:bg-amber-100 group-hover:text-amber-500 transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                    </div>
                    <span class="text-[10px] font-bold text-gray-400 group-hover:text-amber-600">áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ</span>
                </label>
            </div>
        </div>

        <!-- SECTION 2: ROOM MANAGEMENT -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                    <span class="bg-indigo-100 text-indigo-600 p-1.5 rounded-md">ğŸ›ï¸</span>
                    áƒáƒ—áƒáƒ®áƒ”áƒ‘áƒ˜áƒ¡ áƒ›áƒáƒ áƒ—áƒ•áƒ
                </h2>
                <button onclick="window.addRoom()"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold px-4 py-2 rounded-lg shadow flex items-center gap-2 transition hover:scale-105 active:scale-95">
                    <span>+</span> áƒáƒ—áƒáƒ®áƒ˜áƒ¡ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ
                </button>
            </div>
            <div id="roomsContainer" class="space-y-4">
                <!-- Room Blocks -->
            </div>
        </div>

        <!-- SECTION 3: SEASONAL PRICES -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 overflow-hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                    <span class="bg-green-100 text-green-600 p-1.5 rounded-md">ğŸ“…</span>
                    áƒ¡áƒ”áƒ–áƒáƒœáƒ£áƒ áƒ˜ áƒ¤áƒáƒ¡áƒ”áƒ‘áƒ˜
                </h2>
                <button onclick="window.clearSeasonalTable()"
                    class="text-xs text-red-500 font-bold hover:bg-red-50 px-3 py-1 rounded transition">
                    áƒ’áƒáƒ¡áƒ£áƒ¤áƒ—áƒáƒ•áƒ”áƒ‘áƒ
                </button>
            </div>
            <div class="overflow-x-auto custom-scrollbar pb-2">
                <table class="w-full text-sm border-collapse">
                    <thead>
                        <tr class="bg-gray-50 text-gray-500 text-xs uppercase" id="seasonalHeader">
                            <th class="p-3 text-left min-w-[150px] sticky left-0 bg-gray-50 z-10 border-b">áƒáƒ—áƒáƒ®áƒ˜</th>
                            <th class="p-2 border-b text-center">âš¡</th>
                            <!-- Months JS generated -->
                        </tr>
                    </thead>
                    <tbody id="seasonalBody" class="divide-y divide-gray-100">
                        <tr>
                            <td colspan="14" class="p-8 text-center text-gray-400">áƒ¯áƒ”áƒ  áƒ“áƒáƒáƒ›áƒáƒ¢áƒ”áƒ— áƒáƒ—áƒáƒ®áƒ”áƒ‘áƒ˜</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- SECTION 4: BASIC INFO -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
            <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <span class="bg-blue-100 text-blue-600 p-1.5 rounded-md">â„¹ï¸</span>
                áƒ«áƒ˜áƒ áƒ˜áƒ—áƒáƒ“áƒ˜ áƒ˜áƒœáƒ¤áƒáƒ áƒ›áƒáƒªáƒ˜áƒ
            </h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">áƒ¡áƒáƒ¡áƒ¢áƒ£áƒ›áƒ áƒáƒ¡ áƒ¡áƒáƒ®áƒ”áƒšáƒ˜</label>
                    <input type="text" id="propName"
                        class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg outline-none focus:border-amber-500 focus:bg-white transition"
                        placeholder="áƒ›áƒáƒ’: Villa Green">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">áƒ›áƒáƒ¡áƒáƒ˜áƒœáƒ«áƒšáƒ˜áƒ¡ áƒ¡áƒáƒ®áƒ”áƒšáƒ˜</label>
                        <input type="text" id="hostName"
                            class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg outline-none focus:border-amber-500 focus:bg-white transition">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">áƒ’áƒ•áƒáƒ áƒ˜</label>
                        <input type="text" id="hostSurname"
                            class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg outline-none focus:border-amber-500 focus:bg-white transition">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">áƒ¢áƒ”áƒšáƒ”áƒ¤áƒáƒœáƒ˜</label>
                    <input type="tel" id="hostPhone"
                        class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg outline-none focus:border-amber-500 focus:bg-white transition"
                        placeholder="+995 555 00 00 00">
                </div>
            </div>
        </div>

        <!-- SECTION 5: LOCATION -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 relative z-30">
            <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <span class="bg-red-100 text-red-600 p-1.5 rounded-md">ğŸ“</span>
                áƒšáƒáƒ™áƒáƒªáƒ˜áƒ
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="relative">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">áƒ¥áƒáƒšáƒáƒ¥áƒ˜ / áƒ¡áƒáƒ¤áƒ”áƒšáƒ˜</label>
                    <input type="text" id="cityInput" placeholder="áƒ“áƒáƒ˜áƒ¬áƒ§áƒ”áƒ— áƒ¬áƒ”áƒ áƒ..."
                        class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg outline-none focus:border-amber-500 focus:bg-white transition"
                        autocomplete="off">
                    <!-- Dropdown -->
                    <ul id="cityDropdown"
                        class="hidden absolute top-full left-0 w-full bg-white border border-gray-100 rounded-lg shadow-xl mt-1 max-h-60 overflow-y-auto z-50 divide-y divide-gray-50">
                    </ul>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">áƒ áƒ”áƒ’áƒ˜áƒáƒœáƒ˜</label>
                    <input type="text" id="regionInput" readonly
                        class="w-full p-2.5 bg-gray-100 border border-gray-200 rounded-lg text-gray-500">
                </div>
            </div>
        </div>

        <!-- SECTION 6: TYPE & DESCRIPTION -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
            <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <span class="bg-purple-100 text-purple-600 p-1.5 rounded-md">ğŸ“</span>
                áƒáƒ¦áƒ¬áƒ”áƒ áƒ áƒ“áƒ áƒ¢áƒ˜áƒáƒ˜
            </h2>
            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">áƒáƒ‘áƒ˜áƒ”áƒ¥áƒ¢áƒ˜áƒ¡ áƒ¢áƒ˜áƒáƒ˜</label>
                <select id="propType"
                    class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg outline-none focus:border-amber-500 cursor-pointer">
                    <option value="Hotel">áƒ¡áƒáƒ¡áƒ¢áƒ£áƒ›áƒ áƒ</option>
                    <option value="Guest House">áƒ¡áƒáƒáƒ¯áƒáƒ®áƒ áƒ¡áƒáƒ¡áƒ¢áƒ£áƒ›áƒ áƒ</option>
                    <option value="Cottage">áƒ™áƒáƒ¢áƒ”áƒ¯áƒ˜</option>
                    <option value="Apartment">áƒ‘áƒ˜áƒœáƒ</option>
                    <option value="Villa">áƒ•áƒ˜áƒšáƒ</option>
                    <option value="Glamping">áƒ’áƒšáƒ”áƒ›áƒáƒ˜áƒœáƒ’áƒ˜</option>
                </select>
            </div>
            <div>
                <div class="flex justify-between">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">áƒáƒ¦áƒ¬áƒ”áƒ áƒ</label>
                    <span id="descCount" class="text-xs text-gray-400">0 / 1500</span>
                </div>
                <textarea id="propDesc" rows="4" maxlength="1500"
                    class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg outline-none focus:border-amber-500 focus:bg-white transition resize-none"></textarea>
            </div>
        </div>

        <!-- SECTION 7: AMENITIES -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
            <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <span class="bg-orange-100 text-orange-600 p-1.5 rounded-md">âœ¨</span>
                áƒ™áƒ”áƒ—áƒ˜áƒšáƒ›áƒáƒ¬áƒ§áƒáƒ‘áƒ
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-3" id="amenitiesContainer">
                <label
                    class="flex items-center space-x-2 p-2 border border-gray-100 rounded-lg hover:border-amber-300 cursor-pointer transition">
                    <input type="checkbox" value="WiFi" class="w-4 h-4 text-amber-500 rounded focus:ring-amber-500">
                    <span class="text-sm text-gray-700">WiFi</span>
                </label>
                <label
                    class="flex items-center space-x-2 p-2 border border-gray-100 rounded-lg hover:border-amber-300 cursor-pointer transition">
                    <input type="checkbox" value="Parking" class="w-4 h-4 text-amber-500 rounded focus:ring-amber-500">
                    <span class="text-sm text-gray-700">áƒáƒáƒ áƒ™áƒ˜áƒœáƒ’áƒ˜</span>
                </label>
                <label
                    class="flex items-center space-x-2 p-2 border border-gray-100 rounded-lg hover:border-amber-300 cursor-pointer transition">
                    <input type="checkbox" value="Pool" class="w-4 h-4 text-amber-500 rounded focus:ring-amber-500">
                    <span class="text-sm text-gray-700">áƒáƒ£áƒ–áƒ˜</span>
                </label>
                <label
                    class="flex items-center space-x-2 p-2 border border-gray-100 rounded-lg hover:border-amber-300 cursor-pointer transition">
                    <input type="checkbox" value="Breakfast"
                        class="w-4 h-4 text-amber-500 rounded focus:ring-amber-500">
                    <span class="text-sm text-gray-700">áƒ¡áƒáƒ£áƒ–áƒ›áƒ”</span>
                </label>
                <label
                    class="flex items-center space-x-2 p-2 border border-gray-100 rounded-lg hover:border-amber-300 cursor-pointer transition">
                    <input type="checkbox" value="AC" class="w-4 h-4 text-amber-500 rounded focus:ring-amber-500">
                    <span class="text-sm text-gray-700">áƒ™áƒáƒœáƒ“áƒ˜áƒªáƒ˜áƒáƒœáƒ”áƒ áƒ˜</span>
                </label>
                <label
                    class="flex items-center space-x-2 p-2 border border-gray-100 rounded-lg hover:border-amber-300 cursor-pointer transition">
                    <input type="checkbox" value="Balcony" class="w-4 h-4 text-amber-500 rounded focus:ring-amber-500">
                    <span class="text-sm text-gray-700">áƒáƒ˜áƒ•áƒáƒœáƒ˜</span>
                </label>
            </div>
            <button onclick="window.addCustomService()"
                class="mt-4 text-sm font-bold text-amber-600 hover:text-amber-700 flex items-center gap-1 transition">
                <span>+</span> áƒ¡áƒ®áƒ•áƒ áƒ¡áƒ”áƒ áƒ•áƒ˜áƒ¡áƒ˜áƒ¡ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ
            </button>
        </div>

        <!-- SUBMIT -->
        <div
            class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-100 p-4 z-40 flex justify-center md:justify-end md:px-20 shadow-[0_-5px_10px_rgba(0,0,0,0.05)]">
            <button onclick="window.submitProperty()" id="submitBtn"
                class="bg-gray-900 hover:bg-black text-white font-bold py-3 px-8 rounded-full shadow-lg transform active:scale-95 transition-all text-base w-full md:w-auto">
                áƒ’áƒáƒœáƒªáƒ®áƒáƒ“áƒ”áƒ‘áƒ˜áƒ¡ áƒ’áƒáƒ›áƒáƒ¥áƒ•áƒ”áƒ§áƒœáƒ”áƒ‘áƒ
            </button>
        </div>

    </main>

    <script>
        // CONFIG
        const SUPABASE_URL = 'https://akmbyvovhubccznrzotv.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFrbWJ5dm92aHViY2N6bnJ6b3R2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3NTgwMTAsImV4cCI6MjA4MjMzNDAxMH0.oHLvbx5_4hYATF-hQkJvp0oxZ6ljUfGKYP-Mf7_CVtM';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const LOCATIONS = [
            { c: "áƒ—áƒ‘áƒ˜áƒšáƒ˜áƒ¡áƒ˜", r: "áƒ—áƒ‘áƒ˜áƒšáƒ˜áƒ¡áƒ˜" }, { c: "áƒ‘áƒáƒ—áƒ£áƒ›áƒ˜", r: "áƒáƒ­áƒáƒ áƒ" }, { c: "áƒ¥áƒ£áƒ—áƒáƒ˜áƒ¡áƒ˜", r: "áƒ˜áƒ›áƒ”áƒ áƒ”áƒ—áƒ˜" }, { c: "áƒ áƒ£áƒ¡áƒ—áƒáƒ•áƒ˜", r: "áƒ¥áƒ•áƒ”áƒ›áƒ áƒ¥áƒáƒ áƒ—áƒšáƒ˜" },
            { c: "áƒ’áƒáƒ áƒ˜", r: "áƒ¨áƒ˜áƒ“áƒ áƒ¥áƒáƒ áƒ—áƒšáƒ˜" }, { c: "áƒ–áƒ£áƒ’áƒ“áƒ˜áƒ“áƒ˜", r: "áƒ¡áƒáƒ›áƒ”áƒ’áƒ áƒ”áƒšáƒ" }, { c: "áƒ¤áƒáƒ—áƒ˜", r: "áƒ¡áƒáƒ›áƒ”áƒ’áƒ áƒ”áƒšáƒ" }, { c: "áƒ¥áƒáƒ‘áƒ£áƒšáƒ”áƒ—áƒ˜", r: "áƒáƒ­áƒáƒ áƒ" },
            { c: "áƒ®áƒáƒ¨áƒ£áƒ áƒ˜", r: "áƒ¨áƒ˜áƒ“áƒ áƒ¥áƒáƒ áƒ—áƒšáƒ˜" }, { c: "áƒ¡áƒáƒ›áƒ¢áƒ áƒ”áƒ“áƒ˜áƒ", r: "áƒ˜áƒ›áƒ”áƒ áƒ”áƒ—áƒ˜" }, { c: "áƒ¡áƒ”áƒœáƒáƒ™áƒ˜", r: "áƒ¡áƒáƒ›áƒ”áƒ’áƒ áƒ”áƒšáƒ" }, { c: "áƒ–áƒ”áƒ¡áƒ¢áƒáƒ¤áƒáƒœáƒ˜", r: "áƒ˜áƒ›áƒ”áƒ áƒ”áƒ—áƒ˜" },
            { c: "áƒ›áƒáƒ áƒœáƒ”áƒ£áƒšáƒ˜", r: "áƒ¥áƒ•áƒ”áƒ›áƒ áƒ¥áƒáƒ áƒ—áƒšáƒ˜" }, { c: "áƒ—áƒ”áƒšáƒáƒ•áƒ˜", r: "áƒ™áƒáƒ®áƒ”áƒ—áƒ˜" }, { c: "áƒáƒ®áƒáƒšáƒªáƒ˜áƒ®áƒ”", r: "áƒ¡áƒáƒ›áƒªáƒ®áƒ”-áƒ¯áƒáƒ•áƒáƒ®áƒ”áƒ—áƒ˜" }, { c: "áƒ¥áƒ”áƒ“áƒ", r: "áƒáƒ­áƒáƒ áƒ" },
            { c: "áƒáƒ–áƒ£áƒ áƒ’áƒ”áƒ—áƒ˜", r: "áƒ’áƒ£áƒ áƒ˜áƒ" }, { c: "áƒ™áƒáƒ¡áƒáƒ˜", r: "áƒ¨áƒ˜áƒ“áƒ áƒ¥áƒáƒ áƒ—áƒšáƒ˜" }, { c: "áƒ­áƒ˜áƒáƒ—áƒ£áƒ áƒ", r: "áƒ˜áƒ›áƒ”áƒ áƒ”áƒ—áƒ˜" }, { c: "áƒ¬áƒ§áƒáƒšáƒ¢áƒ£áƒ‘áƒ", r: "áƒ˜áƒ›áƒ”áƒ áƒ”áƒ—áƒ˜" },
            { c: "áƒ¡áƒáƒ’áƒáƒ áƒ”áƒ¯áƒ", r: "áƒ™áƒáƒ®áƒ”áƒ—áƒ˜" }, { c: "áƒ’áƒáƒ áƒ“áƒáƒ‘áƒáƒœáƒ˜", r: "áƒ¥áƒ•áƒ”áƒ›áƒ áƒ¥áƒáƒ áƒ—áƒšáƒ˜" }, { c: "áƒ‘áƒáƒ áƒ¯áƒáƒ›áƒ˜", r: "áƒ¡áƒáƒ›áƒªáƒ®áƒ”-áƒ¯áƒáƒ•áƒáƒ®áƒ”áƒ—áƒ˜" }, { c: "áƒ¢áƒ§áƒ˜áƒ‘áƒ£áƒšáƒ˜", r: "áƒ˜áƒ›áƒ”áƒ áƒ”áƒ—áƒ˜" },
            { c: "áƒ®áƒáƒœáƒ˜", r: "áƒ˜áƒ›áƒ”áƒ áƒ”áƒ—áƒ˜" }, { c: "áƒ‘áƒáƒšáƒœáƒ˜áƒ¡áƒ˜", r: "áƒ¥áƒ•áƒ”áƒ›áƒ áƒ¥áƒáƒ áƒ—áƒšáƒ˜" }, { c: "áƒáƒ®áƒáƒšáƒ¥áƒáƒšáƒáƒ¥áƒ˜", r: "áƒ¡áƒáƒ›áƒªáƒ®áƒ”-áƒ¯áƒáƒ•áƒáƒ®áƒ”áƒ—áƒ˜" }, { c: "áƒ’áƒ£áƒ áƒ¯áƒáƒáƒœáƒ˜", r: "áƒ™áƒáƒ®áƒ”áƒ—áƒ˜" },
            { c: "áƒ›áƒªáƒ®áƒ”áƒ—áƒ", r: "áƒ›áƒªáƒ®áƒ”áƒ—áƒ-áƒ›áƒ—áƒ˜áƒáƒœáƒ”áƒ—áƒ˜" }, { c: "áƒ§áƒ•áƒáƒ áƒ”áƒšáƒ˜", r: "áƒ™áƒáƒ®áƒ”áƒ—áƒ˜" }, { c: "áƒáƒ®áƒ›áƒ”áƒ¢áƒ", r: "áƒ™áƒáƒ®áƒ”áƒ—áƒ˜" }, { c: "áƒ¥áƒáƒ áƒ”áƒšáƒ˜", r: "áƒ¨áƒ˜áƒ“áƒ áƒ¥áƒáƒ áƒ—áƒšáƒ˜" },
            { c: "áƒšáƒáƒœáƒ©áƒ®áƒ£áƒ—áƒ˜", r: "áƒ’áƒ£áƒ áƒ˜áƒ" }, { c: "áƒ“áƒ£áƒ¨áƒ”áƒ—áƒ˜", r: "áƒ›áƒªáƒ®áƒ”áƒ—áƒ-áƒ›áƒ—áƒ˜áƒáƒœáƒ”áƒ—áƒ˜" }, { c: "áƒ¡áƒáƒ©áƒ®áƒ”áƒ áƒ”", r: "áƒ˜áƒ›áƒ”áƒ áƒ”áƒ—áƒ˜" }, { c: "áƒ“áƒ”áƒ“áƒáƒ¤áƒšáƒ˜áƒ¡áƒ¬áƒ§áƒáƒ áƒ", r: "áƒ™áƒáƒ®áƒ”áƒ—áƒ˜" },
            { c: "áƒšáƒáƒ’áƒáƒ“áƒ”áƒ®áƒ˜", r: "áƒ™áƒáƒ®áƒ”áƒ—áƒ˜" }, { c: "áƒœáƒ˜áƒœáƒáƒ¬áƒ›áƒ˜áƒœáƒ“áƒ", r: "áƒ¡áƒáƒ›áƒªáƒ®áƒ”-áƒ¯áƒáƒ•áƒáƒ®áƒ”áƒ—áƒ˜" }, { c: "áƒáƒ‘áƒáƒ¨áƒ", r: "áƒ¡áƒáƒ›áƒ”áƒ’áƒ áƒ”áƒšáƒ" }, { c: "áƒ¬áƒœáƒáƒ áƒ˜", r: "áƒ™áƒáƒ®áƒ”áƒ—áƒ˜" },
            { c: "áƒ—áƒ”áƒ áƒ¯áƒáƒšáƒ", r: "áƒ˜áƒ›áƒ”áƒ áƒ”áƒ—áƒ˜" }, { c: "áƒ›áƒáƒ áƒ¢áƒ•áƒ˜áƒšáƒ˜", r: "áƒ¡áƒáƒ›áƒ”áƒ’áƒ áƒ”áƒšáƒ" }, { c: "áƒ¯áƒ•áƒáƒ áƒ˜", r: "áƒ¡áƒáƒ›áƒ”áƒ’áƒ áƒ”áƒšáƒ" }, { c: "áƒ®áƒáƒ‘áƒ˜", r: "áƒ¡áƒáƒ›áƒ”áƒ’áƒ áƒ”áƒšáƒ" },
            { c: "áƒ•áƒáƒœáƒ˜", r: "áƒ˜áƒ›áƒ”áƒ áƒ”áƒ—áƒ˜" }, { c: "áƒ‘áƒáƒ¦áƒ“áƒáƒ—áƒ˜", r: "áƒ˜áƒ›áƒ”áƒ áƒ”áƒ—áƒ˜" }, { c: "áƒ•áƒáƒšáƒ”", r: "áƒ¡áƒáƒ›áƒªáƒ®áƒ”-áƒ¯áƒáƒ•áƒáƒ®áƒ”áƒ—áƒ˜" }, { c: "áƒ©áƒ®áƒáƒ áƒáƒ¬áƒ§áƒ£", r: "áƒ¡áƒáƒ›áƒ”áƒ’áƒ áƒ”áƒšáƒ" },
            { c: "áƒ—áƒ”áƒ—áƒ áƒ˜áƒ¬áƒ§áƒáƒ áƒ", r: "áƒ¥áƒ•áƒ”áƒ›áƒ áƒ¥áƒáƒ áƒ—áƒšáƒ˜" }, { c: "áƒ“áƒ›áƒáƒœáƒ˜áƒ¡áƒ˜", r: "áƒ¥áƒ•áƒ”áƒ›áƒ áƒ¥áƒáƒ áƒ—áƒšáƒ˜" }, { c: "áƒáƒœáƒ˜", r: "áƒ áƒáƒ­áƒ" }, { c: "áƒáƒ›áƒ‘áƒ áƒáƒšáƒáƒ£áƒ áƒ˜", r: "áƒ áƒáƒ­áƒ" },
            { c: "áƒ¡áƒ˜áƒ¦áƒœáƒáƒ¦áƒ˜", r: "áƒ™áƒáƒ®áƒ”áƒ—áƒ˜" }, { c: "áƒªáƒáƒ’áƒ”áƒ áƒ˜", r: "áƒšáƒ”áƒ©áƒ®áƒ£áƒ›áƒ˜" }, { c: "áƒ¬áƒáƒšáƒ™áƒ", r: "áƒ¥áƒ•áƒ”áƒ›áƒ áƒ¥áƒáƒ áƒ—áƒšáƒ˜" }, { c: "áƒ›áƒ”áƒ¡áƒ¢áƒ˜áƒ", r: "áƒ¡áƒ•áƒáƒœáƒ”áƒ—áƒ˜" },
            { c: "áƒ§áƒáƒ–áƒ‘áƒ”áƒ’áƒ˜", r: "áƒ›áƒªáƒ®áƒ”áƒ—áƒ-áƒ›áƒ—áƒ˜áƒáƒœáƒ”áƒ—áƒ˜" }, { c: "áƒ¡áƒ¢áƒ”áƒ¤áƒáƒœáƒ¬áƒ›áƒ˜áƒœáƒ“áƒ", r: "áƒ›áƒªáƒ®áƒ”áƒ—áƒ-áƒ›áƒ—áƒ˜áƒáƒœáƒ”áƒ—áƒ˜" }, { c: "áƒ’áƒ£áƒ“áƒáƒ£áƒ áƒ˜", r: "áƒ›áƒªáƒ®áƒ”áƒ—áƒ-áƒ›áƒ—áƒ˜áƒáƒœáƒ”áƒ—áƒ˜" },
            { c: "áƒ‘áƒáƒ™áƒ£áƒ áƒ˜áƒáƒœáƒ˜", r: "áƒ¡áƒáƒ›áƒªáƒ®áƒ”-áƒ¯áƒáƒ•áƒáƒ®áƒ”áƒ—áƒ˜" }, { c: "áƒ£áƒ áƒ”áƒ™áƒ˜", r: "áƒ’áƒ£áƒ áƒ˜áƒ" }, { c: "áƒ¨áƒ”áƒ™áƒ•áƒ”áƒ—áƒ˜áƒšáƒ˜", r: "áƒ’áƒ£áƒ áƒ˜áƒ" }, { c: "áƒ’áƒáƒœáƒ˜áƒ", r: "áƒáƒ­áƒáƒ áƒ" },
            { c: "áƒ¡áƒáƒ áƒ¤áƒ˜", r: "áƒáƒ­áƒáƒ áƒ" }, { c: "áƒáƒœáƒáƒ™áƒšáƒ˜áƒ", r: "áƒ¡áƒáƒ›áƒ”áƒ’áƒ áƒ”áƒšáƒ" }, { c: "áƒ¨áƒáƒ•áƒ˜", r: "áƒ áƒáƒ­áƒ" }, { c: "áƒ‘áƒáƒ®áƒ›áƒáƒ áƒ", r: "áƒ’áƒ£áƒ áƒ˜áƒ" },
            { c: "áƒ¡áƒáƒ˜áƒ áƒ›áƒ”", r: "áƒ˜áƒ›áƒ”áƒ áƒ”áƒ—áƒ˜" }, { c: "áƒáƒ‘áƒáƒ¡áƒ—áƒ£áƒ›áƒáƒœáƒ˜", r: "áƒ¡áƒáƒ›áƒªáƒ®áƒ”-áƒ¯áƒáƒ•áƒáƒ®áƒ”áƒ—áƒ˜" }, { c: "áƒ’áƒ áƒ˜áƒ’áƒáƒšáƒ”áƒ—áƒ˜", r: "áƒ’áƒ£áƒ áƒ˜áƒ" }, { c: "áƒ›áƒáƒšáƒ—áƒáƒ§áƒ•áƒ", r: "áƒ¡áƒáƒ›áƒ”áƒ’áƒ áƒ”áƒšáƒ" }
        ];

        const MONTHS = ["áƒ˜áƒáƒœ", "áƒ—áƒ”áƒ‘", "áƒ›áƒáƒ ", "áƒáƒáƒ ", "áƒ›áƒáƒ˜", "áƒ˜áƒ•áƒœ", "áƒ˜áƒ•áƒš", "áƒáƒ’áƒ•", "áƒ¡áƒ”áƒ¥", "áƒáƒ¥áƒ¢", "áƒœáƒáƒ”", "áƒ“áƒ”áƒ™"];
        const CUR_MONTH_IDX = new Date().getMonth();

        // STATE
        let GSTATE = {
            editId: new URLSearchParams(window.location.search).get('id'),
            mainImages: [],
            rooms: [],
            user: null,
            originalRoomIds: []
        };

        // 1. AUTH & INIT
        window.checkAuth = async function () {
            const { data: { session } } = await supabaseClient.auth.getSession();
            GSTATE.user = session ? session.user : null;
            window.updateAuthUI();
            if (GSTATE.editId) await window.loadPropertyForEdit();
        };

        window.loadPropertyForEdit = async function () {
            try {
                const { data: prop, error } = await supabaseClient.from('guesthouse_ge').select('*').eq('id', GSTATE.editId).single();
                if (error || !prop) throw new Error('áƒ’áƒáƒœáƒªáƒ®áƒáƒ“áƒ”áƒ‘áƒ áƒ•áƒ”áƒ  áƒ›áƒáƒ˜áƒ«áƒ”áƒ‘áƒœáƒ');

                // Populate Fields
                document.getElementById('propName').value = prop.name;
                const hName = prop.host_name || "";
                document.getElementById('hostName').value = hName.split(' ')[0] || "";
                document.getElementById('hostSurname').value = hName.split(' ').slice(1).join(' ') || "";
                document.getElementById('hostPhone').value = prop.phone;
                document.getElementById('cityInput').value = prop.location;
                const rgn = LOCATIONS.find(l => l.c === prop.location)?.r || "";
                document.getElementById('regionInput').value = rgn;
                document.getElementById('propType').value = prop.type;
                document.getElementById('propDesc').value = prop.description;
                document.getElementById('descCount').innerText = `${prop.description.length} / 1500`;

                // Amenities
                const amensContainer = document.getElementById('amenitiesContainer');
                if (prop.amenities) {
                    prop.amenities.forEach(a => {
                        const cb = amensContainer.querySelector(`input[value="${a}"]`);
                        if (cb) cb.checked = true;
                        else window.addCustomService(a);
                    });
                }

                // Images
                GSTATE.mainImages = prop.images || [];
                window.renderMainImages();

                // Rooms
                const { data: rooms, error: rErr } = await supabaseClient.from('rooms').select('*').eq('property_id', GSTATE.editId);
                if (rErr) throw rErr;
                GSTATE.originalRoomIds = rooms.map(r => r.id);
                GSTATE.rooms = rooms.map(r => {
                    // Try matching prices from JSON by room name
                    const sp = prop.seasonal_prices?.find(s => s.label === r.name);
                    return {
                        id: r.id,
                        isNew: false,
                        name: r.name,
                        beds: r.beds,
                        images: r.images || [],
                        prices: sp ? sp.prices : Array(12).fill('')
                    };
                });

                window.renderRooms();
                window.renderSeasonalTable();
                document.getElementById('submitBtn').innerText = 'áƒªáƒ•áƒšáƒ˜áƒšáƒ”áƒ‘áƒ”áƒ‘áƒ˜áƒ¡ áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ';

            } catch (err) {
                console.error(err);
                Swal.fire('áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ', 'áƒ›áƒáƒœáƒáƒªáƒ”áƒ›áƒ”áƒ‘áƒ˜áƒ¡ áƒ©áƒáƒ¢áƒ•áƒ˜áƒ áƒ—áƒ•áƒ áƒ•áƒ”áƒ  áƒ›áƒáƒ®áƒ”áƒ áƒ®áƒ“áƒ', 'error');
            }
        };

        window.updateAuthUI = function () {
            const container = document.getElementById('navAuthBtnContainer');
            if (!container) return;
            if (!GSTATE.user) {
                container.innerHTML = `<button onclick="window.location.href='index.html?auth=login'" class="bg-[#2d78b1] hover:bg-[#236a9e] text-white font-bold py-2 px-6 rounded-full transition-all shadow-sm">áƒ¨áƒ”áƒ¡áƒ•áƒšáƒ</button>`;
                return;
            }
            const name = GSTATE.user.user_metadata.full_name || GSTATE.user.email.split('@')[0];
            const avatar = GSTATE.user.user_metadata.avatar_url || 'https://www.gravatar.com/avatar/?d=mp';
            container.innerHTML = `
                <div class="relative ml-2 group">
                    <button class="flex items-center space-x-2 focus:outline-none bg-white hover:bg-gray-50 rounded-full pl-1 pr-3 py-1 transition-colors border border-gray-200 shadow-sm">
                        <img src="${avatar}" class="w-8 h-8 rounded-full border border-gray-200 object-cover">
                        <span class="hidden sm:inline text-sm font-bold text-gray-700 max-w-[100px] truncate">${name}</span>
                        <svg class="w-4 h-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </button>
                    <div class="absolute right-0 mt-2 w-56 bg-white rounded-xl shadow-xl border border-gray-100 py-2 hidden group-hover:block z-50">
                        <a href="profile.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-amber-50 hover:text-amber-600 transition">áƒ©áƒ”áƒ›áƒ˜ áƒ’áƒáƒœáƒªáƒ®áƒáƒ“áƒ”áƒ‘áƒ”áƒ‘áƒ˜</a>
                        <div class="border-t border-gray-100 mt-1">
                            <button onclick="supabaseClient.auth.signOut().then(()=>window.location.reload())" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition">áƒ’áƒáƒ¡áƒ•áƒšáƒ</button>
                        </div>
                    </div>
                </div>`;
        };

        // 2. MAIN IMAGES
        window.handleMainImages = function (input) {
            const files = Array.from(input.files);
            GSTATE.mainImages = [...GSTATE.mainImages, ...files];
            window.renderMainImages();
        };

        window.renderMainImages = function () {
            const grid = document.getElementById('mainImagesGrid');
            const addBtn = grid.firstElementChild;
            grid.innerHTML = '';
            grid.appendChild(addBtn);
            GSTATE.mainImages.forEach((item, index) => {
                const src = (typeof item === 'string') ? item : URL.createObjectURL(item);
                const div = document.createElement('div');
                div.className = "relative aspect-square rounded-xl overflow-hidden shadow-sm border border-gray-200 group";
                div.innerHTML = `
                    <img src="${src}" class="w-full h-full object-cover">
                    <button onclick="window.removeMainImage(${index})" class="absolute top-1 right-1 bg-white text-red-500 rounded-full p-1 opacity-0 group-hover:opacity-100 transition shadow hover:bg-red-50">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                `;
                grid.appendChild(div);
            });
        };
        window.removeMainImage = (i) => { GSTATE.mainImages.splice(i, 1); window.renderMainImages(); };

        // 3. ROOMS
        window.addRoom = function () {
            const roomId = "new_" + Date.now().toString();
            GSTATE.rooms.push({ id: roomId, isNew: true, name: `Room ${GSTATE.rooms.length + 1}`, beds: 2, images: [], prices: Array(12).fill('') });
            window.renderRooms();
            window.renderSeasonalTable();
        };

        window.renderRooms = function () {
            const container = document.getElementById('roomsContainer');
            container.innerHTML = '';
            GSTATE.rooms.forEach((room, index) => {
                const div = document.createElement('div');
                div.className = "bg-white border border-gray-200 rounded-2xl p-6 relative shadow-sm animate-fade-in mb-4";
                const imageThumbnails = room.images.map((img, i) => {
                    const src = (typeof img === 'string') ? img : URL.createObjectURL(img);
                    return `
                    <div class="relative aspect-square rounded-xl overflow-hidden bg-gray-100 border border-gray-200 group shadow-sm hover:shadow-md transition">
                        <img src="${src}" class="w-full h-full object-cover">
                        <button onclick="window.removeRoomImage('${room.id}', ${i})" class="absolute top-1 right-1 bg-white/90 text-red-500 rounded-full p-1 opacity-0 group-hover:opacity-100 shadow transition hover:bg-red-50 backdrop-blur-sm">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                        </button>
                    </div>`;
                }).join('');

                const addBtn = room.images.length < 15 ? `
                    <label class="aspect-square border-2 border-dashed border-gray-300 rounded-xl hover:border-amber-500 hover:bg-amber-50 cursor-pointer flex flex-col items-center justify-center transition group">
                        <input type="file" multiple accept="image/*" class="hidden" onchange="window.handleRoomImages(this, '${room.id}')">
                        <div class="w-10 h-10 bg-gray-100 text-gray-400 rounded-full flex items-center justify-center group-hover:bg-amber-100 group-hover:text-amber-500 transition">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v12m6-6H6" /></svg>
                        </div>
                    </label>` : '';

                div.innerHTML = `
                    <button onclick="window.removeRoom('${room.id}')" class="absolute top-4 right-4 text-gray-400 hover:text-red-500 bg-gray-50 p-2 rounded-full transition"><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>
                    <div class="flex items-center gap-2 mb-4"><span class="bg-indigo-100 text-indigo-600 font-bold px-2 py-1 rounded text-xs">áƒáƒ—áƒáƒ®áƒ˜ #${index + 1}</span></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">áƒáƒ—áƒáƒ®áƒ˜áƒ¡ áƒ¡áƒáƒ®áƒ”áƒšáƒ˜</label><input type="text" value="${room.name}" oninput="window.updateRoom('${room.id}', 'name', this.value)" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:border-indigo-500 transition"></div>
                        <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">áƒ¡áƒáƒ¬áƒáƒšáƒ”áƒ‘áƒ˜áƒ¡ áƒ áƒáƒáƒ“áƒ”áƒœáƒáƒ‘áƒ</label><input type="number" value="${room.beds}" min="1" oninput="window.updateRoom('${room.id}', 'beds', this.value)" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:border-indigo-500 transition"></div>
                    </div>
                    <div class="border-t border-gray-100 pt-4"><div class="flex justify-between items-end mb-3"><label class="text-xs font-bold text-gray-500 uppercase">áƒ¤áƒáƒ¢áƒáƒ”áƒ‘áƒ˜ (áƒ›áƒáƒ¥áƒ¡. 15)</label><span class="text-xs font-bold ${room.images.length >= 15 ? 'text-red-500' : 'text-gray-400'}">${room.images.length} / 15</span></div><div class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 gap-3">${imageThumbnails}${addBtn}</div></div>`;
                container.appendChild(div);
            });
        };

        window.updateRoom = (id, field, value) => {
            const r = GSTATE.rooms.find(rm => rm.id === id);
            if (r) { r[field] = value; if (field === 'name') window.renderSeasonalTable(); }
        };

        window.removeRoom = (id) => {
            Swal.fire({ title: 'áƒ’áƒ¡áƒ£áƒ áƒ— áƒ¬áƒáƒ¨áƒšáƒ?', icon: 'warning', showCancelButton: true, confirmButtonText: 'áƒ¬áƒáƒ¨áƒšáƒ' }).then(res => {
                if (res.isConfirmed) { GSTATE.rooms = GSTATE.rooms.filter(r => r.id !== id); window.renderRooms(); window.renderSeasonalTable(); }
            });
        };

        window.handleRoomImages = (input, rid) => {
            const r = GSTATE.rooms.find(rm => rm.id === rid);
            if (!r) return;
            const files = Array.from(input.files);
            if (r.images.length + files.length > 15) { Swal.fire('áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ', 'áƒ›áƒáƒ¥áƒ¡áƒ˜áƒ›áƒ£áƒ› 15 áƒ¤áƒáƒ¢áƒ', 'error'); return; }
            r.images = [...r.images, ...files];
            window.renderRooms();
        };

        window.removeRoomImage = (rid, i) => {
            const r = GSTATE.rooms.find(rm => rm.id === rid);
            if (r) { r.images.splice(i, 1); window.renderRooms(); }
        };

        // 4. SEASONAL TABLE
        (function setupTableHeader() {
            const headerRow = document.getElementById('seasonalHeader');
            if (headerRow && headerRow.children.length < 3) {
                MONTHS.forEach((m, i) => {
                    const th = document.createElement('th');
                    th.className = `p-3 min-w-[80px] text-center font-bold text-gray-500 border-b border-gray-100 uppercase text-[11px] tracking-wider ${i === CUR_MONTH_IDX ? 'current-month-header' : ''}`;
                    th.innerText = m;
                    headerRow.appendChild(th);
                });
            }
        })();

        window.renderSeasonalTable = function () {
            const tbody = document.getElementById('seasonalBody');
            tbody.innerHTML = '';
            if (GSTATE.rooms.length === 0) {
                tbody.innerHTML = `<tr><td colspan="14" class="p-8 text-center text-gray-400 bg-gray-50/50 rounded-xl border border-dashed border-gray-200">áƒ¯áƒ”áƒ  áƒ“áƒáƒáƒ›áƒáƒ¢áƒ”áƒ— áƒáƒ—áƒáƒ®áƒ”áƒ‘áƒ˜ áƒ–áƒ”áƒ›áƒáƒ— â¬†ï¸</td></tr>`;
                return;
            }
            GSTATE.rooms.forEach(room => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-amber-50/30 transition-colors";
                let html = `<td class="p-3 border-b border-gray-100 font-bold text-gray-700 sticky left-0 bg-white group-hover:bg-amber-50/30 border-r text-xs truncate max-w-[160px]">${room.name}</td>`;
                html += `<td class="p-2 border-b border-gray-100 text-center border-r"><button onclick="window.fillRow('${room.id}')" class="text-amber-500 hover:bg-amber-500 hover:text-white w-6 h-6 rounded-full transition flex items-center justify-center">âš¡</button></td>`;
                for (let i = 0; i < 12; i++) {
                    const isCur = i === CUR_MONTH_IDX ? 'current-month-col' : '';
                    html += `<td class="p-1 border-b border-gray-100 border-r ${isCur}"><input type="number" class="w-full bg-transparent text-center text-sm outline-none rounded-md py-1" value="${room.prices[i] || ''}" oninput="window.updatePriceState('${room.id}', ${i}, this.value)"></td>`;
                }
                tr.innerHTML = html;
                tbody.appendChild(tr);
            });
        };

        window.updatePriceState = (rid, m, v) => {
            const r = GSTATE.rooms.find(rm => rm.id === rid);
            if (r) r.prices[m] = v;
        };

        window.fillRow = (rid) => {
            const r = GSTATE.rooms.find(rm => rm.id === rid);
            if (r && r.prices[0]) { r.prices = Array(12).fill(r.prices[0]); window.renderSeasonalTable(); }
        };

        window.clearSeasonalTable = () => {
            GSTATE.rooms.forEach(r => r.prices = Array(12).fill(''));
            window.renderSeasonalTable();
        };

        // 5. LOCATION & SERVICES
        const cityInp = document.getElementById('cityInput');
        const cityList = document.getElementById('cityDropdown');
        cityInp.addEventListener('input', e => {
            const val = e.target.value.toLowerCase();
            cityList.innerHTML = '';
            if (val.length < 1) { cityList.classList.add('hidden'); return; }
            const matches = LOCATIONS.filter(l => l.c.toLowerCase().includes(val));
            if (matches.length > 0) {
                cityList.classList.remove('hidden');
                matches.forEach(m => {
                    const li = document.createElement('li');
                    li.className = "px-4 py-2 hover:bg-gray-50 cursor-pointer flex justify-between text-sm";
                    li.innerHTML = `<span>${m.c}</span><span class="text-xs text-gray-400">${m.r}</span>`;
                    li.onclick = () => { cityInp.value = m.c; document.getElementById('regionInput').value = m.r; cityList.classList.add('hidden'); };
                    cityList.appendChild(li);
                });
            } else cityList.classList.add('hidden');
        });

        window.addCustomService = (val = "") => {
            const container = document.getElementById('amenitiesContainer');
            const wrap = document.createElement('div');
            wrap.className = "flex items-center space-x-2";
            wrap.innerHTML = `<div class="flex items-center space-x-2 p-2 border border-blue-200 bg-blue-50/50 rounded-lg w-full"><input type="checkbox" checked disabled><input type="text" class="custom-amenity bg-transparent text-sm outline-none w-full" value="${val}" placeholder="áƒ¡áƒ”áƒ áƒ•áƒ˜áƒ¡áƒ˜..."><button onclick="this.parentElement.parentElement.remove()" class="text-red-400">x</button></div>`;
            container.appendChild(wrap);
            if (!val) wrap.querySelector('input[type="text"]').focus();
        };

        // 6. SUBMIT (CREATE / UPDATE)
        window.submitProperty = async function () {
            if (!GSTATE.user) { Swal.fire('áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ', 'áƒ’áƒ—áƒ®áƒáƒ•áƒ— áƒ’áƒáƒ˜áƒáƒ áƒáƒ— áƒáƒ•áƒ¢áƒáƒ áƒ˜áƒ–áƒáƒªáƒ˜áƒ', 'error'); return; }
            if (GSTATE.mainImages.length === 0) { Swal.fire('áƒ§áƒ£áƒ áƒáƒ“áƒ¦áƒ”áƒ‘áƒ', 'áƒáƒ¢áƒ•áƒ˜áƒ áƒ—áƒ”áƒ— áƒ¤áƒáƒ¢áƒáƒ”áƒ‘áƒ˜', 'warning'); return; }

            const btn = document.getElementById('submitBtn');
            const origText = btn.innerHTML;
            btn.innerHTML = `â³ áƒ˜áƒœáƒáƒ®áƒ”áƒ‘áƒ...`;
            btn.disabled = true;

            try {
                // Main Images
                const finalMainUrls = [];
                for (const item of GSTATE.mainImages) {
                    if (typeof item === 'string') finalMainUrls.push(item);
                    else {
                        const fname = `prop_${GSTATE.user.id}_${Date.now()}_${Math.random().toString(36).substring(7)}.webp`;
                        const { error } = await supabaseClient.storage.from('images').upload(fname, item);
                        if (error) throw error;
                        finalMainUrls.push(supabaseClient.storage.from('images').getPublicUrl(fname).data.publicUrl);
                    }
                }

                // Room Images
                const processedRooms = [];
                for (const r of GSTATE.rooms) {
                    const roomUrls = [];
                    for (const img of r.images) {
                        if (typeof img === 'string') roomUrls.push(img);
                        else {
                            const fname = `room_${GSTATE.user.id}_${Date.now()}_${Math.random().toString(36).substring(7)}.webp`;
                            const { error: rErr } = await supabaseClient.storage.from('images').upload(fname, img);
                            if (!rErr) roomUrls.push(supabaseClient.storage.from('images').getPublicUrl(fname).data.publicUrl);
                        }
                    }
                    processedRooms.push({ ...r, finalImages: roomUrls });
                }

                const seasonalData = processedRooms.map(r => ({ label: r.name, prices: r.prices.map(p => parseInt(p) || 0) }));
                const amens = [];
                document.querySelectorAll('#amenitiesContainer input[type="checkbox"]:checked').forEach(cb => amens.push(cb.value));
                document.querySelectorAll('.custom-amenity').forEach(inpt => { if (inpt.value.trim()) amens.push(inpt.value.trim()); });

                // Prices display
                const allP = seasonalData.flatMap(s => s.prices).filter(p => p > 0);
                const minP = allP.length ? Math.min(...allP) : 0;
                const maxP = allP.length ? Math.max(...allP) : 0;
                const priceDisp = minP === 0 ? "áƒ¨áƒ”áƒ—áƒáƒœáƒ®áƒ›áƒ”áƒ‘áƒ˜áƒ—" : (minP === maxP ? `${minP}â‚¾` : `${minP}â‚¾ - ${maxP}â‚¾`);

                const payload = {
                    user_id: GSTATE.user.id,
                    name: document.getElementById('propName').value,
                    host_name: `${document.getElementById('hostName').value} ${document.getElementById('hostSurname').value}`,
                    phone: document.getElementById('hostPhone').value,
                    location: document.getElementById('cityInput').value,
                    type: document.getElementById('propType').value,
                    description: document.getElementById('propDesc').value,
                    amenities: amens,
                    images: finalMainUrls,
                    image_url: finalMainUrls[0],
                    seasonal_prices: seasonalData,
                    price_display: priceDisp
                };

                let pId = GSTATE.editId;
                if (GSTATE.editId) {
                    const { error } = await supabaseClient.from('guesthouse_ge').update(payload).eq('id', GSTATE.editId);
                    if (error) throw error;
                } else {
                    const { data, error } = await supabaseClient.from('guesthouse_ge').insert([payload]).select();
                    if (error) throw error;
                    pId = data[0].id;
                }

                // Sync Rooms
                const currentRoomIds = GSTATE.rooms.filter(r => !r.isNew).map(r => r.id);
                const toDelete = GSTATE.originalRoomIds.filter(id => !currentRoomIds.includes(id));
                if (toDelete.length > 0) await supabaseClient.from('rooms').delete().in('id', toDelete);

                for (const pr of processedRooms) {
                    const rData = { property_id: pId, name: pr.name, beds: parseInt(pr.beds), images: pr.finalImages };
                    if (pr.isNew) await supabaseClient.from('rooms').insert([rData]);
                    else await supabaseClient.from('rooms').update(rData).eq('id', pr.id);
                }

                await Swal.fire({ title: 'áƒ¬áƒáƒ áƒ›áƒáƒ¢áƒ”áƒ‘áƒ!', text: 'áƒ›áƒáƒœáƒáƒªáƒ”áƒ›áƒ”áƒ‘áƒ˜ áƒ¨áƒ”áƒœáƒáƒ®áƒ£áƒšáƒ˜áƒ', icon: 'success', timer: 1500, showConfirmButton: false });
                window.location.href = 'index.html';

            } catch (err) {
                console.error(err);
                Swal.fire('áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ', err.message, 'error');
                btn.innerHTML = origText;
                btn.disabled = false;
            }
        };

        window.onload = () => window.checkAuth();
    </script>
</body>

</html>
</script>
</body>

</html>