<!DOCTYPE html>
<html lang="ka">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>განცხადების დამატება - GeorgiaTravel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Georgian:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Noto Sans Georgian', sans-serif;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Force image opacity to 1 immediately for testing if anim fails */
        .animate-fade-in {
            opacity: 1 !important;
        }

        /* Dropdown z-index fix */
        .dropdown-container {
            position: relative;
            z-index: 50;
        }

        #citiesDropdown {
            z-index: 9999 !important;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen pb-20">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-3xl mx-auto px-4 h-16 flex justify-between items-center">
            <a href="index.html" class="flex items-center space-x-2">
                <img src="images/gh_logo.webp" alt="GeorgiaTravel"
                    class="h-10 max-h-[40px] w-auto drop-shadow-md object-contain">
            </a>
            <a href="profile.html"
                class="text-sm font-medium text-gray-500 hover:text-amber-600 transition-colors flex items-center">
                <svg class="w-5 h-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                უკან
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-3xl mx-auto px-4 py-8">

        <div class="bg-white rounded-3xl shadow-xl border border-gray-100 relative z-0">
            <!-- Removed overflow-hidden to allow dropdowns to spill out if needed, but relative z-0 to establish context -->
            <!-- Header -->
            <div class="px-8 py-6 border-b border-gray-100 bg-gray-50/50 rounded-t-3xl">
                <h1 class="text-2xl font-bold text-gray-900 flex items-center">
                    <span
                        class="w-10 h-10 rounded-full bg-amber-100 flex items-center justify-center mr-3 text-amber-600 shadow-sm">
                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                    </span>
                    ახალი განცხადება
                </h1>
                <p class="text-gray-500 text-sm mt-2 ml-14">შეავსეთ ინფორმაცია თქვენი ობიექტის შესახებ</p>
            </div>

            <!-- Form -->
            <div class="p-8">
                <form id="addPropertyForm" onsubmit="submitProperty(event)" class="space-y-8">

                    <!-- Images Section -->
                    <div class="space-y-4">
                        <label class="block text-sm font-bold text-gray-900">
                            სურათები <span class="text-gray-400 font-normal ml-1">(მაქს. 30)</span>
                        </label>

                        <div id="uploadGrid" class="grid grid-cols-3 sm:grid-cols-4 gap-4">
                            <!-- Helper / Add Button -->
                            <div class="relative aspect-square rounded-xl border-2 border-dashed border-gray-300 hover:border-amber-500 hover:bg-amber-50 transition-all group flex flex-col items-center justify-center cursor-pointer overflow-hidden"
                                id="uploadAddBtn" onclick="document.getElementById('fileInput').click()">
                                <input type="file" id="fileInput" multiple accept="image/png, image/jpeg, image/webp"
                                    class="hidden" onchange="handleImageSelection(this)">
                                <div
                                    class="w-10 h-10 rounded-full bg-gray-100 group-hover:bg-amber-100 text-gray-400 group-hover:text-amber-500 flex items-center justify-center mb-2 transition-colors">
                                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 4v16m8-8H4" />
                                    </svg>
                                </div>
                                <span
                                    class="text-[10px] font-bold text-gray-400 group-hover:text-amber-600 uppercase tracking-wide">
                                    დამატება
                                </span>
                            </div>
                            <!-- Previews injected here -->
                        </div>
                    </div>

                    <div class="border-t border-gray-100 my-6"></div>

                    <!-- Basic Info -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="group">
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">სათაური /
                                სახელი</label>
                            <input type="text" name="name" required placeholder="მაგ: მყუდრო კოტეჯი ბაკურიანში"
                                class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:border-amber-500 focus:ring-4 focus:ring-amber-500/10 outline-none transition-all placeholder-gray-400 font-medium text-gray-800">
                        </div>

                        <div class="group dropdown-container relative" id="locationContainer">
                            <label
                                class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">ლოკაცია</label>
                            <div class="relative">
                                <input type="text" id="locationSearch" placeholder="აირჩიეთ ქალაქი..."
                                    class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:border-amber-500 focus:ring-4 focus:ring-amber-500/10 outline-none transition-all font-medium text-gray-800 cursor-pointer"
                                    autocomplete="off">
                                <input type="hidden" name="location" id="locationValue" required>
                                <svg class="w-5 h-5 text-gray-400 absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none"
                                    fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7" />
                                </svg>

                                <!-- Cities Dropdown -->
                                <ul id="citiesDropdown"
                                    class="absolute top-full left-0 right-0 mt-2 bg-white border border-gray-100 rounded-xl shadow-xl max-h-60 overflow-y-auto hidden z-[100] divide-y divide-gray-50 custom-scrollbar">
                                    <!-- Populated via JS -->
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="group">
                            <label
                                class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">საკონტაქტო
                                ნომერი</label>
                            <input type="tel" name="phone" required placeholder="+995 5XX XX XX XX"
                                class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:border-amber-500 focus:ring-4 focus:ring-amber-500/10 outline-none transition-all font-medium text-gray-800">
                        </div>
                        <div class="group dropdown-container relative">
                            <label
                                class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">ტიპი</label>
                            <div class="relative">
                                <select name="type" required
                                    class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:border-amber-500 focus:ring-4 focus:ring-amber-500/10 outline-none transition-all appearance-none font-medium text-gray-800 cursor-pointer relative z-10">
                                    <!-- Options updated by user request -->
                                    <option value="hotel">სასტუმრო</option>
                                    <option value="Guest house">საოჯახო სასტუმრო</option>
                                    <option value="Apartment">ბინა</option>
                                    <option value="Cottage">კოტეჯი</option>
                                    <option value="Private house">კერძო სახლი</option>
                                </select>
                                <svg class="w-5 h-5 text-gray-400 absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none z-20"
                                    fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7" />
                                </svg>
                            </div>
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="group">
                        <label
                            class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">აღწერა</label>
                        <textarea name="description" rows="4" required placeholder="აღწერეთ თქვენი ობიექტი დეტალურად..."
                            class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:border-amber-500 focus:ring-4 focus:ring-amber-500/10 outline-none transition-all resize-none font-medium text-gray-800 custom-scrollbar"></textarea>
                    </div>

                    <!-- Price & Tier -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="group">
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">ფასი
                                (გამოჩნდება ავტომატურად როცა შეავსებთ სეზონური ფასების ცხრილს)</label>
                            <div class="relative">
                                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold">₾</span>
                                <input type="text" name="price" required readonly placeholder="-"
                                    class="w-full pl-8 pr-4 py-3 bg-gray-100 border border-gray-200 rounded-xl focus:bg-gray-100 outline-none font-bold text-gray-700 cursor-not-allowed">
                            </div>
                            <p class="text-[10px] text-gray-500 mt-1 ml-1">ფასი გამოითვლება ავტომატურად სეზონური ცხრილის
                                მიხედვით მიმდინარე თვისთვის.</p>
                        </div>
                        <div class="group dropdown-container relative">
                            <label
                                class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">პაკეტი</label>
                            <div class="relative">
                                <select name="tier" id="addTier"
                                    class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white focus:border-amber-500 focus:ring-4 focus:ring-amber-500/10 outline-none transition-all appearance-none font-medium text-gray-800 cursor-pointer relative z-10">
                                    <option value="free">Free (უფასო)</option>
                                    <option value="regular">Regular (20₾/თვე)</option>
                                    <option value="vip">VIP (30₾/თვე)</option>
                                    <option value="vip-plus">VIP + (33₾/თვე)</option>
                                    <option value="super-vip">Super VIP (60₾/თვე)</option>
                                </select>
                                <svg class="w-5 h-5 text-gray-400 absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none z-20"
                                    fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7" />
                                </svg>
                            </div>
                        </div>
                    </div>

                    <!-- Amenities -->
                    <div class="space-y-4">
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">კომფორტი /
                            სერვისები</label>
                        <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                            <label
                                class="flex items-center space-x-3 p-3 border border-gray-100 rounded-xl cursor-pointer hover:bg-gray-50 hover:border-amber-300 transition-all select-none group">
                                <input type="checkbox" name="amenities" value="WiFi"
                                    class="w-5 h-5 text-amber-500 border-gray-300 rounded focus:ring-amber-500/20">
                                <span class="text-sm font-medium text-gray-700 group-hover:text-amber-700">WiFi</span>
                            </label>
                            <label
                                class="flex items-center space-x-3 p-3 border border-gray-100 rounded-xl cursor-pointer hover:bg-gray-50 hover:border-amber-300 transition-all select-none group">
                                <input type="checkbox" name="amenities" value="პარკინგი"
                                    class="w-5 h-5 text-amber-500 border-gray-300 rounded focus:ring-amber-500/20">
                                <span
                                    class="text-sm font-medium text-gray-700 group-hover:text-amber-700">პარკინგი</span>
                            </label>
                            <label
                                class="flex items-center space-x-3 p-3 border border-gray-100 rounded-xl cursor-pointer hover:bg-gray-50 hover:border-amber-300 transition-all select-none group">
                                <input type="checkbox" name="amenities" value="აუზი"
                                    class="w-5 h-5 text-amber-500 border-gray-300 rounded focus:ring-amber-500/20">
                                <span class="text-sm font-medium text-gray-700 group-hover:text-amber-700">აუზი</span>
                            </label>
                            <label
                                class="flex items-center space-x-3 p-3 border border-gray-100 rounded-xl cursor-pointer hover:bg-gray-50 hover:border-amber-300 transition-all select-none group">
                                <input type="checkbox" name="amenities" value="საუზმე"
                                    class="w-5 h-5 text-amber-500 border-gray-300 rounded focus:ring-amber-500/20">
                                <span class="text-sm font-medium text-gray-700 group-hover:text-amber-700">საუზმე</span>
                            </label>
                            <label
                                class="flex items-center space-x-3 p-3 border border-gray-100 rounded-xl cursor-pointer hover:bg-gray-50 hover:border-amber-300 transition-all select-none group">
                                <input type="checkbox" name="amenities" value="ბუხარი"
                                    class="w-5 h-5 text-amber-500 border-gray-300 rounded focus:ring-amber-500/20">
                                <span class="text-sm font-medium text-gray-700 group-hover:text-amber-700">ბუხარი</span>
                            </label>
                            <label
                                class="flex items-center space-x-3 p-3 border border-gray-100 rounded-xl cursor-pointer hover:bg-gray-50 hover:border-amber-300 transition-all select-none group">
                                <input type="checkbox" name="amenities" value="ხედი"
                                    class="w-5 h-5 text-amber-500 border-gray-300 rounded focus:ring-amber-500/20">
                                <span class="text-sm font-medium text-gray-700 group-hover:text-amber-700">ხედი</span>
                            </label>
                        </div>
                    </div>

                    <!-- Seasonal Prices -->
                    <div class="space-y-4 pt-4 border-t border-gray-100">
                        <div class="flex justify-between items-center">
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider">სეზონური
                                ფასები
                                (არასავალდებულო)</label>
                            <button type="button" onclick="addSeasonalRow()"
                                class="text-xs font-bold text-amber-600 hover:text-amber-700 flex items-center bg-amber-50 px-3 py-1.5 rounded-lg hover:bg-amber-100 transition-colors">
                                <svg class="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 4v16m8-8H4" />
                                </svg>
                                ოთახის დამატება
                            </button>
                        </div>
                        <div class="overflow-x-auto border border-gray-200 rounded-xl bg-white shadow-sm">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-50 text-gray-500 font-medium text-xs uppercase">
                                    <tr>
                                        <th
                                            class="p-2 min-w-[120px] sticky left-0 bg-gray-50 z-10 border-r border-gray-100">
                                            ტიპი</th>
                                        <th class="p-1 min-w-[30px] text-center border-r border-gray-100"
                                            title="Apply Jan to all">⚡</th>
                                        <th class="p-2 min-w-[60px]">იან</th>
                                        <th class="p-2 min-w-[60px]">თებ</th>
                                        <th class="p-2 min-w-[60px]">მარ</th>
                                        <th class="p-2 min-w-[60px]">აპრ</th>
                                        <th class="p-2 min-w-[60px]">მაი</th>
                                        <th class="p-2 min-w-[60px]">ივნ</th>
                                        <th class="p-2 min-w-[60px]">ივლ</th>
                                        <th class="p-2 min-w-[60px]">აგვ</th>
                                        <th class="p-2 min-w-[60px]">სექ</th>
                                        <th class="p-2 min-w-[60px]">ოქტ</th>
                                        <th class="p-2 min-w-[60px]">ნოე</th>
                                        <th class="p-2 min-w-[60px]">დეკ</th>
                                        <th class="p-2 min-w-[40px]"></th>
                                    </tr>
                                </thead>
                                <tbody id="seasonalPricesBody" class="divide-y divide-gray-100">
                                    <!-- Rows added by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="pt-6 border-t border-gray-100 flex items-center justify-between">
                        <a href="profile.html"
                            class="px-6 py-3 text-gray-500 font-bold hover:text-gray-800 transition-colors">გაუქმება</a>
                        <button type="submit"
                            class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-4 px-10 rounded-xl shadow-lg shadow-amber-200 transition-all transform active:scale-[0.98] flex items-center justify-center text-lg">
                            განცხადების გამოქვეყნება
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <script>
        const CONFIG = {
            SUPABASE_URL: 'https://akmbyvovhubccznrzotv.supabase.co',
            SUPABASE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFrbWJ5dm92aHViY2N6bnJ6b3R2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3NTgwMTAsImV4cCI6MjA4MjMzNDAxMH0.oHLvbx5_4hYATF-hQkJvp0oxZ6ljUfGKYP-Mf7_CVtM'
        };

        const supabaseClient = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);

        // Define State
        const State = {
            supabase: supabaseClient,
            pendingUploads: [],
            user: null,
            cities: []
        };

        // DOM Elements
        const DOM = {
            fileInput: document.getElementById('fileInput'),
            locationSearch: document.getElementById('locationSearch'),
            locationValue: document.getElementById('locationValue'),
            citiesDropdown: document.getElementById('citiesDropdown'),
            locationContainer: document.getElementById('locationContainer')
        };

        async function init() {
            // Check Session
            const { data: { session } } = await supabase.auth.getSession();

            if (!session) {
                window.location.href = 'index.html'; // Redirect to login
                return;
            }

            State.user = session.user;

            // Load Cities
            fetchCities();
        }

        // --- CITIES SEARCH ---
        // --- CITIES SEARCH ---
        async function fetchCities() {
            try {
                const response = await fetch('georgian_cities.json');
                if (!response.ok) throw new Error("JSON fetch failed");
                const data = await response.json();
                State.cities = data.cities || data; // Handle {cities: [...]} or [...]
            } catch (error) {
                console.warn("Cities fetch failed, using fallback:", error);
                // Fallback List
                State.cities = [
                    { name_ka: "თბილისი", name_en: "Tbilisi" },
                    { name_ka: "ბათუმი", name_en: "Batumi" },
                    { name_ka: "ქუთაისი", name_en: "Kutaisi" },
                    { name_ka: "რუსთავი", name_en: "Rustavi" },
                    { name_ka: "გორი", name_en: "Gori" },
                    { name_ka: "ზუგდიდი", name_en: "Zugdidi" },
                    { name_ka: "ფოთი", name_en: "Poti" },
                    { name_ka: "ქობულეთი", name_en: "Kobuleti" },
                    { name_ka: "ბორჯომი", name_en: "Borjomi" },
                    { name_ka: "თელავი", name_en: "Telavi" }
                ];
            }
            setupCityListeners();
        }

        function setupCityListeners() {
            const showAllCities = (e) => {
                e.stopPropagation();
                DOM.citiesDropdown.classList.remove('hidden');
                DOM.citiesDropdown.style.display = 'block';
                DOM.locationContainer.style.zIndex = '100'; // Critical Fix: Bring container to front
                renderCitiesDropdown(State.cities);
            };

            // Open on Click AND Focus
            DOM.locationSearch.addEventListener('click', showAllCities);
            DOM.locationSearch.addEventListener('focus', showAllCities);

            // Filter on Input
            DOM.locationSearch.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                DOM.locationContainer.style.zIndex = '100'; // Ensure front on typing

                if (!term) {
                    renderCitiesDropdown(State.cities);
                } else {
                    const filtered = State.cities.filter(c =>
                        c.name_ka.toLowerCase().includes(term) ||
                        c.name_en.toLowerCase().includes(term)
                    );
                    renderCitiesDropdown(filtered);
                }
                DOM.citiesDropdown.classList.remove('hidden');
                DOM.citiesDropdown.style.display = 'block';
            });

            // Close on Click Outside
            document.addEventListener('click', (e) => {
                if (!DOM.locationContainer.contains(e.target)) {
                    DOM.citiesDropdown.classList.add('hidden');
                    DOM.citiesDropdown.style.display = 'none';
                    DOM.locationContainer.style.zIndex = ''; // Reset z-index
                }
            });
        }

        function renderCitiesDropdown(cities) {
            DOM.citiesDropdown.innerHTML = '';
            // Ensure no lingering hidden/display:none on the UL itself if previously set? 
            // The listener sets it, but good to ensure logic here doesn't hide it.

            if (cities.length === 0) {
                const li = document.createElement('li');
                li.className = "px-4 py-3 text-sm text-gray-400 text-center";
                li.textContent = "ქალაქი არ მოიძებნა";
                DOM.citiesDropdown.appendChild(li);
                return;
            }

            cities.forEach(city => {
                const li = document.createElement('li');
                li.className = "px-4 py-3 text-sm text-gray-700 hover:bg-amber-50 hover:text-amber-700 cursor-pointer transition-colors border-b border-gray-50 last:border-0";
                li.textContent = city.name_ka; // Show Georgian Name
                li.onclick = (e) => {
                    e.stopPropagation(); // Prevent document click from firing immediately
                    selectCity(city);
                };
                DOM.citiesDropdown.appendChild(li);
            });
        }

        function selectCity(city) {
            DOM.locationSearch.value = city.name_ka;
            DOM.locationValue.value = city.name_ka;
            DOM.citiesDropdown.classList.add('hidden');
            DOM.citiesDropdown.style.display = 'none';
            DOM.locationContainer.style.zIndex = ''; // Reset z-index
        }

        // --- IMAGE PROCESSING & GRID ---
        window.handleImageSelection = async function (input) {
            const files = Array.from(input.files);
            if (!files.length) return;

            // Process each file
            for (const file of files) {
                if (State.pendingUploads.length >= 30) {
                    alert("მაქსიმუმ 30 სურათი!");
                    break;
                }

                try {
                    const processed = await processImage(file);
                    State.pendingUploads.push(processed);
                } catch (error) {
                    console.error("Image processing failed:", error);
                    alert(`სურათი ${file.name} ვერ აიტვირთა: ${error.message}`);
                }
            }

            input.value = ''; // Reset
            renderUploadGrid();
        };

        function renderUploadGrid() {
            const grid = document.getElementById('uploadGrid');
            const addButton = document.getElementById('uploadAddBtn');
            if (!grid || !addButton) return;

            // Remove all existing previews but KEEP the add button
            // Strategy: Convert button to string, clear innerHTML, restore button?
            // Better: Select previews and remove them.
            Array.from(grid.children).forEach(child => {
                if (child.id !== 'uploadAddBtn') {
                    child.remove();
                }
            });

            // Insert new previews BEFORE button
            State.pendingUploads.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = "relative aspect-square rounded-xl overflow-hidden shadow-sm border border-gray-200 group animate-fade-in bg-white";

                const img = document.createElement('img');
                img.src = URL.createObjectURL(item.blob);
                img.className = "w-full h-full object-cover";

                const delBtn = document.createElement('button');
                delBtn.className = "absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 shadow-md opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600 focus:outline-none z-10";
                delBtn.innerHTML = `<svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>`;
                delBtn.type = "button";
                delBtn.onclick = (e) => { e.stopPropagation(); removeImage(index); };

                // Size Badge
                const sizeBadge = document.createElement('div');
                sizeBadge.className = "absolute bottom-1 left-1 bg-black/50 backdrop-blur-sm text-white text-[10px] px-1.5 py-0.5 rounded opacity-0 group-hover:opacity-100 transition-opacity";
                sizeBadge.textContent = `${(item.blob.size / 1024).toFixed(0)}KB`;

                div.appendChild(img);
                div.appendChild(delBtn);
                div.appendChild(sizeBadge);

                grid.insertBefore(div, addButton);
            });

            // Toggle Add Button
            if (State.pendingUploads.length >= 30) {
                addButton.classList.add('hidden');
            } else {
                addButton.classList.remove('hidden');
            }
        }

        window.removeImage = function (index) {
            State.pendingUploads.splice(index, 1);
            renderUploadGrid();
        };

        function processImage(file) {
            return new Promise((resolve, reject) => {
                const MAX_WIDTH = 1920;
                const MAX_SIZE_MB = 5;
                const ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/webp'];

                if (!ALLOWED_TYPES.includes(file.type)) { reject(new Error("მხოლოდ JPG, PNG, WEBP")); return; }

                const img = new Image();
                img.src = URL.createObjectURL(file);
                img.onload = () => {
                    URL.revokeObjectURL(img.src);
                    let width = img.width;
                    let height = img.height;

                    if (width > MAX_WIDTH) {
                        height = Math.round(height * (MAX_WIDTH / width));
                        width = MAX_WIDTH;
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    canvas.toBlob((blob) => {
                        if (!blob) { reject(new Error("კონვერტაცია ვერ მოხერხდა")); return; }
                        //  if (blob.size > MAX_SIZE_MB * 1024 * 1024) ... // Compress more?

                        const newFile = new File([blob], file.name.replace(/\.[^/.]+$/, "") + ".webp", { type: "image/webp", lastModified: Date.now() });
                        resolve({ blob: newFile, original: file });
                    }, 'image/webp', 0.8);
                };
                img.onerror = () => reject(new Error("ჩატვირთვის შეცდომა"));
            });
        }

        // --- SEASONAL ---
        window.addSeasonalRow = function () {
            const tbody = document.getElementById('seasonalPricesBody');
            if (!tbody) return;
            const rowId = 'sp-row-' + Date.now();
            const tr = document.createElement('tr');
            tr.className = "hover:bg-gray-50 transition-colors group";
            tr.id = rowId;

            tr.innerHTML = `
                <td class="p-2 sticky left-0 bg-white group-hover:bg-gray-50 border-r border-gray-100 z-10">
                    <input type="text" placeholder="მაგ: 2 ადგილიანი" class="w-full px-2 py-1.5 text-xs border border-gray-200 rounded focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 outline-none">
                </td>
                <td class="p-1 text-center bg-white group-hover:bg-gray-50 border-r border-gray-100 z-10">
                    <button type="button" onclick="fillSeasonalRow(this)" class="p-1 text-emerald-500 hover:bg-emerald-50 rounded transition-colors" title="იანვრის ფასის ყველგან გავრცელება">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" /></svg>
                    </button>
                </td>
                ${Array(12).fill(0).map(() => `
                    <td class="p-1"><input type="number" min="0" class="w-full px-1 py-1.5 text-xs text-center border border-gray-200 rounded focus:border-emerald-500 outline-none" placeholder="-"></td>
                `).join('')}
                <td class="p-2 text-center">
                    <button type="button" onclick="document.getElementById('${rowId}').remove(); calculatePriceRange();" class="text-gray-300 hover:text-red-500 transition-colors">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
            calculatePriceRange();
        };

        window.fillSeasonalRow = function (btn) {
            const tr = btn.closest('tr');
            const inputs = tr.querySelectorAll('input[type="number"]');
            if (inputs.length === 0) return;

            const firstVal = inputs[0].value;
            if (!firstVal) {
                alert("ჯერ მიუთითეთ იანვრის ფასი");
                return;
            }

            inputs.forEach(input => input.value = firstVal);
            calculatePriceRange(); // Recalc
        };

        // --- PRICE CALCULATION LOGIC ---
        window.calculatePriceRange = function () {
            const currentMonth = new Date().getMonth(); // 0 = Jan
            let min = Infinity;
            let max = -Infinity;
            const rows = document.querySelectorAll('#seasonalPricesBody tr');

            rows.forEach(row => {
                const inputs = row.querySelectorAll('input[type="number"]');
                // Format: Jan, Feb, Mar...
                // inputs[0] is Jan, inputs[11] is Dec
                if (inputs[currentMonth]) {
                    const val = parseInt(inputs[currentMonth].value) || 0;
                    if (val > 0) {
                        if (val < min) min = val;
                        if (val > max) max = val;
                    }
                }
            });

            const priceInput = document.querySelector('input[name="price"]');
            if (min !== Infinity) {
                if (min === max) {
                    priceInput.value = min;
                } else {
                    priceInput.value = `${min} - ${max}`;
                }
            } else {
                priceInput.value = '';
            }
        };

        // Attach global listener for seasonal inputs for realtime updates
        document.addEventListener('input', (e) => {
            if (e.target.closest('#seasonalPricesBody') && e.target.type === 'number') {
                calculatePriceRange();
            }
        });

        // --- SUBMIT ---
        window.submitProperty = async function (e) {
            e.preventDefault();

            // Re-validate Auth
            if (!State.user) {
                alert("გთხოვთ გაიაროთ ავტორიზაცია");
                window.location.href = 'index.html';
                return;
            }

            if (State.pendingUploads.length === 0) { alert("გთხოვთ ატვირთოთ მინიმუმ 1 სურათი"); return; }
            if (!DOM.locationValue.value) { alert("გთხოვთ აირჩიოთ ქალაქი სიიდან"); return; }

            const btn = e.target.querySelector('button[type="submit"]');
            const origText = btn.innerHTML;
            btn.innerHTML = `<svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> იტვირთება...`;
            btn.disabled = true;

            try {
                // 1. Upload Images
                const userId = State.user.id;
                const uploadedUrls = [];
                for (let i = 0; i < State.pendingUploads.length; i++) {
                    const item = State.pendingUploads[i];
                    const uniqueId = Math.random().toString(36).substring(2, 9);
                    const fileName = `${Date.now()}_${uniqueId}.webp`;

                    const { data, error } = await State.supabase.storage
                        .from('guesthouse statement')
                        .upload(fileName, item.blob, { contentType: 'image/webp' });

                    if (error) throw error;

                    const publicUrl = State.supabase.storage.from('guesthouse statement').getPublicUrl(fileName).data.publicUrl;
                    uploadedUrls.push(publicUrl);
                }

                // 2. Form Data
                const formData = new FormData(e.target);
                const amenities = Array.from(formData.getAll('amenities'));

                // Seasonal Prices
                const seasonal_prices = [];
                const sRows = document.querySelectorAll('#seasonalPricesBody tr');
                sRows.forEach(row => {
                    const label = row.querySelector('input[type="text"]').value;
                    const prices = Array.from(row.querySelectorAll('input[type="number"]')).map(inp => parseInt(inp.value) || 0);
                    if (label) seasonal_prices.push({ label, prices });
                });

                const priceValue = formData.get('price');
                let parsedPrice = 0;
                if (priceValue) {
                    const priceParts = priceValue.split(' - ');
                    parsedPrice = parseInt(priceParts[0]) || 0; // Take the min value if it's a range
                }

                const newProp = {
                    user_id: userId,
                    name: formData.get('name'),
                    location: DOM.locationValue.value,
                    price: parsedPrice,
                    type: formData.get('type'),
                    tier: formData.get('tier'),
                    description: formData.get('description'),
                    amenities: amenities,
                    images: uploadedUrls,
                    phone: formData.get('phone'),
                    seasonal_prices: seasonal_prices,
                    rating: 5.0,
                    reviews: 0,
                    created_at: new Date().toISOString()
                };

                const { error: insertError } = await State.supabase.from('guesthouse ge').insert([newProp]);
                if (insertError) throw insertError;

                // Success
                alert("განცხადება წარმატებით დაემატა!");
                window.location.href = 'profile.html';

            } catch (err) {
                console.error(err);
                alert("შეცდომა: " + err.message);
                btn.innerHTML = origText;
                btn.disabled = false;
            }
        };

        init();

    </script>
</body>

</html>