<!DOCTYPE html>
<html lang="ka">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>·Éì·Éî·É¢·Éê·Éö·Éî·Éë·Éò | GuesthouseGE</title>
    <link rel="icon" type="image/webp" href="images/gh_logo.webp">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Georgian:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
        body {
            font-family: 'Noto Sans Georgian', sans-serif;
        }

        .hero-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 8px;
            height: 450px;
        }

        @media (max-width: 768px) {
            .hero-grid {
                display: block;
                height: auto;
            }

            .hero-grid img {
                height: 250px;
                width: 100%;
                border-radius: 0;
            }
        }

        .vip-badge {
            background: linear-gradient(135deg, #ffd700, #ffae00);
            color: #000;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }

        .super-vip-badge {
            background: linear-gradient(135deg, #00d2ff, #3a7bd5);
            color: #fff;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 210, 255, 0.5);
        }

        .super-vip-badge::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transform: rotate(45deg);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% {
                left: -100%;
            }

            100% {
                left: 100%;
            }
        }

        .current-month-highlight {
            background-color: #f0fdf4;
            border: 2px solid #22c55e;
            color: #15803d;
            font-weight: 700;
        }

        .custom-scrollbar::-webkit-scrollbar {
            height: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #ddd;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #ccc;
        }

        /* Navbar Animations */
        @keyframes flagWave {
            0% {
                transform: rotate(0deg);
            }

            20% {
                transform: rotate(-5deg);
            }

            40% {
                transform: rotate(5deg);
            }

            60% {
                transform: rotate(-3deg);
            }

            80% {
                transform: rotate(3deg);
            }

            100% {
                transform: rotate(0deg);
            }
        }

        .animate-flag {
            animation: flagWave 2s infinite ease-in-out;
            transform-origin: top center;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in-down {
            animation: fadeInDown 0.3s ease-out forwards;
        }

        /* Calendar Styles */
        /* Calendar Styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            cursor: pointer;
            border-radius: 8px;
            /* Start softer */
            /* Critical: Animate background and transform */
            transition: background-color 0.25s cubic-bezier(0.4, 0, 0.2, 1), color 0.25s ease, transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
            overflow: hidden;
            transform: scale(1);
        }

        .calendar-day:hover:not(.booked):not(.selected):not(.in-range) {
            background-color: #ecfdf5;
            /* Emerald-50 */
            transform: scale(1.05);
            z-index: 2;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .calendar-day.booked {
            background-color: #ef4444 !important;
            color: white !important;
            font-weight: 600;
            cursor: not-allowed;
            opacity: 0.8;
        }

        /* Animated Endpoints */
        .calendar-day.selected.range-start,
        .calendar-day.selected.range-end {
            background-color: #10b981 !important;
            /* Emerald-500 */
            color: white !important;
            font-weight: 700;
            border-radius: 50% !important;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            transform: scale(1.1);
            z-index: 5;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* Fallback for just 'selected' if logic hasn't updated yet */
        .calendar-day.selected {
            background-color: #10b981 !important;
            color: white !important;
        }

        /* Smooth Range Connecting */
        .calendar-day.in-range {
            background-color: #d1fae5 !important;
            /* Emerald-100 */
            color: #065f46;
            border-radius: 0 !important;
            /* Connect visually */
            margin: 0 -1px;
            width: calc(100% + 2px);
            z-index: 1;
            transform: scale(1.02);
        }

        .calendar-day.other-month {
            color: #d1d5db;
            pointer-events: none;
        }

        .calendar-day.today {
            border: 2px solid #f97316 !important;
            color: #f97316 !important;
            font-weight: 700;
        }

        /* ----- 1. Clean Up Visual Artifacts ----- */
        .flatpickr-calendar {
            overflow: hidden !important;
            /* Clip corner bleeds */
        }

        .flatpickr-innerContainer {
            overflow: hidden !important;
        }

        .flatpickr-days {
            border-left: 1px solid rgba(0, 0, 0, 0.05);
            /* Subtle grid definition */
        }

        /* Ensure scoped styling for days to prevent ghosting */
        .flatpickr-innerContainer .flatpickr-day {
            margin: 4px !important;
            max-width: 38px !important;
            /* Strict sizing */
        }

        /* ----- 3. Seasonal Animation ----- */
        @keyframes springIn {
            0% {
                transform: scale(0.3) translateY(10px);
                opacity: 0;
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        .season-icon {
            display: inline-block;
            animation: springIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* Custom Counter Styling */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* ReactBits Counter Animation */
        @keyframes countSlideUp {
            0% {
                transform: translateY(100%);
                opacity: 0;
            }

            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes countSlideDown {
            0% {
                transform: translateY(-100%);
                opacity: 0;
            }

            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .animate-count-up {
            animation: countSlideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .animate-count-down {
            animation: countSlideDown 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* Seasonal Dropdown smooth entrance */
        .seasonal-dropdown-enter .flatpickr-monthDropdown-months {
            animation: slideDownFade 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        /* Ensure wrapper is wide enough */
        .calendar-wrapper {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 2rem;
            width: 100%;
        }

        @media (min-width: 1024px) {

            /* Desktop */
            .calendar-wrapper {
                flex-direction: row;
            }
        }


        /* Flatpickr Customization - Modern Glass Aesthetic */
        .flatpickr-calendar {
            backdrop-filter: blur(10px) !important;
            background: rgba(255, 255, 255, 0.95) !important;
            border: 1px solid rgba(0, 0, 0, 0.05) !important;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1) !important;
            border-radius: 24px !important;
            font-family: 'Noto Sans Georgian', sans-serif !important;
            padding: 16px !important;
            width: 100% !important;
            max-width: 450px !important;
            /* Wider Layout */
        }

        /* Hide default Flatpickr Month Header */
        .flatpickr-month {
            display: none !important;
        }

        .flatpickr-current-month {
            display: none !important;
        }

        /* Collapsible Month Selector */
        .month-selector-wrapper {
            position: relative;
            width: 100%;
            margin-bottom: 24px;
            z-index: 40;
        }

        .month-dropdown-btn {
            width: 100%;
            background: white;
            border: 2px solid #000;
            padding: 14px 20px;
            border-radius: 16px;
            font-weight: 700;
            color: #1f2937;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: none;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .month-dropdown-btn:hover {
            background-color: #f9fafb;
        }

        .month-dropdown-btn:active {
            transform: scale(0.99);
        }

        .month-dropdown-menu {
            position: absolute;
            top: 110%;
            left: 0;
            width: 100%;
            background: white;
            border: 2px solid #000;
            border-radius: 20px;
            padding: 16px;
            display: none;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .month-dropdown-menu.open {
            display: grid;
            opacity: 1;
            transform: translateY(0);
        }

        .month-dropdown-item {
            padding: 12px;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
            font-weight: 700;
            font-size: 0.85rem;
            color: #4b5563;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .month-dropdown-item:hover {
            transform: scale(1.05);
            background: white;
            border-color: #e5e7eb;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .month-dropdown-item.active {
            border-color: #10b981;
            background: #ecfdf5;
            color: #047857;
        }

        /* Seasonal Backgrounds for Items */
        .season-winter {
            background: linear-gradient(135deg, #eff6ff 0%, #f0f9ff 100%);
        }

        .season-spring {
            background: linear-gradient(135deg, #f0fdf4 0%, #fdf2f8 100%);
        }

        .season-summer {
            background: linear-gradient(135deg, #fefce8 0%, #fff7ed 100%);
        }

        .season-autumn {
            background: linear-gradient(135deg, #fff7ed 0%, #fef2f2 100%);
        }

        /* Booking Confirmation Modal (Receipt Style) */
        .booking-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .booking-modal-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }

        .booking-receipt-card {
            background: white;
            width: 100%;
            max-width: 420px;
            padding: 32px;
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transform: scale(0.95);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .booking-modal-overlay.open .booking-receipt-card {
            transform: scale(1);
        }

        .receipt-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 0.95rem;
            color: #4b5563;
        }

        .receipt-total {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px dashed #e5e7eb;
            display: flex;
            justify-content: space-between;
            font-weight: 900;
            font-size: 1.25rem;
            color: #111827;
        }

        /* Clean Flatpickr Overrides */
        .flatpickr-calendar {
            box-shadow: none !important;
            border: none !important;
            background: transparent !important;
            margin: 0 auto !important;
        }

        .calendar-wrapper {
            overflow: visible;
        }

        /* Seasonal Dropdown Animation */
        .seasonal-dropdown-enter {
            animation: slideDownFade 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        @keyframes slideDownFade {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.9);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .flatpickr-months {
            margin-bottom: 12px !important;
        }

        .flatpickr-day {
            border-radius: 12px !important;
            margin: 4px !important;
            height: 38px !important;
            width: 38px !important;
            line-height: 38px !important;
            border: 1px solid transparent !important;
            color: #374151 !important;
            font-weight: 600 !important;
            transition: all 0.2s ease !important;
        }

        .flatpickr-day:hover {
            background: #f3f4f6 !important;
            transform: translateY(-2px) !important;
        }

        /* Selected State - Vibrant Gradient & Glow */
        .flatpickr-day.selected,
        .flatpickr-day.startRange,
        .flatpickr-day.endRange,
        .flatpickr-day.selected.inRange,
        .flatpickr-day.startRange.inRange,
        .flatpickr-day.endRange.inRange {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%) !important;
            color: white !important;
            border: none !important;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.35) !important;
            transform: scale(1.05) !important;
            z-index: 10;
            font-weight: 700 !important;
        }

        /* Range Middle */
        .flatpickr-day.inRange {
            background: #ecfdf5 !important;
            /* Emerald-50 */
            color: #059669 !important;
            /* Emerald-600 */
            box-shadow: none !important;
            border-radius: 0 !important;
            /* Connect visually */
        }

        /* Booked/Disabled - Red Tint & Lock */
        .flatpickr-day.flatpickr-disabled,
        .flatpickr-day.flatpickr-disabled:hover {
            display: inline-block !important;
            opacity: 1 !important;
            background: #fee2e2 !important;
            /* Red-100 */
            color: #ef4444 !important;
            /* Red-500 */
            cursor: not-allowed !important;
            text-decoration: line-through;
            /* Strikethrough */
            border: 1px dashed #fca5a5 !important;
            /* Red-300 dashed */
        }

        /* Today Styling */
        .flatpickr-day.today {
            border: 2px solid #f97316 !important;
            color: #f97316 !important;
            background: transparent !important;
        }

        .flatpickr-day.today:hover {
            background: #fff7ed !important;
            /* Orange-50 */
            border-color: #f97316 !important;
        }

        /* ReactBits / Neo-Brutalist Aesthetic for Counter */
        .shadow-hard {
            box-shadow: 4px 4px 0px #000 !important;
        }

        /* ----- Fix for Ghost Cubes (Overflow) ----- */
        .flatpickr-calendar {
            overflow: hidden !important;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
        }

        .flatpickr-innerContainer {
            overflow: hidden !important;
            border-radius: 0 0 24px 24px !important;
        }

        .flatpickr-days {
            overflow: hidden !important;
        }

        /* ----- Scroll Stack UI ----- */
        .stack-wrapper {
            position: relative;
            width: 100%;
            margin-bottom: 24px;
            z-index: 50;
            /* Higher than calendar */
        }

        .stack-trigger {
            width: 100%;
            background: transparent;
            border: 2px solid #000;
            padding: 14px 20px;
            border-radius: 16px;
            font-weight: 800;
            color: #1f2937;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s ease;
        }

        .stack-trigger:hover {
            background: rgba(0, 0, 0, 0.03);
            border-color: #374151;
        }

        .stack-menu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            background: white;
            /* Stack bg */
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            transform-origin: top center;
            transform: scale(0.95);
        }

        .stack-menu.open {
            max-height: 400px;
            /* Adjust based on content */
            overflow-y: auto;
            opacity: 1;
            transform: scale(1);
            padding: 10px;
            border: 2px solid #000;
            /* Match styling */
        }

        /* Stack Items */
        .stack-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            margin-bottom: 4px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            transform: translateY(10px);
            opacity: 0;
            font-weight: 700;
            color: #4b5563;
        }

        .stack-menu.open .stack-item {
            transform: translateY(0);
            opacity: 1;
        }

        .stack-item:hover {
            background: #f3f4f6;
            transform: translateX(5px);
        }

        .stack-item.active {
            background: #ecfdf5;
            /* Emerald 50 */
            color: #047857;
            border: 1px solid #10b981;
        }

        /* Stack Scrollbar */
        .stack-menu::-webkit-scrollbar {
            width: 6px;
        }

        .stack-menu::-webkit-scrollbar-thumb {
            background-color: #e5e7eb;
            border-radius: 10px;
        }

        /* Calendar Header Refinements */
        .flatpickr-current-month {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            padding-top: 15px !important;
            padding-bottom: 10px !important;
            width: 100% !important;
            position: relative !important;
            /* Changed from absolute to flow better */
        }

        .flatpickr-monthDropdown-months {
            font-size: 1.4rem !important;
            font-weight: 800 !important;
            appearance: none !important;
            -webkit-appearance: none !important;
            background: transparent !important;
            border: none !important;
            padding: 0 5px !important;
            margin: 0 !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
        }

        /* Dropdown Animation */
        .flatpickr-monthDropdown-months:focus {
            outline: none;
            color: #10b981 !important;
            transform: scale(1.05);
        }

        .numInputWrapper {
            margin-left: 5px !important;
            font-size: 1.4rem !important;
            font-weight: 800 !important;
        }

        .numInputWrapper span {
            display: none !important;
        }

        /* Hide default up/down arrows on year */

        /* Prevent Arrow Overlap & Style */
        .flatpickr-prev-month,
        .flatpickr-next-month {
            z-index: 20 !important;
            top: 22px !important;
            padding: 0 !important;
            height: 30px !important;
            width: 30px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: 50% !important;
            background: rgba(255, 255, 255, 0.8) !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
            transition: all 0.2s ease !important;
        }

        .flatpickr-prev-month {
            left: 15px !important;
        }

        .flatpickr-next-month {
            right: 15px !important;
        }

        .flatpickr-prev-month:hover,
        .flatpickr-next-month:hover {
            background: #10b981 !important;
            color: white !important;
            transform: scale(1.1);
        }

        .flatpickr-prev-month svg,
        .flatpickr-next-month svg {
            width: 14px !important;
            height: 14px !important;
            fill: currentColor !important;
        }

        /* Custom checkout date sync style */
        .checkout-display {
            font-family: monospace;
            letter-spacing: 1px;
        }

        /* Helper for side-by-side counter if needed, currently stacked */
        .booking-counter-visible {
            display: block !important;
            animation: fadeInCounter 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes fadeInCounter {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .flatpickr-current-month .flatpickr-monthDropdown-months {
            font-weight: 800 !important;
            background: transparent !important;
        }

        .flatpickr-calendar.arrowTop:before,
        .flatpickr-calendar.arrowTop:after {
            display: none !important;
            /* Remove default arrows for cleaner look */
        }

        /* Navigation Arrows */
        .flatpickr-months .flatpickr-prev-month,
        .flatpickr-months .flatpickr-next-month {
            color: #374151 !important;
            /* Gray-700 */
            fill: #374151 !important;
        }

        .flatpickr-months .flatpickr-prev-month:hover,
        .flatpickr-months .flatpickr-next-month:hover {
            color: #111827 !important;
            /* Gray-900 */
        }

        @keyframes popIn {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .calendar-day.past-day {
            opacity: 0.3;
            filter: grayscale(100%);
            cursor: not-allowed !important;
            pointer-events: none;
        }
    </style>
</head>

<body class="bg-white">
    <div id="fb-root"></div>
    <script>
        window.fbAsyncInit = function () {
            FB.init({
                appId: '915840967780652',
                cookie: true,
                xfbml: true,
                version: 'v18.0'
            });
            FB.AppEvents.logPageView();
        };
        (function (d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) { return; }
            js = d.createElement(s); js.id = id;
            js.src = "https://connect.facebook.net/en_US/sdk.js";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));
    </script>

    <!-- Global Loader -->
    <div id="loadingSpinner"
        class="fixed inset-0 z-[100] bg-white flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="relative">
            <div class="w-16 h-16 border-4 border-emerald-100 border-t-emerald-500 rounded-full animate-spin"></div>
            <div class="absolute inset-0 flex items-center justify-center">
                <div class="w-8 h-8 bg-emerald-50 rounded-full"></div>
            </div>
        </div>
        <p class="mt-4 text-emerald-600 font-bold tracking-widest animate-pulse uppercase text-xs">·Éò·É¢·Éï·Éò·É†·Éó·Éî·Éë·Éê...</p>
    </div>

    <!-- Navbar -->
    <nav class="fixed top-0 left-0 w-full z-40 bg-white shadow-md py-3 transition-all duration-300" id="navbar">
        <div class="max-w-7xl mx-auto px-4 flex justify-between items-center">
            <img src="images/gh_logo.webp" alt="GeorgiaTravel" onclick="window.location.href='index.html'"
                class="h-10 max-h-[40px] w-auto drop-shadow-md object-contain cursor-pointer transition-transform hover:scale-105 active:scale-95">
            <div class="flex items-center space-x-3">
                <a href="pricing.html"
                    class="hidden md:flex items-center bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all animate-flag">
                    <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    ·É§·Éê·É°·Éî·Éë·Éò·É° ·Éú·Éê·ÉÆ·Éï·Éê
                </a>
                <button onclick="openAddModal()"
                    class="bg-amber-500 hover:bg-amber-600 text-white font-bold p-2.5 rounded-full transition-all shadow-md hover:shadow-lg flex items-center justify-center transform hover:-translate-y-0.5"
                    title="·Éì·Éê·Éõ·Éê·É¢·Éî·Éë·Éê">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                </button>
                <div id="navAuthBtnContainer">
                    <!-- Dynamic Auth Content -->
                </div>
            </div>
        </div>
    </nav>

    <div class="h-24"></div>

    <main class="max-w-7xl mx-auto px-4 pt-4 pb-32">
        <!-- Hero Section -->
        <div id="heroContainer" class="relative rounded-2xl overflow-hidden mb-8 shadow-xl bg-gray-100">
            <!-- Slider content will be injected by JS -->
            <div class="h-[500px] flex items-center justify-center">
                <div class="animate-spin h-8 w-8 border-4 border-amber-500 border-t-transparent rounded-full"></div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
            <!-- Left Info Panel -->
            <div class="lg:col-span-2 space-y-8">
                <div class="flex justify-between items-start">
                    <div>
                        <div id="tierBadge" class="mb-2"></div>
                        <h1 id="propName" class="text-3xl md:text-4xl font-bold text-gray-900 mb-2">...</h1>
                        <p id="propLocation" class="text-gray-500 flex items-center gap-1 font-medium italic">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path
                                    d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                <path d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            <span>...</span>
                        </p>
                    </div>
                </div>

                <div class="flex flex-wrap gap-4 py-6 border-y border-gray-100">
                    <div class="flex items-center gap-2 bg-gray-50 px-4 py-2 rounded-xl">
                        <span class="text-xl">üè†</span>
                        <div>
                            <p class="text-[10px] text-gray-400 font-bold uppercase">·É¢·Éò·Éû·Éò</p>
                            <p id="propType" class="text-sm font-bold text-gray-700">...</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 bg-gray-50 px-4 py-2 rounded-xl">
                        <span class="text-xl">üõèÔ∏è</span>
                        <div>
                            <p class="text-[10px] text-gray-400 font-bold uppercase">·É°·Éê·É¨·Éù·Éö·Éî·Éë·Éò</p>
                            <p id="totalBeds" class="text-sm font-bold text-gray-700">...</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 bg-gray-50 px-4 py-2 rounded-xl">
                        <span class="text-xl">üö™</span>
                        <div>
                            <p class="text-[10px] text-gray-400 font-bold uppercase">·Éù·Éó·Éê·ÉÆ·Éî·Éë·Éò</p>
                            <p id="roomCount" class="text-sm font-bold text-gray-700">...</p>
                        </div>
                    </div>
                </div>

                <div>
                    <!-- Room Tabs Section -->
                    <div id="roomTabsSection" class="mb-8 mt-2 hidden">
                        <section class="flex space-x-2 overflow-x-auto pb-4 custom-scrollbar" id="tabsContainer">
                            <!-- Tabs JS Generated -->
                        </section>
                        <div id="roomInfoDisplay"
                            class="hidden mt-3 bg-gray-50 border border-gray-100 rounded-2xl p-6 animate-fade-in space-y-3">
                            <div class="flex items-center gap-3">
                                <span class="text-indigo-600 bg-indigo-50 p-2 rounded-lg">üõèÔ∏è</span>
                                <div>
                                    <h4 id="displayRoomName" class="font-bold text-gray-900"></h4>
                                    <div class="flex gap-4 mt-1">
                                        <p id="displayRoomBeds"
                                            class="text-xs text-gray-500 font-medium uppercase tracking-wider"></p>
                                        <p id="displayRoomSq"
                                            class="text-xs text-indigo-600 font-bold uppercase tracking-wider"></p>
                                    </div>
                                </div>
                            </div>
                            <p id="displayRoomDesc"
                                class="text-sm text-gray-600 leading-relaxed italic border-t border-gray-100 pt-3 hidden">
                            </p>
                        </div>
                    </div>

                    <h2 class="text-xl font-bold text-gray-900 mb-4">·Éê·É¶·É¨·Éî·É†·Éê</h2>
                    <p id="propDescription" class="text-gray-600 leading-relaxed whitespace-pre-line text-lg">...</p>
                </div>

                <div id="amenitiesSection">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">·Éô·Éî·Éó·Éò·Éö·Éõ·Éù·É¨·Éß·Éù·Éë·Éê</h2>
                    <div id="amenitiesList" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
                </div>

                <div>
                    <h2 class="text-xl font-bold text-gray-900 mb-4">·É°·Éî·Éñ·Éù·Éú·É£·É†·Éò ·É§·Éê·É°·Éî·Éë·Éò</h2>
                    <div class="overflow-x-auto rounded-2xl border border-gray-100">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50">
                                <tr id="priceHeader">
                                    <th class="p-4 text-left text-gray-400 font-bold uppercase text-[10px]">·Éù·Éó·Éê·ÉÆ·Éò</th>
                                </tr>
                            </thead>
                            <tbody id="priceBody" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Right Sidebar -->
            <div class="space-y-6">
                <!-- Pricing Card -->
                <div class="bg-white border border-gray-100 rounded-3xl p-8 shadow-xl sticky top-24">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <p class="text-gray-400 text-sm font-bold uppercase mb-1">·É§·Éê·É°·Éò</p>
                            <h2 id="propPrice" class="text-3xl font-extrabold text-gray-900">...</h2>
                        </div>
                        <div class="bg-green-50 text-green-600 px-3 py-1 rounded-full text-xs font-bold">·ÉÆ·Éî·Éö·Éõ·Éò·É°·Éê·É¨·Éï·Éì·Éù·Éõ·Éò·Éê
                        </div>
                    </div>
                    <button id="bookBtn"
                        class="w-full bg-gray-900 hover:bg-black text-white py-4 rounded-2xl font-bold text-lg shadow-lg transition active:scale-95 mb-4">
                        ·Éì·Éê·ÉØ·Éê·Éï·É®·Éú·Éê
                    </button>
                    <p class="text-center text-xs text-gray-400 mb-6">·Éó·Éê·Éú·ÉÆ·Éò·É° ·Éí·Éê·Éì·Éê·ÉÆ·Éì·Éê ·ÉÆ·Éì·Éî·Éë·Éê ·Éõ·Éê·É°·Éû·Éò·Éú·É´·Éî·Éö·Éó·Éê·Éú</p>

                    <!-- Host Info Section -->
                    <div class="pt-6 border-t border-gray-100">
                        <p class="text-[10px] text-gray-400 font-bold uppercase mb-3 tracking-widest">·Éõ·Éê·É°·Éû·Éò·Éú·É´·Éî·Éö·Éò</p>
                        <div class="flex items-center gap-3">
                            <div
                                class="w-12 h-12 bg-emerald-100 rounded-full flex items-center justify-center text-emerald-600 font-bold text-xl shadow-inner">
                                <span id="hostAvatarChar">?</span>
                            </div>
                            <div class="overflow-hidden">
                                <h4 id="hostName" class="font-bold text-gray-900 truncate">...</h4>
                                <p id="hostPhone" class="text-xs text-emerald-600 font-bold">...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </main>

    <!-- Booking Modal -->
    <div id="bookingModal" class="fixed inset-0 z-[100] hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="fixed inset-0 bg-black/60 backdrop-blur-sm" onclick="closeBookingModal()"></div>

            <div class="relative bg-white w-full max-w-5xl rounded-3xl shadow-2xl overflow-hidden animate-fade-in-down">
                <!-- Header -->
                <div class="bg-gray-900 text-white px-8 py-6 flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold">·Éê·Éò·É†·É©·Éò·Éî·Éó ·Éù·Éó·Éê·ÉÆ·Éò ·Éì·Éê ·Éó·Éê·É†·Éò·É¶·Éî·Éë·Éò</h2>
                        <p class="text-gray-400 text-sm mt-1">·Éì·Éê·ÉØ·Éê·Éï·É®·Éú·Éî·Éó ·Éó·É•·Éï·Éî·Éú·Éò ·É°·Éê·É°·É£·É†·Éï·Éî·Éö·Éò ·Éù·Éó·Éê·ÉÆ·Éò ·É°·Éê·É°·É£·É†·Éï·Éî·Éö ·Éì·É†·Éù·É°</p>
                    </div>
                    <button onclick="closeBookingModal()" class="text-gray-400 hover:text-white transition-colors">
                        <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <!-- Content Area -->
                <div id="bookingRoomsList" class="p-8 space-y-8 max-h-[70vh] overflow-y-auto custom-scrollbar">
                    <!-- Rooms will be injected here -->
                    <div class="flex flex-col items-center justify-center py-20">
                        <div
                            class="animate-spin h-10 w-10 border-4 border-amber-500 border-t-transparent rounded-full mb-4">
                        </div>
                        <p class="text-gray-500 font-medium">·Éù·Éó·Éê·ÉÆ·Éî·Éë·Éò·É° ·É©·Éê·É¢·Éï·Éò·É†·Éó·Éï·Éê...</p>
                    </div>
                </div>

                <!-- Footer (Optional Informational) -->
                <div class="bg-gray-50 px-8 py-4 border-t border-gray-100 flex justify-between items-center">
                    <div class="flex items-center gap-4 text-sm">
                        <div class="flex items-center gap-1.5"><span
                                class="w-3 h-3 bg-white border border-gray-200 rounded-sm"></span> ·Éó·Éê·Éï·Éò·É°·É£·É§·Éê·Éö·Éò</div>
                        <div class="flex items-center gap-1.5"><span class="w-3 h-3 bg-red-500 rounded-sm"></span>
                            ·Éì·Éê·Éô·Éê·Éï·Éî·Éë·É£·Éö·Éò</div>
                        <div class="flex items-center gap-1.5"><span class="w-3 h-3 bg-green-500 rounded-sm"></span>
                            ·Éê·É†·É©·Éî·É£·Éö·Éò</div>
                    </div>
                    <p class="text-xs text-gray-400">* ·Éì·Éê·ÉØ·Éê·Éï·É®·Éú·Éò·É° ·É®·Éî·Éõ·Éì·Éî·Éí ·Éì·Éê·Éí·Éò·Éô·Éê·Éï·É®·Éò·É†·Éì·Éî·Éë·Éê·Éó ·Éõ·Éê·É°·Éû·Éò·Éú·É´·Éî·Éö·Éò</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://akmbyvovhubccznrzotv.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFrbWJ5dm92aHViY2N6bnJ6b3R2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3NTgwMTAsImV4cCI6MjA4MjMzNDAxMH0.oHLvbx5_4hYATF-hQkJvp0oxZ6ljUfGKYP-Mf7_CVtM';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const MONTHS = ["·Éò·Éê·Éú", "·Éó·Éî·Éë", "·Éõ·Éê·É†", "·Éê·Éû·É†", "·Éõ·Éê·Éò", "·Éò·Éï·Éú", "·Éò·Éï·Éö", "·Éê·Éí·Éï", "·É°·Éî·É•", "·Éù·É•·É¢", "·Éú·Éù·Éî", "·Éì·Éî·Éô"];
        const CUR_MONTH = new Date().getMonth();

        let GSTATE = {
            property: null,
            rooms: []
        };

        async function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            if (!id) { window.location.href = 'index.html'; return; }

            try {
                // Fetch Prop and Rooms in parallel (Outside of Auth)
                const [propRes, roomsRes] = await Promise.all([
                    supabaseClient.from('guesthouse_ge').select('*').eq('id', id).single(),
                    supabaseClient.from('rooms').select('*').eq('property_id', id)
                ]);

                if (propRes.error || !propRes.data) {
                    Swal.fire('·É®·Éî·É™·Éì·Éù·Éõ·Éê', '·Éí·Éê·Éú·É™·ÉÆ·Éê·Éì·Éî·Éë·Éê ·Éï·Éî·É† ·Éõ·Éù·Éò·É´·Éî·Éë·Éú·Éê', 'error');
                    return;
                }

                GSTATE.property = propRes.data;
                GSTATE.rooms = roomsRes.data || [];

                renderProperty(GSTATE.property);
                if (GSTATE.rooms.length > 0) {
                    initRoomTabs(GSTATE.property, GSTATE.rooms);
                }
                updateNavigation();

                // Auth listener
                supabaseClient.auth.onAuthStateChange((event, session) => {
                    updateNavigation();
                });
            } catch (err) {
                console.error("Initialization Error:", err);
                Swal.fire('·É®·Éî·É™·Éì·Éù·Éõ·Éê', '·Éõ·Éù·Éú·Éê·É™·Éî·Éõ·Éî·Éë·Éò·É° ·É©·Éê·É¢·Éï·Éò·É†·Éó·Éï·Éê ·Éï·Éî·É† ·Éõ·Éù·ÉÆ·Éî·É†·ÉÆ·Éì·Éê', 'error');
            } finally {
                // ALWAYS hide global loader
                setTimeout(() => {
                    const loader = document.getElementById('loadingSpinner');
                    if (loader) {
                        loader.classList.add('opacity-0');
                        setTimeout(() => loader.classList.add('hidden'), 500);
                    }
                }, 800);
            }
        }

        function renderProperty(p) {
            document.title = `${p.name} | GuesthouseGE`;
            document.getElementById('propName').innerText = p.name || '...';
            document.getElementById('propLocation').querySelector('span').innerText = p.location || '...';
            document.getElementById('propType').innerText = p.type || '...';
            document.getElementById('propDescription').innerText = p.description || '...';
            document.getElementById('propPrice').innerText = p.price_display || '...';

            // Host Info
            if (document.getElementById('hostName')) document.getElementById('hostName').innerText = p.host_name || '·Éõ·Éê·É°·Éû·Éò·Éú·É´·Éî·Éö·Éò';
            if (document.getElementById('hostPhone')) document.getElementById('hostPhone').innerText = p.phone || '·Éú·Éù·Éõ·Éî·É†·Éò ·Éê·É† ·Éê·É†·Éò·É°';
            if (document.getElementById('hostAvatarChar') && p.host_name) {
                document.getElementById('hostAvatarChar').innerText = p.host_name.charAt(0).toUpperCase();
            }

            // Tier Badge
            const tb = document.getElementById('tierBadge');
            if (p.tier === 'vip') {
                tb.innerHTML = `<span class="vip-badge px-3 py-1 rounded-full text-[10px] font-extrabold uppercase tracking-widest">VIP</span>`;
            } else if (p.tier === 'super_vip') {
                tb.innerHTML = `<span class="super-vip-badge px-3 py-1 rounded-full text-[10px] font-extrabold uppercase tracking-widest">Super VIP</span>`;
            }

            // Hero Images
            window.updateHeroGallery(p.images && p.images.length > 0 ? p.images : [p.image_url || 'images/gh_logo.webp']);

            // Amenities
            const amList = document.getElementById('amenitiesList');
            if (p.amenities && p.amenities.length > 0) {
                p.amenities.forEach(a => {
                    const d = document.createElement('div');
                    d.className = "flex items-center gap-3 text-gray-600 font-medium";
                    d.innerHTML = `<span class="text-green-500">‚úì</span> ${a}`;
                    amList.appendChild(d);
                });
            } else {
                document.getElementById('amenitiesSection').classList.add('hidden');
            }

            // Pricing Table
            const header = document.getElementById('priceHeader');
            const body = document.getElementById('priceBody');
            MONTHS.forEach((m, idx) => {
                const th = document.createElement('th');
                th.className = `p-4 text-left text-[10px] font-bold uppercase transition-colors ${idx === CUR_MONTH ? 'bg-green-500 text-white' : 'text-gray-400'}`;
                th.innerText = m;
                header.appendChild(th);
            });

            if (p.seasonal_prices && p.seasonal_prices.length > 0) {
                p.seasonal_prices.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td class="p-4 font-bold text-gray-700 bg-gray-50/30">${row.label}</td>`;
                    row.prices.forEach((price, idx) => {
                        tr.innerHTML += `<td class="p-4 text-center font-medium ${idx === CUR_MONTH ? 'current-month-highlight' : 'text-gray-500'}">${price || '-'}‚Çæ</td>`;
                    });
                    body.appendChild(tr);
                });
            }

            // Badge Counts
            document.getElementById('roomCount').innerText = GSTATE.rooms.length || p.seasonal_prices?.length || 0;
            const totalBeds = GSTATE.rooms.reduce((acc, r) => acc + (parseInt(r.beds) || 0), 0);
            document.getElementById('totalBeds').innerText = totalBeds;
        }

        let currentSlideIndex = 0;
        let slideImages = [];

        window.updateHeroGallery = function (imgs) {
            slideImages = Array.isArray(imgs) && imgs.length > 0 ? imgs : [GSTATE.property.image_url || 'images/gh_logo.webp'];
            updateGallery();
        };

        function updateGallery() {
            const hero = document.getElementById('heroContainer');
            if (!hero) return;

            if (slideImages.length === 1) {
                hero.innerHTML = `
                    <div class="h-[300px] md:h-[500px] w-full overflow-hidden">
                        <img src="${slideImages[0]}" class="w-full h-full object-cover cursor-pointer" onclick="window.expandImage('${slideImages[0]}')">
                    </div>
                `;
            } else {
                let gridHtml = `
                    <div class="grid grid-cols-2 md:grid-cols-4 md:grid-rows-2 gap-2 h-[300px] md:h-[500px] relative">
                        <div class="col-span-2 row-span-2 h-full overflow-hidden">
                            <img src="${slideImages[0]}" class="w-full h-full object-cover cursor-pointer hover:opacity-95 transition duration-300" onclick="window.expandImage('${slideImages[0]}')">
                        </div>
                `;

                const sideImages = slideImages.slice(1, 5);
                sideImages.forEach(src => {
                    gridHtml += `
                        <div class="hidden md:block h-full overflow-hidden">
                            <img src="${src}" class="w-full h-full object-cover cursor-pointer hover:scale-105 hover:opacity-95 transition duration-500" onclick="window.expandImage('${src}')">
                        </div>
                    `;
                });

                if (slideImages.length > 1) {
                    gridHtml += `
                         <button onclick="window.showAllPhotos()" class="absolute bottom-4 right-4 bg-white text-gray-900 px-4 py-2 rounded-xl font-bold shadow-md hover:bg-gray-50 transition border border-gray-200 z-10 flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                            ·Éß·Éï·Éî·Éö·Éê ·É§·Éù·É¢·Éù (${slideImages.length})
                         </button>
                    `;
                }

                gridHtml += `</div>`;
                hero.innerHTML = gridHtml;
            }
        }

        window.showAllPhotos = function () {
            let imagesHtml = slideImages.map(img => `
                <div class="aspect-video rounded-xl overflow-hidden shadow-sm">
                    <img src="${img}" class="w-full h-full object-cover cursor-pointer hover:scale-105 transition duration-500" onclick="window.expandImage('${img}')">
                </div>
            `).join('');

            Swal.fire({
                title: '·Éí·Éê·Éö·Éî·É†·Éî·Éê',
                html: `<div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">${imagesHtml}</div>`,
                width: '90%',
                showConfirmButton: false,
                showCloseButton: true,
                customClass: {
                    container: 'z-[1000]',
                    popup: 'rounded-3xl'
                }
            });
        };

        window.nextSlide = () => { }; // No longer needed but keeping to avoid errors if called
        window.prevSlide = () => { };

        function initRoomTabs(property, rooms) {
            const section = document.getElementById('roomTabsSection');
            const container = document.getElementById('tabsContainer');
            section.classList.remove('hidden');
            container.innerHTML = '';

            // 1. Exterior Tab
            const mainBtn = document.createElement('button');
            mainBtn.className = 'tab-btn active px-6 py-2.5 bg-black text-white rounded-full text-sm font-bold shadow-md transition-all whitespace-nowrap';
            mainBtn.innerText = 'üè° ·Éí·Éê·É†·Éî ·Éï·Éò·Éñ·É£·Éê·Éö·Éò';
            mainBtn.onclick = () => switchTab('main', property.images, null, mainBtn);
            container.appendChild(mainBtn);

            // 2. Room Tabs
            rooms.forEach(room => {
                const btn = document.createElement('button');
                btn.className = 'tab-btn px-6 py-2.5 bg-white text-gray-700 border border-gray-200 rounded-full text-sm font-bold shadow-sm hover:bg-gray-50 transition-all whitespace-nowrap';
                btn.innerText = `üõèÔ∏è ${room.name}`;
                btn.onclick = () => switchTab('room', room.images, room, btn);
                container.appendChild(btn);
            });
        }

        function switchTab(type, images, roomData, btn) {
            // Update Active Tab UI
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.className = 'tab-btn px-6 py-2.5 bg-white text-gray-700 border border-gray-200 rounded-full text-sm font-bold shadow-sm hover:bg-gray-50 transition-all whitespace-nowrap';
            });
            btn.className = 'tab-btn active px-6 py-2.5 bg-black text-white rounded-full text-sm font-bold shadow-md transition-all whitespace-nowrap';

            // Switch Hero Gallery
            const galleryImgs = (images && images.length > 0) ? images : [GSTATE.property.image_url || 'images/gh_logo.webp'];
            window.updateHeroGallery(galleryImgs);

            // Show Room Info
            const infoBox = document.getElementById('roomInfoDisplay');
            if (type === 'room' && roomData) {
                infoBox.classList.remove('hidden');
                document.getElementById('displayRoomName').innerText = roomData.name;
                document.getElementById('displayRoomBeds').innerText = `${roomData.beds} ·É°·Éê·É¨·Éù·Éö·Éò`;

                // Sq Meters
                const sqEl = document.getElementById('displayRoomSq');
                if (roomData.sq_meters) {
                    sqEl.innerText = `${roomData.sq_meters} m¬≤`;
                    sqEl.classList.remove('hidden');
                } else {
                    sqEl.classList.add('hidden');
                }

                // Description
                const descEl = document.getElementById('displayRoomDesc');
                if (roomData.description) {
                    descEl.innerText = roomData.description;
                    descEl.classList.remove('hidden');
                } else {
                    descEl.classList.add('hidden');
                }
            } else {
                infoBox.classList.add('hidden');
            }
        }

        async function updateNavigation() {
            const container = document.getElementById('navAuthBtnContainer');
            if (!container) return;

            const { data: { session } } = await supabaseClient.auth.getSession();
            const user = session ? session.user : null;

            if (user) {
                const name = user.user_metadata.full_name || user.email;
                const avatar = user.user_metadata.avatar_url || 'https://www.gravatar.com/avatar/?d=mp';

                let tier = 'Free';
                try {
                    const { data } = await supabaseClient.from('profiles').select('subscription_tier').eq('id', user.id).single();
                    if (data) tier = data.subscription_tier || 'Free';
                } catch (e) { console.error(e); }

                let tierDisplay = '';
                if (tier === 'super_vip') tierDisplay = `<span class="ml-1 text-amber-500 font-extrabold text-xs uppercase">‚ú® Super VIP</span>`;
                else if (tier === 'vip') tierDisplay = `<span class="ml-1 text-indigo-600 font-bold text-xs uppercase">üíé VIP</span>`;
                else tierDisplay = `<span class="ml-1 text-gray-500 text-xs">Standard</span><a href="pricing.html" class="ml-2 text-[9px] bg-amber-500 text-white px-1.5 py-0.5 rounded uppercase font-bold hover:bg-amber-600">Upgrade</a>`;

                container.innerHTML = `
                <div class="relative ml-2">
                    <button id="profileTrigger" onclick="toggleProfileDropdown(event)" class="flex items-center space-x-2 focus:outline-none bg-white hover:bg-gray-50 rounded-full pl-1 pr-3 py-1 transition-colors border border-gray-200 shadow-sm">
                        <img src="${avatar}" class="w-8 h-8 rounded-full border border-gray-200 object-cover">
                        <span class="hidden sm:inline text-sm font-bold text-gray-700 max-w-[100px] truncate">${name.split(' ')[0]}</span>
                        <svg class="w-4 h-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </button>
                    
                    <div id="profileDropdown" class="absolute right-0 mt-3 w-64 bg-white rounded-2xl shadow-2xl border border-gray-100 py-2 hidden z-50 animate-fade-in-down">
                        <div class="px-5 py-3 border-b border-gray-100 mb-1">
                            <p class="text-xs text-gray-400 font-medium uppercase tracking-wider">·Éê·Éú·Éí·Éê·É†·Éò·É®·Éò</p>
                            <p class="text-sm font-bold text-gray-900 truncate mt-0.5">${name}</p>
                            <div class="mt-1 flex items-center">${tierDisplay}</div>
                        </div>
                        <div class="py-1">
                            <a href="profile.html" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-amber-50 hover:text-amber-600 transition-colors">
                                <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                                ·É©·Éî·Éõ·Éò ·Éí·Éê·Éú·É™·ÉÆ·Éê·Éì·Éî·Éë·Éî·Éë·Éò
                            </a>
                            <a href="bookings.html" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 transition-colors">
                                <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                                ·ÉØ·Éê·Éï·É®·Éú·Éî·Éë·Éò / ·Éô·Éê·Éö·Éî·Éú·Éì·Éê·É†·Éò
                            </a>
                        </div>
                        <div class="border-t border-gray-100 py-1">
                            <button onclick="handleLogout()" class="flex w-full items-center px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition-colors">
                                <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"/></svg>
                                ·Éí·Éê·É°·Éï·Éö·Éê
                            </button>
                        </div>
                    </div>
                </div>`;
            } else {
                container.innerHTML = `
                <button id="navAuthBtn" onclick="openAuthModal('register')"
                    class="bg-[#2d78b1] hover:bg-[#236a9e] text-white font-bold py-2 px-6 rounded-full transition-all shadow-sm">
                    ·É®·Éî·É°·Éï·Éö·Éê
                </button>`;
            }
        }

        window.handleLogout = async function () { await supabaseClient.auth.signOut(); window.location.reload(); };

        window.toggleProfileDropdown = function (e) { e.stopPropagation(); const d = document.getElementById('profileDropdown'); if (d) d.classList.toggle('hidden'); };

        window.openAddModal = async () => {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) window.location.href = 'add-property.html';
            else window.location.href = 'index.html?auth=register';
        };

        window.openAuthModal = (type) => { window.location.href = `index.html?auth=${type}`; };

        document.addEventListener('click', (e) => {
            const d = document.getElementById('profileDropdown');
            const t = document.getElementById('profileTrigger');
            if (d && !d.classList.contains('hidden') && !d.contains(e.target) && (!t || !t.contains(e.target))) {
                d.classList.add('hidden');
            }
        });

        init();

        // --- Booking System Logic ---
        let BSTATE = {
            allBookings: [],
            selections: {} // { roomId: { start: null, end: null } }
        };

        document.getElementById('bookBtn').onclick = async function () {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                Swal.fire({
                    title: '·Éê·Éï·É¢·Éù·É†·Éò·Éñ·Éê·É™·Éò·Éê',
                    text: '·ÉØ·Éê·Éï·É®·Éú·Éò·É°·Éó·Éï·Éò·É° ·É°·Éê·É≠·Éò·É†·Éù·Éê ·É°·Éò·É°·É¢·Éî·Éõ·Éê·É®·Éò ·É®·Éî·É°·Éï·Éö·Éê.',
                    icon: 'info',
                    showCancelButton: true,
                    confirmButtonText: '·É®·Éî·É°·Éï·Éö·Éê',
                    cancelButtonText: '·Éí·Éê·É£·É•·Éõ·Éî·Éë·Éê',
                    confirmButtonColor: '#2d78b1'
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = 'index.html?auth=login';
                    }
                });
                return;
            }
            openBookingModal();
        };

        async function openBookingModal() {
            document.getElementById('bookingModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';

            const propId = GSTATE.property.id;

            // Fetch bookings for this property
            const today = new Date().toISOString().split('T')[0];
            const { data: bookings, error: bError } = await supabaseClient
                .from('bookings')
                .select('*')
                .eq('property_id', propId)
                .gte('end_date', today);

            if (bError) {
                console.error("Error fetching bookings:", bError);
            }

            BSTATE.allBookings = bookings || [];
            renderBookingRooms();
        }

        function closeBookingModal() {
            document.getElementById('bookingModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
            BSTATE.selections = {};
        }

        function renderBookingRooms() {
            const list = document.getElementById('bookingRoomsList');
            if (!GSTATE.rooms || GSTATE.rooms.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-12">
                        <p class="text-gray-500 text-lg font-medium">·Éê·Éõ ·Éù·Éë·Éò·Éî·É•·É¢·Éñ·Éî ·Éù·Éó·Éê·ÉÆ·Éî·Éë·Éò ·Éê·É†·Éê·Éê ·Éì·Éê·Éõ·Éê·É¢·Éî·Éë·É£·Éö·Éò.</p>
                        <p class="text-gray-400 text-sm mt-2">·Éì·Éê·É£·Éô·Éê·Éï·É®·Éò·É†·Éì·Éò·Éó ·Éõ·Éê·É°·Éû·Éò·Éú·É´·Éî·Éö·É° ·Éì·Éî·É¢·Éê·Éö·Éî·Éë·Éò·É°·Éó·Éï·Éò·É°.</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = GSTATE.rooms.map(room => `
                <div class="bg-white border border-gray-100 rounded-3xl overflow-hidden shadow-sm hover:shadow-md transition-shadow">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-0">
                        <!-- Info & Gallery Section -->
                        <div class="lg:col-span-2 p-6 flex flex-col md:flex-row gap-6">
                            <!-- Image Gallery -->
                            <div class="w-full md:w-1/2 space-y-3">
                                <div class="relative aspect-video rounded-2xl overflow-hidden bg-gray-100">
                                    <img id="hero-${room.id}" src="${(room.images && room.images[0]) || 'images/gh_logo.webp'}" 
                                         class="w-full h-full object-cover cursor-pointer hover:scale-105 transition-transform duration-500"
                                         onclick="expandImage(this.src)">
                                </div>
                                <div class="mb-4">
                                ${room.images && room.images.length > 0 ? `
                                    <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-3">·É§·Éù·É¢·Éù·Éî·Éë·Éò</h4>
                                    <div class="grid grid-cols-4 sm:grid-cols-6 gap-2">
                                        ${room.images.map((img, idx) => `
                                            <div class="aspect-square rounded-lg overflow-hidden border-2 transition-all ${idx === 0 ? 'border-amber-500 shadow-md' : 'border-transparent hover:border-gray-200'}">
                                                <img src="${img}" 
                                                     class="w-full h-full object-cover cursor-pointer"
                                                     onclick="updateRoomHero('${room.id}', this)">
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>

                            <!-- Room Details -->
                            <div class="flex-1 space-y-4">
                                <div class="flex items-center justify-between">
                                    <h3 class="text-xl font-extrabold text-gray-900">${room.name}</h3>
                                    <span class="bg-indigo-50 text-indigo-600 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1">
                                        üõèÔ∏è ${room.beds} ·É°·Éê·É¨·Éù·Éö·Éò
                                    </span>
                                </div>
                                <div class="text-sm text-gray-500 leading-relaxed italic">
                                    ${room.description || '·Éù·Éó·Éê·ÉÆ·Éò·É° ·Éê·É¶·É¨·Éî·É†·Éê ·Éê·É† ·Éê·É†·Éò·É°.'}
                                </div>
                            </div>
                        </div>

                        <!-- Calendar Section -->
                        <!-- Calendar Section Wrapper -->
                        <div class="bg-gray-50/50 p-6 border-l border-gray-100">
                            <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">·Éê·Éò·É†·É©·Éò·Éî·Éó ·Éû·Éî·É†·Éò·Éù·Éì·Éò</h4>
                            
                            <!-- 2-Column Layout Wrapper -->
                            <div class="calendar-wrapper flex flex-col xl:flex-row gap-8 items-start justify-center w-full">
                                
                                <!-- Col 1: Calendar & Month Dropdown -->
                                <div class="flex flex-col items-center w-full xl:w-auto z-20 relative">
                                    
                                    <!-- Scroll Stack Trigger & Menu -->
                                    <div class="stack-wrapper">
                                        <button class="stack-trigger" onclick="toggleStack('${room.id}', event)" id="stack-trigger-${room.id}">
                                            <span id="stack-label-${room.id}">Loading...</span>
                                            <svg class="w-5 h-5 transition-transform duration-300 transform group-[.open]:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                            </svg>
                                        </button>
                                        
                                        <div class="stack-menu custom-scrollbar" id="stack-menu-${room.id}">
                                            <!-- Items injected by JS -->
                                        </div>
                                    </div>

                                    <div class="scale-95 origin-top">
                                        <div id="calendar-container-${room.id}"></div>
                                    </div>
                                </div>
    
                                <!-- Col 2: Counter & Checkout -->
                                <div id="custom-counter-${room.id}" class="hidden p-6 border-2 border-black rounded-3xl shadow-hard bg-white animate-fade-in-down w-full max-w-sm flex-shrink-0 z-10">
                                    <p class="font-bold mb-4 text-gray-900">·É†·Éê·Éõ·Éì·Éî·Éú·Éò ·Éì·É¶·Éò·Éó ·Éí·É°·É£·É†·Éó ·Éì·Éê·É†·É©·Éî·Éú·Éê?</p>
                                    
                                    <div class="flex items-center gap-4">
                                        <button onclick="updateNightCount('${room.id}', -1)" type="button" class="w-10 h-10 flex items-center justify-center border-2 border-black rounded-full font-black text-xl hover:bg-gray-100 transition-colors active:scale-95">-</button>
                                        <div class="relative h-8 w-10 overflow-hidden">
                                            <span id="day-count-${room.id}" class="absolute inset-0 flex items-center justify-center text-2xl font-black">1</span>
                                        </div>
                                        <button onclick="updateNightCount('${room.id}', 1)" type="button" class="w-10 h-10 flex items-center justify-center border-2 border-black rounded-full font-black text-xl hover:bg-gray-100 transition-colors active:scale-95">+</button>
                                    </div>
                                    
                                    <div class="mt-4 pt-4 border-t border-dashed border-gray-200">
                                        <p class="text-xs text-gray-500 font-bold uppercase tracking-wider mb-1">·Éí·Éê·É°·Éï·Éö·Éò·É° ·Éó·Éê·É†·Éò·É¶·Éò</p>
                                        <p id="checkout-date-display-${room.id}" class="text-lg font-black text-gray-900">·Éõ·Éò·É£·Éó·Éò·Éó·Éî·Éó...</p>
                                    </div>

                                    <!-- Booking Button (Triggers Modal) -->
                                    <button onclick="openConfirmationModal('${room.id}')" 
                                            id="confirmBtn-${room.id}"
                                            class="mt-6 w-full bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-600 hover:to-teal-600 disabled:opacity-50 disabled:cursor-not-allowed text-white px-5 py-3 rounded-xl text-sm font-bold shadow-lg shadow-emerald-500/30 transition-all active:scale-95 flex justify-center items-center gap-2"
                                            disabled>
                                        <span>·Éì·Éê·ÉØ·Éê·Éï·É®·Éú·Éê</span>
                                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" /></svg>
                                    </button>
                                </div>
                            </div>

                            <!-- Receipt Confirmation Modal -->
                            <div id="confirmationModal-${room.id}" class="booking-modal-overlay">
                                <div class="booking-receipt-card">
                                    <button onclick="closeConfirmationModal('${room.id}')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors">
                                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                                    </button>
                                    
                                    <div class="text-center mb-6">
                                        <div class="w-12 h-12 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-3 text-emerald-600">
                                            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                        </div>
                                        <h3 class="text-xl font-black text-gray-900">·Éí·Éê·Éì·Éê·Éê·Éõ·Éù·É¨·Éõ·Éî·Éó ·Éõ·Éù·Éú·Éê·É™·Éî·Éõ·Éî·Éë·Éò</h3>
                                        <p class="text-sm text-gray-500 mt-1">·Éí·Éó·ÉÆ·Éù·Éï·Éó ·Éì·Éê·Éê·Éì·Éê·É°·É¢·É£·É†·Éù·Éó ·ÉØ·Éê·Éï·É®·Éú·Éò·É° ·Éì·Éî·É¢·Éê·Éö·Éî·Éë·Éò</p>
                                    </div>

                                    <div class="space-y-3">
                                        <div class="receipt-row">
                                            <span>·É®·Éî·É°·Éï·Éö·Éò·É° ·Éó·Éê·É†·Éò·É¶·Éò</span>
                                            <span class="font-bold text-gray-900" id="receipt-checkin-${room.id}">-</span>
                                        </div>
                                        <div class="receipt-row">
                                            <span>·Éí·Éê·É°·Éï·Éö·Éò·É° ·Éó·Éê·É†·Éò·É¶·Éò</span>
                                            <span class="font-bold text-gray-900" id="receipt-checkout-${room.id}">-</span>
                                        </div>
                                        <div class="receipt-row">
                                            <span>·É¶·Éê·Éõ·Éî·Éî·Éë·Éò·É° ·É†·Éê·Éù·Éì·Éî·Éú·Éù·Éë·Éê</span>
                                            <span class="font-bold text-gray-900" id="receipt-nights-${room.id}">-</span>
                                        </div>
                                        <div class="receipt-row">
                                            <span>·Éù·Éó·Éê·ÉÆ·Éò·É° ·É§·Éê·É°·Éò (·É¶·Éê·Éõ·Éî)</span>
                                            <span class="font-bold text-gray-900">${room.price}‚Çæ</span>
                                        </div>
                                    </div>

                                    <div class="receipt-total">
                                        <span>·É°·É£·Éö ·Éí·Éê·Éì·Éê·É°·Éê·ÉÆ·Éì·Éî·Éö·Éò</span>
                                        <span class="text-emerald-600" id="receipt-total-${room.id}">0‚Çæ</span>
                                    </div>

                                    <button onclick="processBooking('${room.id}')" class="w-full mt-8 bg-black text-white py-3.5 rounded-xl font-bold shadow-lg hover:bg-gray-800 transition-all active:scale-95">
                                        ·Éì·Éê·Éì·Éê·É°·É¢·É£·É†·Éî·Éë·Éê ·Éì·Éê ·Éì·Éê·ÉØ·Éê·Éï·É®·Éú·Éê
                                    </button>
                                </div>
                            </div>

                            <div id="rangeText-${room.id}" class="hidden"></div>
                        </div>
                    </div>
                </div>
            `).join('');

            // Initialize Flatpickr for each room
            GSTATE.rooms.forEach(room => {
                initRoomCalendar(room.id);
            });
        }

        window.updateRoomHero = function (roomId, thumb) {
            const hero = document.getElementById(`hero-${roomId}`);
            hero.src = thumb.src;
            // Update border
            const parent = thumb.parentElement;
            parent.querySelectorAll('img').forEach(img => img.classList.remove('border-amber-500'));
            parent.querySelectorAll('img').forEach(img => img.classList.add('border-transparent'));
            thumb.classList.remove('border-transparent');
            thumb.classList.add('border-amber-500');
        };

        window.expandImage = function (src) {
            Swal.fire({
                imageUrl: src,
                imageAlt: 'Room Image',
                showConfirmButton: false,
                width: '80%',
                background: 'transparent',
                customClass: {
                    image: 'rounded-2xl shadow-2xl'
                }
            });
        };

        // Initialize Flatpickr instances to access them outside
        let calendarInstances = {};

        function initRoomCalendar(roomId) {
            if (!BSTATE.selections[roomId]) {
                BSTATE.selections[roomId] = { start: null, end: null };
            }

            // Convert bookings to Flatpickr disable format
            const bookings = BSTATE.allBookings.filter(b => b.room_id == roomId).map(b => ({
                from: b.start_date,
                to: b.end_date
            }));

            const cal = flatpickr(`#calendar-container-${roomId}`, {
                mode: "range",
                inline: true,
                minDate: "today",
                showMonths: 1,
                shorthandCurrentMonth: false,
                dateFormat: "Y-m-d",
                disable: bookings,
                locale: {
                    firstDayOfWeek: 1,
                    weekdays: {
                        shorthand: ["·Éô·Éï", "·Éù·É†", "·É°·Éê", "·Éù·Éó", "·ÉÆ·É£", "·Éû·Éê", "·É®·Éê"],
                        longhand: ["·Éô·Éï·Éò·É†·Éê", "·Éù·É†·É®·Éê·Éë·Éê·Éó·Éò", "·É°·Éê·Éõ·É®·Éê·Éë·Éê·Éó·Éò", "·Éù·Éó·ÉÆ·É®·Éê·Éë·Éê·Éó·Éò", "·ÉÆ·É£·Éó·É®·Éê·Éë·Éê·Éó·Éò", "·Éû·Éê·É†·Éê·É°·Éô·Éî·Éï·Éò", "·É®·Éê·Éë·Éê·Éó·Éò"]
                    },
                    months: {
                        shorthand: ["·Éò·Éê·Éú", "·Éó·Éî·Éë", "·Éõ·Éê·É†", "·Éê·Éû·É†", "·Éõ·Éê·Éò", "·Éò·Éï·Éú", "·Éò·Éï·Éö", "·Éê·Éí·Éï", "·É°·Éî·É•", "·Éù·É•·É¢", "·Éú·Éù·Éî", "·Éì·Éî·Éô"],
                        longhand: ["·Éò·Éê·Éú·Éï·Éê·É†·Éò", "·Éó·Éî·Éë·Éî·É†·Éï·Éê·Éö·Éò", "·Éõ·Éê·É†·É¢·Éò", "·Éê·Éû·É†·Éò·Éö·Éò", "·Éõ·Éê·Éò·É°·Éò", "·Éò·Éï·Éú·Éò·É°·Éò", "·Éò·Éï·Éö·Éò·É°·Éò", "·Éê·Éí·Éï·Éò·É°·É¢·Éù", "·É°·Éî·É•·É¢·Éî·Éõ·Éë·Éî·É†·Éò", "·Éù·É•·É¢·Éù·Éõ·Éë·Éî·É†·Éò", "·Éú·Éù·Éî·Éõ·Éë·Éî·É†·Éò", "·Éì·Éî·Éô·Éî·Éõ·Éë·Éî·É†·Éò"]
                    }
                },
                prevArrow: "",
                nextArrow: "",

                onReady: function (selectedDates, dateStr, instance) {
                    renderStackMenu(instance, roomId);
                    updateStackTrigger(instance, roomId);
                },
                onMonthChange: function (selectedDates, dateStr, instance) {
                    updateStackTrigger(instance, roomId);
                    // Update active class in stack
                    updateStackActiveState(instance, roomId);
                },
                onYearChange: function (selectedDates, dateStr, instance) {
                    // Re-render stack if year changes to keep year correct? 
                    // Actually, years usually scroll. We can just update active state.
                    updateStackTrigger(instance, roomId);
                    updateStackActiveState(instance, roomId);
                },
                onChange: function (selectedDates, dateStr, instance) {
                    const counterEl = document.getElementById(`custom-counter-${roomId}`);
                    const countSpan = document.getElementById(`day-count-${roomId}`);
                    const checkoutEl = document.getElementById(`checkout-date-display-${roomId}`);
                    const btn = document.getElementById(`confirmBtn-${roomId}`);

                    if (selectedDates.length > 0) {
                        // Reveal counter
                        if (counterEl) {
                            counterEl.classList.remove('hidden');
                        }

                        BSTATE.selections[roomId] = {
                            start: instance.formatDate(selectedDates[0], "Y-m-d"),
                            end: selectedDates[1] ? instance.formatDate(selectedDates[1], "Y-m-d") : null
                        };

                        if (selectedDates.length === 2) {
                            // --- Case: Range Selected ---
                            const diffTime = Math.abs(selectedDates[1] - selectedDates[0]);
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                            if (countSpan) countSpan.textContent = diffDays;

                            // Calc checkout
                            const endD = selectedDates[1];
                            if (checkoutEl) checkoutEl.innerText = `${endD.getDate().toString().padStart(2, '0')}/${(endD.getMonth() + 1).toString().padStart(2, '0')}/${endD.getFullYear()}`;

                            if (btn) btn.disabled = false;

                        } else {
                            // --- Case: Single Date Selected ---
                            if (countSpan) countSpan.textContent = "1";
                            if (checkoutEl) checkoutEl.innerText = "·Éõ·Éò·É£·Éó·Éò·Éó·Éî·Éó...";

                            // Disable confirm until range is picked
                            if (btn) btn.disabled = true;
                        }
                    } else {
                        if (counterEl) {
                            counterEl.classList.add('hidden');
                        }
                        if (btn) btn.disabled = true;
                    }
                }
            });

            calendarInstances[roomId] = cal;
        }

        // --- Bubble Menu Logic ---

        // --- Scroll Stack Logic ---

        window.toggleStack = function (roomId, e) {
            e.stopPropagation();
            const menu = document.getElementById(`stack-menu-${roomId}`);
            const btn = document.getElementById(`stack-trigger-${roomId}`);

            // Close others
            document.querySelectorAll('.stack-menu').forEach(el => {
                if (el.id !== `stack-menu-${roomId}`) el.classList.remove('open');
            });

            if (menu) {
                menu.classList.toggle('open');
                if (btn) btn.classList.toggle('open');
            }
        };

        window.selectStackMonth = function (e, roomId, monthIndex) {
            e.stopPropagation();
            const instance = calendarInstances[roomId];
            if (instance) {
                instance.jumpToDate(new Date(instance.currentYear, monthIndex, 1));

                // Update UI immediately (though onMonthChange will also fire)
                updateStackTrigger(instance, roomId);
                updateStackActiveState(instance, roomId);

                // Close menu
                const menu = document.getElementById(`stack-menu-${roomId}`);
                const btn = document.getElementById(`stack-trigger-${roomId}`);
                if (menu) menu.classList.remove('open');
                if (btn) btn.classList.remove('open');
            }
        };

        function updateStackTrigger(instance, roomId) {
            const label = document.getElementById(`stack-label-${roomId}`);
            if (!label) return;

            const monthName = instance.l10n.months.longhand[instance.currentMonth];
            const year = instance.currentYear;

            const m = instance.currentMonth;
            let icon = '';
            if (m === 11 || m === 0 || m === 1) icon = '‚ùÑÔ∏è';
            else if (m >= 2 && m <= 4) icon = 'üå∏';
            else if (m >= 5 && m <= 7) icon = '‚òÄÔ∏è';
            else if (m >= 8 && m <= 10) icon = 'üçÇ';

            label.innerText = `${icon} ${monthName}, ${year}`;
        }

        function renderStackMenu(instance, roomId) {
            const container = document.getElementById(`stack-menu-${roomId}`);
            if (!container) return;

            const months = [
                { name: "·Éò·Éê·Éú·Éï·Éê·É†·Éò", icon: "‚ùÑÔ∏è" }, { name: "·Éó·Éî·Éë·Éî·É†·Éï·Éê·Éö·Éò", icon: "‚ùÑÔ∏è" },
                { name: "·Éõ·Éê·É†·É¢·Éò", icon: "üå∏" }, { name: "·Éê·Éû·É†·Éò·Éö·Éò", icon: "üå∏" }, { name: "·Éõ·Éê·Éò·É°·Éò", icon: "üå∏" },
                { name: "·Éò·Éï·Éú·Éò·É°·Éò", icon: "‚òÄÔ∏è" }, { name: "·Éò·Éï·Éö·Éò·É°·Éò", icon: "‚òÄÔ∏è" }, { name: "·Éê·Éí·Éï·Éò·É°·É¢·Éù", icon: "‚òÄÔ∏è" },
                { name: "·É°·Éî·É•·É¢·Éî·Éõ·Éë·Éî·É†·Éò", icon: "üçÇ" }, { name: "·Éù·É•·É¢·Éù·Éõ·Éë·Éî·É†·Éò", icon: "üçÇ" }, { name: "·Éú·Éù·Éî·Éõ·Éë·Éî·É†·Éò", icon: "üçÇ" },
                { name: "·Éì·Éî·Éô·Éî·Éõ·Éë·Éî·É†·Éò", icon: "‚ùÑÔ∏è" }
            ];

            container.innerHTML = months.map((m, i) => `
                <div class="stack-item" onclick="selectStackMonth(event, '${roomId}', ${i})" 
                     style="transition-delay: ${i * 30}ms">
                    <span class="text-xl w-8 text-center">${m.icon}</span>
                    <span class="flex-1">${m.name}</span>
                    ${i === instance.currentMonth ? '<span class="text-emerald-500">‚óè</span>' : ''}
                </div>
            `).join('');

            updateStackActiveState(instance, roomId);
        }

        function updateStackActiveState(instance, roomId) {
            const container = document.getElementById(`stack-menu-${roomId}`);
            if (!container) return;

            const items = container.querySelectorAll('.stack-item');
            items.forEach((item, idx) => {
                if (idx === instance.currentMonth) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        // Close on outside click
        document.addEventListener('click', function (e) {
            if (!e.target.closest('.stack-wrapper')) {
                document.querySelectorAll('.stack-menu').forEach(el => el.classList.remove('open'));
                document.querySelectorAll('.stack-trigger').forEach(el => el.classList.remove('open'));
            }
        });



        // --- Booking Modal Logic ---

        // --- Booking Modal Logic ---

        window.openConfirmationModal = function (roomId) {
            try {
                // 1. Data Gathering
                const sel = BSTATE.selections[roomId];
                const room = GSTATE.rooms.find(r => r.id == roomId);

                console.log("DEBUG: Opening Modal");
                console.log("Room:", room);
                console.log("GSTATE:", GSTATE);

                if (!sel || !sel.start || !sel.end || !room) {
                    Swal.fire('Info', '·Éí·Éó·ÉÆ·Éù·Éï·Éó ·Éê·Éò·É†·É©·Éò·Éù·Éó ·Éó·Éê·É†·Éò·É¶·Éî·Éë·Éò ·Éò·Éõ·Éò·É°·Éê·Éó·Éï·Éò·É° ·É†·Éù·Éõ ·Éì·Éê·ÉØ·Éê·Éï·É®·Éú·Éù·Éó.', 'info');
                    return;
                }

                // (Old calculations removed)
                // Robust Price Getter Fix
                const instance = calendarInstances[roomId];
                if (!instance) return;

                const nightlyPrice = parseFloat(room.price || 50); // Fallback to 50 if null
                const selectedDates = instance.selectedDates;

                let nights = 1;
                let totalPrice = nightlyPrice;

                if (selectedDates.length === 2) {
                    nights = Math.ceil(Math.abs(selectedDates[1] - selectedDates[0]) / (1000 * 60 * 60 * 24));
                    totalPrice = (nightlyPrice * nights).toFixed(0);
                } else if (selectedDates.length === 1) {
                    nights = 1;
                    totalPrice = nightlyPrice.toFixed(0);
                }

                // 4. Force-Inject Content
                const receiptContainer = document.querySelector(`#confirmationModal-${roomId} .space-y-3`);
                if (receiptContainer) {
                    receiptContainer.innerHTML = `
                    <div class="space-y-2 border-t pt-4 mt-4 text-sm">
                        <div class="flex justify-between items-center text-gray-600">
                            <span>·É®·Éî·É°·Éï·Éö·Éò·É° ·Éó·Éê·É†·Éò·É¶·Éò:</span>
                            <span class="font-bold text-gray-900" id="modal-checkin-date-${roomId}">
                                ${instance.formatDate(selectedDates[0], 'd M Y')}
                            </span>
                        </div>
                        <div class="flex justify-between items-center text-gray-600">
                            <span>·Éí·Éê·É°·Éï·Éö·Éò·É° ·Éó·Éê·É†·Éò·É¶·Éò:</span>
                            <span class="font-bold text-gray-900" id="modal-checkout-date-${roomId}">
                                ${selectedDates[1] ? instance.formatDate(selectedDates[1], 'd M Y') : '...'}
                            </span>
                        </div>
                        <div class="flex justify-between items-center mt-2">
                            <span>1 ·É¶·Éê·Éõ·Éò·É° ·É§·Éê·É°·Éò:</span>
                            <span class="font-bold"><span id="modal-nightly-price-${roomId}">${nightlyPrice}</span> ‚Çæ</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span>·É¶·Éê·Éõ·Éî·Éî·Éë·Éò·É° ·É†·Éê·Éù·Éì·Éî·Éú·Éù·Éë·Éê:</span>
                            <span class="font-bold" id="modal-total-nights-${roomId}">${nights}</span>
                        </div>
                    </div>
                    `;
                }

                // 5. Update Total
                const totalEl = document.getElementById(`receipt-total-${roomId}`);
                if (totalEl) {
                    totalEl.innerHTML = `<span id="modal-total-price-${roomId}" class="text-xl font-black text-emerald-600">${totalPrice} ‚Çæ</span>`;
                }

                // 6. Open Modal
                const modal = document.getElementById(`confirmationModal-${roomId}`);
                if (modal) {
                    modal.classList.add('open');
                } else {
                    console.error('Modal not found for room ' + roomId);
                }

            } catch (e) {
                console.error("Error opening modal:", e);
                Swal.fire('Error', '·Éì·Éê·É§·Éò·É•·É°·Éò·É†·Éì·Éê ·É®·Éî·É™·Éì·Éù·Éõ·Éê: ' + e.message, 'error');
            }
        };


        window.closeConfirmationModal = function (roomId) {
            const modal = document.getElementById(`confirmationModal-${roomId}`);
            if (modal) modal.classList.remove('open');
        };

        // --- Process Booking (Final Step) ---

        window.processBooking = async function (roomId) {
            const sel = BSTATE.selections[roomId];
            if (!sel || !sel.start || !sel.end) {
                Swal.fire('·Éß·É£·É†·Éê·Éì·É¶·Éî·Éë·Éê', '·Éí·Éó·ÉÆ·Éù·Éï·Éó ·Éê·Éò·É†·É©·Éò·Éù·Éó ·É°·Éê·É°·É£·É†·Éï·Éî·Éö·Éò ·Éû·Éî·É†·Éò·Éù·Éì·Éò.', 'warning');
                return;
            }

            const confirmBtn = document.querySelector(`#confirmationModal-${roomId} button:last-child`);
            if (confirmBtn) {
                confirmBtn.disabled = true;
                confirmBtn.textContent = '·Éõ·É£·É®·Éê·Éï·Éì·Éî·Éë·Éê...';
            }

            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) {
                    closeConfirmationModal(roomId); // Close first
                    Swal.fire({
                        title: '·Éê·Éï·É¢·Éù·É†·Éò·Éñ·Éê·É™·Éò·Éê',
                        text: '·ÉØ·Éê·Éï·É®·Éú·Éò·É°·Éó·Éï·Éò·É° ·É°·Éê·É≠·Éò·É†·Éù·Éê ·É°·Éò·É°·É¢·Éî·Éõ·Éê·É®·Éò ·É®·Éî·É°·Éï·Éö·Éê.',
                        icon: 'info',
                        showCancelButton: true,
                        confirmButtonText: '·É®·Éî·É°·Éï·Éö·Éê',
                        cancelButtonText: '·Éí·Éê·É£·É•·Éõ·Éî·Éë·Éê',
                        confirmButtonColor: '#2d78b1'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            window.location.href = 'index.html?auth=login';
                        }
                    });
                    return;
                }

                const { error } = await supabaseClient.from('bookings').insert({
                    property_id: GSTATE.property.id,
                    room_id: roomId,
                    start_date: sel.start,
                    end_date: sel.end,
                    user_id: session.user.id,
                    status: 'pending',
                    guest_name: session.user.user_metadata.full_name || session.user.email,
                    guest_phone: GSTATE.property.phone,
                    booking_code: 'BK' + Math.random().toString(36).substr(2, 6).toUpperCase()
                });

                if (error) throw error;

                closeConfirmationModal(roomId);

                await Swal.fire({
                    icon: 'success',
                    title: '·Éí·Éò·Éö·Éù·É™·Éê·Éï·Éó!',
                    text: '·Éó·É•·Éï·Éî·Éú·Éò ·ÉØ·Éê·Éï·É®·Éê·Éú·Éò ·É¨·Éê·É†·Éõ·Éê·É¢·Éî·Éë·Éò·Éó ·Éí·Éê·Éò·Éí·Éñ·Éê·Éï·Éú·Éê. ·Éõ·Éê·É°·Éû·Éò·Éú·É´·Éî·Éö·Éò ·Éõ·Éê·Éö·Éî ·Éì·Éê·Éí·Éò·Éô·Éê·Éï·É®·Éò·É†·Éì·Éî·Éë·Éê·Éó.',
                    confirmButtonColor: '#22c55e'
                });

            } catch (err) {
                console.error(err);
                Swal.fire('·É®·Éî·É™·Éì·Éù·Éõ·Éê', '·ÉØ·Éê·Éï·É®·Éú·Éò·É° ·Éí·Éê·Éí·Éñ·Éê·Éï·Éú·Éê ·Éï·Éî·É† ·Éõ·Éù·ÉÆ·Éî·É†·ÉÆ·Éì·Éê: ' + err.message, 'error');
            } finally {
                if (confirmBtn) {
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = '·Éì·Éê·Éì·Éê·É°·É¢·É£·É†·Éî·Éë·Éê ·Éì·Éê ·Éì·Éê·ÉØ·Éê·Éï·É®·Éú·Éê';
                }
            }
        };




        // --- Counter Logic (Updated to handle range/single) ---
        window.updateNightCount = function (roomId, change) {
            const instance = calendarInstances[roomId];
            if (!instance || instance.selectedDates.length === 0) return;

            const countSpan = document.getElementById(`day-count-${roomId}`);
            if (!countSpan) return;

            // If only 1 date selected, we can't really "add days" to it logically without picking a checkout date first visually?
            // Actually, if they click +, we can force select the range starting from start date.

            let currentVal = parseInt(countSpan.textContent);
            let newVal = currentVal + change;
            if (newVal < 1) newVal = 1;

            if (instance.selectedDates.length === 1) {
                // If single date, treat + as setting range to startDate + 1 night
                newVal = 1 + change;
                if (newVal < 1) newVal = 1;
            }

            // Animation
            if (newVal !== currentVal) {
                countSpan.classList.remove('animate-count-up', 'animate-count-down');
                void countSpan.offsetWidth; // trigger reflow
                if (change > 0) countSpan.classList.add('animate-count-up');
                else countSpan.classList.add('animate-count-down');
            }

            countSpan.textContent = newVal;

            // Recalculate Calendar Range
            const startDate = instance.selectedDates[0];
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + newVal);

            // Update Flatpickr
            instance.setDate([startDate, endDate], true); // true = trigger onChange
        };


        function updateRoomSelectionUI(roomId) {
            const sel = BSTATE.selections[roomId];
            const txt = document.getElementById(`rangeText-${roomId}`);
            const btn = document.getElementById(`confirmBtn-${roomId}`);

            if (!txt || !btn) return;

            if (sel.start && sel.end) {
                txt.innerText = `${sel.start} - ${sel.end}`;
                btn.disabled = false;
            } else if (sel.start) {
                txt.innerHTML = `<span class="text-indigo-600">·Éõ·Éù·Éú·Éò·É®·Éú·Éî·Éó ·Éì·Éê·É°·Éê·É°·É†·É£·Éö·Éò...</span>`;
                btn.disabled = true;
            } else {
                txt.innerText = `·Éõ·Éù·Éú·Éò·É®·Éú·Éî·Éó ·Éó·Éê·É†·Éò·É¶·Éî·Éë·Éò`;
                btn.disabled = true;
            }
        }

        window.confirmRoomBooking = async function (roomId) {
            const sel = BSTATE.selections[roomId];
            if (!sel.start || !sel.end) return;

            const { value: confirm } = await Swal.fire({
                title: '·Éì·Éê·Éê·Éì·Éê·É°·É¢·É£·É†·Éî·Éó ·ÉØ·Éê·Éï·É®·Éê·Éú·Éò',
                text: `${sel.start}-·Éì·Éê·Éú ${sel.end}-·Éõ·Éì·Éî`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '·Éì·Éê·É°·É¢·É£·É†·Éò',
                cancelButtonText: '·Éí·Éê·É£·É•·Éõ·Éî·Éë·Éê',
                confirmButtonColor: '#22c55e',
                cancelButtonColor: '#6b7280'
            });

            if (!confirm) return;

            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) {
                    Swal.fire({
                        title: '·Éê·Éï·É¢·Éù·É†·Éò·Éñ·Éê·É™·Éò·Éê',
                        text: '·ÉØ·Éê·Éï·É®·Éú·Éò·É°·Éó·Éï·Éò·É° ·É°·Éê·É≠·Éò·É†·Éù·Éê ·É°·Éò·É°·É¢·Éî·Éõ·Éê·É®·Éò ·É®·Éî·É°·Éï·Éö·Éê.',
                        icon: 'info',
                        showCancelButton: true,
                        confirmButtonText: '·É®·Éî·É°·Éï·Éö·Éê',
                        cancelButtonText: '·Éí·Éê·É£·É•·Éõ·Éî·Éë·Éê',
                        confirmButtonColor: '#2d78b1'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            window.location.href = 'index.html?auth=login';
                        }
                    });
                    return;
                }

                const { error } = await supabaseClient.from('bookings').insert({
                    property_id: GSTATE.property.id,
                    room_id: roomId,
                    start_date: sel.start,
                    end_date: sel.end,
                    user_id: session.user.id,
                    status: 'pending', // Default status
                    guest_name: session.user.user_metadata.full_name || session.user.email,
                    guest_phone: GSTATE.property.phone, // Or user phone if available
                    booking_code: 'BK' + Math.random().toString(36).substr(2, 6).toUpperCase()
                });

                if (error) throw error;

                await Swal.fire({
                    icon: 'success',
                    title: '·Éí·Éò·Éö·Éù·É™·Éê·Éï·Éó!',
                    text: '·Éó·É•·Éï·Éî·Éú·Éò ·ÉØ·Éê·Éï·É®·Éê·Éú·Éò ·É¨·Éê·É†·Éõ·Éê·É¢·Éî·Éë·Éò·Éó ·Éí·Éê·Éò·Éí·Éñ·Éê·Éï·Éú·Éê. ·Éõ·Éê·É°·Éû·Éò·Éú·É´·Éî·Éö·Éò ·Éõ·Éê·Éö·Éî ·Éì·Éê·Éí·Éò·Éô·Éê·Éï·É®·Éò·É†·Éì·Éî·Éë·Éê·Éó.',
                    confirmButtonColor: '#22c55e'
                });

                closeBookingModal();
            } catch (err) {
                console.error(err);
                Swal.fire('·É®·Éî·É™·Éì·Éù·Éõ·Éê', '·ÉØ·Éê·Éï·É®·Éú·Éò·É° ·Éí·Éê·Éí·Éñ·Éê·Éï·Éú·Éê ·Éï·Éî·É† ·Éõ·Éù·ÉÆ·Éî·É†·ÉÆ·Éì·Éê: ' + err.message, 'error');
            }
        };

        document.addEventListener('click', (e) => {
            const d = document.getElementById('profileDropdown');
            const t = document.getElementById('profileTrigger');
            if (d && !d.classList.contains('hidden') && !d.contains(e.target) && (!t || !t.contains(e.target))) {
                d.classList.add('hidden');
            }
        });

        init();
    </script>
</body>

</html>