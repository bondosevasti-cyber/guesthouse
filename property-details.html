<!DOCTYPE html>
<html lang="ka">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>áƒ“áƒ”áƒ¢áƒáƒšáƒ”áƒ‘áƒ˜ | GuesthouseGE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Georgian:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            font-family: 'Noto Sans Georgian', sans-serif;
        }

        .hero-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 8px;
            height: 450px;
        }

        @media (max-width: 768px) {
            .hero-grid {
                display: block;
                height: auto;
            }

            .hero-grid img {
                height: 250px;
                width: 100%;
                border-radius: 0;
            }
        }

        .vip-badge {
            background: linear-gradient(135deg, #ffd700, #ffae00);
            color: #000;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }

        .super-vip-badge {
            background: linear-gradient(135deg, #00d2ff, #3a7bd5);
            color: #fff;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 210, 255, 0.5);
        }

        .super-vip-badge::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transform: rotate(45deg);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% {
                left: -100%;
            }

            100% {
                left: 100%;
            }
        }

        .current-month-highlight {
            background-color: #f0fdf4;
            border: 2px solid #22c55e;
            color: #15803d;
            font-weight: 700;
        }

        .custom-scrollbar::-webkit-scrollbar {
            height: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #ddd;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #ccc;
        }

        /* Navbar Animations */
        @keyframes flagWave {
            0% {
                transform: rotate(0deg);
            }

            20% {
                transform: rotate(-5deg);
            }

            40% {
                transform: rotate(5deg);
            }

            60% {
                transform: rotate(-3deg);
            }

            80% {
                transform: rotate(3deg);
            }

            100% {
                transform: rotate(0deg);
            }
        }

        .animate-flag {
            animation: flagWave 2s infinite ease-in-out;
            transform-origin: top center;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in-down {
            animation: fadeInDown 0.3s ease-out forwards;
        }

        /* Calendar Styles */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            cursor: pointer;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }

        .calendar-day:hover:not(.booked) {
            background-color: #f3f4f6;
        }

        .calendar-day.booked {
            background-color: #ef4444 !important;
            color: white !important;
            cursor: not-allowed;
        }

        .calendar-day.selected {
            background-color: #22c55e !important;
            color: white !important;
        }

        .calendar-day.in-range {
            background-color: #dcfce7 !important;
        }

        .calendar-day.other-month {
            color: #d1d5db;
        }

        .calendar-day.today {
            border: 2px solid #22c55e;
            font-weight: bold;
        }
    </style>
</head>

<body class="bg-white">

    <!-- Global Loader -->
    <div id="loadingSpinner"
        class="fixed inset-0 z-[100] bg-white flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="relative">
            <div class="w-16 h-16 border-4 border-emerald-100 border-t-emerald-500 rounded-full animate-spin"></div>
            <div class="absolute inset-0 flex items-center justify-center">
                <div class="w-8 h-8 bg-emerald-50 rounded-full"></div>
            </div>
        </div>
        <p class="mt-4 text-emerald-600 font-bold tracking-widest animate-pulse uppercase text-xs">áƒ˜áƒ¢áƒ•áƒ˜áƒ áƒ—áƒ”áƒ‘áƒ...</p>
    </div>

    <!-- Navbar -->
    <nav class="fixed top-0 left-0 w-full z-40 bg-white shadow-md py-3 transition-all duration-300" id="navbar">
        <div class="max-w-7xl mx-auto px-4 flex justify-between items-center">
            <img src="images/gh_logo.webp" alt="GeorgiaTravel" onclick="window.location.href='index.html'"
                class="h-10 max-h-[40px] w-auto drop-shadow-md object-contain cursor-pointer transition-transform hover:scale-105 active:scale-95">
            <div class="flex items-center space-x-3">
                <a href="pricing.html"
                    class="hidden md:flex items-center bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all animate-flag">
                    <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    áƒ¤áƒáƒ¡áƒ”áƒ‘áƒ˜áƒ¡ áƒœáƒáƒ®áƒ•áƒ
                </a>
                <button onclick="openAddModal()"
                    class="bg-amber-500 hover:bg-amber-600 text-white font-bold p-2.5 rounded-full transition-all shadow-md hover:shadow-lg flex items-center justify-center transform hover:-translate-y-0.5"
                    title="áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                </button>
                <div id="navAuthBtnContainer">
                    <!-- Dynamic Auth Content -->
                </div>
            </div>
        </div>
    </nav>

    <div class="h-24"></div>

    <main class="max-w-7xl mx-auto px-4 pt-4 pb-32">
        <!-- Hero Section -->
        <div id="heroContainer" class="relative rounded-2xl overflow-hidden mb-8 shadow-xl bg-gray-100">
            <!-- Slider content will be injected by JS -->
            <div class="h-[500px] flex items-center justify-center">
                <div class="animate-spin h-8 w-8 border-4 border-amber-500 border-t-transparent rounded-full"></div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
            <!-- Left Info Panel -->
            <div class="lg:col-span-2 space-y-8">
                <div class="flex justify-between items-start">
                    <div>
                        <div id="tierBadge" class="mb-2"></div>
                        <h1 id="propName" class="text-3xl md:text-4xl font-bold text-gray-900 mb-2">...</h1>
                        <p id="propLocation" class="text-gray-500 flex items-center gap-1 font-medium italic">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path
                                    d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                <path d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            <span>...</span>
                        </p>
                    </div>
                </div>

                <div class="flex flex-wrap gap-4 py-6 border-y border-gray-100">
                    <div class="flex items-center gap-2 bg-gray-50 px-4 py-2 rounded-xl">
                        <span class="text-xl">ğŸ </span>
                        <div>
                            <p class="text-[10px] text-gray-400 font-bold uppercase">áƒ¢áƒ˜áƒáƒ˜</p>
                            <p id="propType" class="text-sm font-bold text-gray-700">...</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 bg-gray-50 px-4 py-2 rounded-xl">
                        <span class="text-xl">ğŸ›ï¸</span>
                        <div>
                            <p class="text-[10px] text-gray-400 font-bold uppercase">áƒ¡áƒáƒ¬áƒáƒšáƒ”áƒ‘áƒ˜</p>
                            <p id="totalBeds" class="text-sm font-bold text-gray-700">...</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 bg-gray-50 px-4 py-2 rounded-xl">
                        <span class="text-xl">ğŸšª</span>
                        <div>
                            <p class="text-[10px] text-gray-400 font-bold uppercase">áƒáƒ—áƒáƒ®áƒ”áƒ‘áƒ˜</p>
                            <p id="roomCount" class="text-sm font-bold text-gray-700">...</p>
                        </div>
                    </div>
                </div>

                <div>
                    <!-- Room Tabs Section -->
                    <div id="roomTabsSection" class="mb-8 mt-2 hidden">
                        <section class="flex space-x-2 overflow-x-auto pb-4 custom-scrollbar" id="tabsContainer">
                            <!-- Tabs JS Generated -->
                        </section>
                        <div id="roomInfoDisplay"
                            class="hidden mt-3 bg-gray-50 border border-gray-100 rounded-2xl p-6 animate-fade-in space-y-3">
                            <div class="flex items-center gap-3">
                                <span class="text-indigo-600 bg-indigo-50 p-2 rounded-lg">ğŸ›ï¸</span>
                                <div>
                                    <h4 id="displayRoomName" class="font-bold text-gray-900"></h4>
                                    <div class="flex gap-4 mt-1">
                                        <p id="displayRoomBeds"
                                            class="text-xs text-gray-500 font-medium uppercase tracking-wider"></p>
                                        <p id="displayRoomSq"
                                            class="text-xs text-indigo-600 font-bold uppercase tracking-wider"></p>
                                    </div>
                                </div>
                            </div>
                            <p id="displayRoomDesc"
                                class="text-sm text-gray-600 leading-relaxed italic border-t border-gray-100 pt-3 hidden">
                            </p>
                        </div>
                    </div>

                    <h2 class="text-xl font-bold text-gray-900 mb-4">áƒáƒ¦áƒ¬áƒ”áƒ áƒ</h2>
                    <p id="propDescription" class="text-gray-600 leading-relaxed whitespace-pre-line text-lg">...</p>
                </div>

                <div id="amenitiesSection">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">áƒ™áƒ”áƒ—áƒ˜áƒšáƒ›áƒáƒ¬áƒ§áƒáƒ‘áƒ</h2>
                    <div id="amenitiesList" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
                </div>

                <div>
                    <h2 class="text-xl font-bold text-gray-900 mb-4">áƒ¡áƒ”áƒ–áƒáƒœáƒ£áƒ áƒ˜ áƒ¤áƒáƒ¡áƒ”áƒ‘áƒ˜</h2>
                    <div class="overflow-x-auto rounded-2xl border border-gray-100">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50">
                                <tr id="priceHeader">
                                    <th class="p-4 text-left text-gray-400 font-bold uppercase text-[10px]">áƒáƒ—áƒáƒ®áƒ˜</th>
                                </tr>
                            </thead>
                            <tbody id="priceBody" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Right Sidebar -->
            <div class="space-y-6">
                <!-- Pricing Card -->
                <div class="bg-white border border-gray-100 rounded-3xl p-8 shadow-xl sticky top-24">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <p class="text-gray-400 text-sm font-bold uppercase mb-1">áƒ¤áƒáƒ¡áƒ˜</p>
                            <h2 id="propPrice" class="text-3xl font-extrabold text-gray-900">...</h2>
                        </div>
                        <div class="bg-green-50 text-green-600 px-3 py-1 rounded-full text-xs font-bold">áƒ®áƒ”áƒšáƒ›áƒ˜áƒ¡áƒáƒ¬áƒ•áƒ“áƒáƒ›áƒ˜áƒ
                        </div>
                    </div>
                    <button id="bookBtn"
                        class="w-full bg-gray-900 hover:bg-black text-white py-4 rounded-2xl font-bold text-lg shadow-lg transition active:scale-95 mb-4">
                        áƒ“áƒáƒ¯áƒáƒ•áƒ¨áƒœáƒ
                    </button>
                    <p class="text-center text-xs text-gray-400 mb-6">áƒ—áƒáƒœáƒ®áƒ˜áƒ¡ áƒ’áƒáƒ“áƒáƒ®áƒ“áƒ áƒ®áƒ“áƒ”áƒ‘áƒ áƒ›áƒáƒ¡áƒáƒ˜áƒœáƒ«áƒ”áƒšáƒ—áƒáƒœ</p>

                    <!-- Host Info Section -->
                    <div class="pt-6 border-t border-gray-100">
                        <p class="text-[10px] text-gray-400 font-bold uppercase mb-3 tracking-widest">áƒ›áƒáƒ¡áƒáƒ˜áƒœáƒ«áƒ”áƒšáƒ˜</p>
                        <div class="flex items-center gap-3">
                            <div
                                class="w-12 h-12 bg-emerald-100 rounded-full flex items-center justify-center text-emerald-600 font-bold text-xl shadow-inner">
                                <span id="hostAvatarChar">?</span>
                            </div>
                            <div class="overflow-hidden">
                                <h4 id="hostName" class="font-bold text-gray-900 truncate">...</h4>
                                <p id="hostPhone" class="text-xs text-emerald-600 font-bold">...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </main>

    <!-- Booking Modal -->
    <div id="bookingModal" class="fixed inset-0 z-[100] hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="fixed inset-0 bg-black/60 backdrop-blur-sm" onclick="closeBookingModal()"></div>

            <div class="relative bg-white w-full max-w-5xl rounded-3xl shadow-2xl overflow-hidden animate-fade-in-down">
                <!-- Header -->
                <div class="bg-gray-900 text-white px-8 py-6 flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold">áƒáƒ˜áƒ áƒ©áƒ˜áƒ”áƒ— áƒáƒ—áƒáƒ®áƒ˜ áƒ“áƒ áƒ—áƒáƒ áƒ˜áƒ¦áƒ”áƒ‘áƒ˜</h2>
                        <p class="text-gray-400 text-sm mt-1">áƒ“áƒáƒ¯áƒáƒ•áƒ¨áƒœáƒ”áƒ— áƒ—áƒ¥áƒ•áƒ”áƒœáƒ˜ áƒ¡áƒáƒ¡áƒ£áƒ áƒ•áƒ”áƒšáƒ˜ áƒáƒ—áƒáƒ®áƒ˜ áƒ¡áƒáƒ¡áƒ£áƒ áƒ•áƒ”áƒš áƒ“áƒ áƒáƒ¡</p>
                    </div>
                    <button onclick="closeBookingModal()" class="text-gray-400 hover:text-white transition-colors">
                        <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <!-- Content Area -->
                <div id="bookingRoomsList" class="p-8 space-y-8 max-h-[70vh] overflow-y-auto custom-scrollbar">
                    <!-- Rooms will be injected here -->
                    <div class="flex flex-col items-center justify-center py-20">
                        <div
                            class="animate-spin h-10 w-10 border-4 border-amber-500 border-t-transparent rounded-full mb-4">
                        </div>
                        <p class="text-gray-500 font-medium">áƒáƒ—áƒáƒ®áƒ”áƒ‘áƒ˜áƒ¡ áƒ©áƒáƒ¢áƒ•áƒ˜áƒ áƒ—áƒ•áƒ...</p>
                    </div>
                </div>

                <!-- Footer (Optional Informational) -->
                <div class="bg-gray-50 px-8 py-4 border-t border-gray-100 flex justify-between items-center">
                    <div class="flex items-center gap-4 text-sm">
                        <div class="flex items-center gap-1.5"><span
                                class="w-3 h-3 bg-white border border-gray-200 rounded-sm"></span> áƒ—áƒáƒ•áƒ˜áƒ¡áƒ£áƒ¤áƒáƒšáƒ˜</div>
                        <div class="flex items-center gap-1.5"><span class="w-3 h-3 bg-red-500 rounded-sm"></span>
                            áƒ“áƒáƒ™áƒáƒ•áƒ”áƒ‘áƒ£áƒšáƒ˜</div>
                        <div class="flex items-center gap-1.5"><span class="w-3 h-3 bg-green-500 rounded-sm"></span>
                            áƒáƒ áƒ©áƒ”áƒ£áƒšáƒ˜</div>
                    </div>
                    <p class="text-xs text-gray-400">* áƒ“áƒáƒ¯áƒáƒ•áƒ¨áƒœáƒ˜áƒ¡ áƒ¨áƒ”áƒ›áƒ“áƒ”áƒ’ áƒ“áƒáƒ’áƒ˜áƒ™áƒáƒ•áƒ¨áƒ˜áƒ áƒ“áƒ”áƒ‘áƒáƒ— áƒ›áƒáƒ¡áƒáƒ˜áƒœáƒ«áƒ”áƒšáƒ˜</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://akmbyvovhubccznrzotv.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFrbWJ5dm92aHViY2N6bnJ6b3R2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3NTgwMTAsImV4cCI6MjA4MjMzNDAxMH0.oHLvbx5_4hYATF-hQkJvp0oxZ6ljUfGKYP-Mf7_CVtM';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const MONTHS = ["áƒ˜áƒáƒœ", "áƒ—áƒ”áƒ‘", "áƒ›áƒáƒ ", "áƒáƒáƒ ", "áƒ›áƒáƒ˜", "áƒ˜áƒ•áƒœ", "áƒ˜áƒ•áƒš", "áƒáƒ’áƒ•", "áƒ¡áƒ”áƒ¥", "áƒáƒ¥áƒ¢", "áƒœáƒáƒ”", "áƒ“áƒ”áƒ™"];
        const CUR_MONTH = new Date().getMonth();

        let GSTATE = {
            property: null,
            rooms: []
        };

        async function init() {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            if (!id) { window.location.href = 'index.html'; return; }

            try {
                // Fetch Prop and Rooms in parallel (Outside of Auth)
                const [propRes, roomsRes] = await Promise.all([
                    supabaseClient.from('guesthouse_ge').select('*').eq('id', id).single(),
                    supabaseClient.from('rooms').select('*').eq('property_id', id)
                ]);

                if (propRes.error || !propRes.data) {
                    Swal.fire('áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ', 'áƒ’áƒáƒœáƒªáƒ®áƒáƒ“áƒ”áƒ‘áƒ áƒ•áƒ”áƒ  áƒ›áƒáƒ˜áƒ«áƒ”áƒ‘áƒœáƒ', 'error');
                    return;
                }

                GSTATE.property = propRes.data;
                GSTATE.rooms = roomsRes.data || [];

                renderProperty(GSTATE.property);
                if (GSTATE.rooms.length > 0) {
                    initRoomTabs(GSTATE.property, GSTATE.rooms);
                }
                updateNavigation();

                // Auth listener
                supabaseClient.auth.onAuthStateChange((event, session) => {
                    updateNavigation();
                });
            } catch (err) {
                console.error("Initialization Error:", err);
                Swal.fire('áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ', 'áƒ›áƒáƒœáƒáƒªáƒ”áƒ›áƒ”áƒ‘áƒ˜áƒ¡ áƒ©áƒáƒ¢áƒ•áƒ˜áƒ áƒ—áƒ•áƒ áƒ•áƒ”áƒ  áƒ›áƒáƒ®áƒ”áƒ áƒ®áƒ“áƒ', 'error');
            } finally {
                // ALWAYS hide global loader
                setTimeout(() => {
                    const loader = document.getElementById('loadingSpinner');
                    if (loader) {
                        loader.classList.add('opacity-0');
                        setTimeout(() => loader.classList.add('hidden'), 500);
                    }
                }, 800);
            }
        }

        function renderProperty(p) {
            document.title = `${p.name} | GuesthouseGE`;
            document.getElementById('propName').innerText = p.name || '...';
            document.getElementById('propLocation').querySelector('span').innerText = p.location || '...';
            document.getElementById('propType').innerText = p.type || '...';
            document.getElementById('propDescription').innerText = p.description || '...';
            document.getElementById('propPrice').innerText = p.price_display || '...';

            // Host Info
            if (document.getElementById('hostName')) document.getElementById('hostName').innerText = p.host_name || 'áƒ›áƒáƒ¡áƒáƒ˜áƒœáƒ«áƒ”áƒšáƒ˜';
            if (document.getElementById('hostPhone')) document.getElementById('hostPhone').innerText = p.phone || 'áƒœáƒáƒ›áƒ”áƒ áƒ˜ áƒáƒ  áƒáƒ áƒ˜áƒ¡';
            if (document.getElementById('hostAvatarChar') && p.host_name) {
                document.getElementById('hostAvatarChar').innerText = p.host_name.charAt(0).toUpperCase();
            }

            // Tier Badge
            const tb = document.getElementById('tierBadge');
            if (p.tier === 'vip') {
                tb.innerHTML = `<span class="vip-badge px-3 py-1 rounded-full text-[10px] font-extrabold uppercase tracking-widest">VIP</span>`;
            } else if (p.tier === 'super_vip') {
                tb.innerHTML = `<span class="super-vip-badge px-3 py-1 rounded-full text-[10px] font-extrabold uppercase tracking-widest">Super VIP</span>`;
            }

            // Hero Images
            window.updateHeroGallery(p.images && p.images.length > 0 ? p.images : [p.image_url || 'images/gh_logo.webp']);

            // Amenities
            const amList = document.getElementById('amenitiesList');
            if (p.amenities && p.amenities.length > 0) {
                p.amenities.forEach(a => {
                    const d = document.createElement('div');
                    d.className = "flex items-center gap-3 text-gray-600 font-medium";
                    d.innerHTML = `<span class="text-green-500">âœ“</span> ${a}`;
                    amList.appendChild(d);
                });
            } else {
                document.getElementById('amenitiesSection').classList.add('hidden');
            }

            // Pricing Table
            const header = document.getElementById('priceHeader');
            const body = document.getElementById('priceBody');
            MONTHS.forEach((m, idx) => {
                const th = document.createElement('th');
                th.className = `p-4 text-center text-[10px] font-bold uppercase transition-colors ${idx === CUR_MONTH ? 'bg-green-500 text-white' : 'text-gray-400'}`;
                th.innerText = m;
                header.appendChild(th);
            });

            if (p.seasonal_prices && p.seasonal_prices.length > 0) {
                p.seasonal_prices.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td class="p-4 font-bold text-gray-700 bg-gray-50/30">${row.label}</td>`;
                    row.prices.forEach((price, idx) => {
                        tr.innerHTML += `<td class="p-4 text-center font-medium ${idx === CUR_MONTH ? 'current-month-highlight' : 'text-gray-500'}">${price || '-'}â‚¾</td>`;
                    });
                    body.appendChild(tr);
                });
            }

            // Badge Counts
            document.getElementById('roomCount').innerText = GSTATE.rooms.length || p.seasonal_prices?.length || 0;
            const totalBeds = GSTATE.rooms.reduce((acc, r) => acc + (parseInt(r.beds) || 0), 0);
            document.getElementById('totalBeds').innerText = totalBeds;
        }

        let currentSlideIndex = 0;
        let slideImages = [];

        window.updateHeroGallery = function (imgs) {
            slideImages = Array.isArray(imgs) && imgs.length > 0 ? imgs : [GSTATE.property.image_url || 'images/gh_logo.webp'];
            updateGallery();
        };

        function updateGallery() {
            const hero = document.getElementById('heroContainer');
            if (!hero) return;

            if (slideImages.length === 1) {
                hero.innerHTML = `
                    <div class="h-[300px] md:h-[500px] w-full overflow-hidden">
                        <img src="${slideImages[0]}" class="w-full h-full object-cover cursor-pointer" onclick="window.expandImage('${slideImages[0]}')">
                    </div>
                `;
            } else {
                let gridHtml = `
                    <div class="grid grid-cols-2 md:grid-cols-4 md:grid-rows-2 gap-2 h-[300px] md:h-[500px] relative">
                        <div class="col-span-2 row-span-2 h-full overflow-hidden">
                            <img src="${slideImages[0]}" class="w-full h-full object-cover cursor-pointer hover:opacity-95 transition duration-300" onclick="window.expandImage('${slideImages[0]}')">
                        </div>
                `;

                const sideImages = slideImages.slice(1, 5);
                sideImages.forEach(src => {
                    gridHtml += `
                        <div class="hidden md:block h-full overflow-hidden">
                            <img src="${src}" class="w-full h-full object-cover cursor-pointer hover:scale-105 hover:opacity-95 transition duration-500" onclick="window.expandImage('${src}')">
                        </div>
                    `;
                });

                if (slideImages.length > 1) {
                    gridHtml += `
                         <button onclick="window.showAllPhotos()" class="absolute bottom-4 right-4 bg-white text-gray-900 px-4 py-2 rounded-xl font-bold shadow-md hover:bg-gray-50 transition border border-gray-200 z-10 flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                            áƒ§áƒ•áƒ”áƒšáƒ áƒ¤áƒáƒ¢áƒ (${slideImages.length})
                         </button>
                    `;
                }

                gridHtml += `</div>`;
                hero.innerHTML = gridHtml;
            }
        }

        window.showAllPhotos = function () {
            let imagesHtml = slideImages.map(img => `
                <div class="aspect-video rounded-xl overflow-hidden shadow-sm">
                    <img src="${img}" class="w-full h-full object-cover cursor-pointer hover:scale-105 transition duration-500" onclick="window.expandImage('${img}')">
                </div>
            `).join('');

            Swal.fire({
                title: 'áƒ’áƒáƒšáƒ”áƒ áƒ”áƒ',
                html: `<div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">${imagesHtml}</div>`,
                width: '90%',
                showConfirmButton: false,
                showCloseButton: true,
                customClass: {
                    container: 'z-[1000]',
                    popup: 'rounded-3xl'
                }
            });
        };

        window.nextSlide = () => { }; // No longer needed but keeping to avoid errors if called
        window.prevSlide = () => { };

        function initRoomTabs(property, rooms) {
            const section = document.getElementById('roomTabsSection');
            const container = document.getElementById('tabsContainer');
            section.classList.remove('hidden');
            container.innerHTML = '';

            // 1. Exterior Tab
            const mainBtn = document.createElement('button');
            mainBtn.className = 'tab-btn active px-6 py-2.5 bg-black text-white rounded-full text-sm font-bold shadow-md transition-all whitespace-nowrap';
            mainBtn.innerText = 'ğŸ¡ áƒ’áƒáƒ áƒ” áƒ•áƒ˜áƒ–áƒ£áƒáƒšáƒ˜';
            mainBtn.onclick = () => switchTab('main', property.images, null, mainBtn);
            container.appendChild(mainBtn);

            // 2. Room Tabs
            rooms.forEach(room => {
                const btn = document.createElement('button');
                btn.className = 'tab-btn px-6 py-2.5 bg-white text-gray-700 border border-gray-200 rounded-full text-sm font-bold shadow-sm hover:bg-gray-50 transition-all whitespace-nowrap';
                btn.innerText = `ğŸ›ï¸ ${room.name}`;
                btn.onclick = () => switchTab('room', room.images, room, btn);
                container.appendChild(btn);
            });
        }

        function switchTab(type, images, roomData, btn) {
            // Update Active Tab UI
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.className = 'tab-btn px-6 py-2.5 bg-white text-gray-700 border border-gray-200 rounded-full text-sm font-bold shadow-sm hover:bg-gray-50 transition-all whitespace-nowrap';
            });
            btn.className = 'tab-btn active px-6 py-2.5 bg-black text-white rounded-full text-sm font-bold shadow-md transition-all whitespace-nowrap';

            // Switch Hero Gallery
            const galleryImgs = (images && images.length > 0) ? images : [GSTATE.property.image_url || 'images/gh_logo.webp'];
            window.updateHeroGallery(galleryImgs);

            // Show Room Info
            const infoBox = document.getElementById('roomInfoDisplay');
            if (type === 'room' && roomData) {
                infoBox.classList.remove('hidden');
                document.getElementById('displayRoomName').innerText = roomData.name;
                document.getElementById('displayRoomBeds').innerText = `${roomData.beds} áƒ¡áƒáƒ¬áƒáƒšáƒ˜`;

                // Sq Meters
                const sqEl = document.getElementById('displayRoomSq');
                if (roomData.sq_meters) {
                    sqEl.innerText = `${roomData.sq_meters} mÂ²`;
                    sqEl.classList.remove('hidden');
                } else {
                    sqEl.classList.add('hidden');
                }

                // Description
                const descEl = document.getElementById('displayRoomDesc');
                if (roomData.description) {
                    descEl.innerText = roomData.description;
                    descEl.classList.remove('hidden');
                } else {
                    descEl.classList.add('hidden');
                }
            } else {
                infoBox.classList.add('hidden');
            }
        }

        async function updateNavigation() {
            const container = document.getElementById('navAuthBtnContainer');
            if (!container) return;

            const { data: { session } } = await supabaseClient.auth.getSession();
            const user = session ? session.user : null;

            if (user) {
                const name = user.user_metadata.full_name || user.email;
                const avatar = user.user_metadata.avatar_url || 'https://www.gravatar.com/avatar/?d=mp';

                let tier = 'Free';
                try {
                    const { data } = await supabaseClient.from('profiles').select('subscription_tier').eq('id', user.id).single();
                    if (data) tier = data.subscription_tier || 'Free';
                } catch (e) { console.error(e); }

                let tierDisplay = '';
                if (tier === 'super_vip') tierDisplay = `<span class="ml-1 text-amber-500 font-extrabold text-xs uppercase">âœ¨ Super VIP</span>`;
                else if (tier === 'vip') tierDisplay = `<span class="ml-1 text-indigo-600 font-bold text-xs uppercase">ğŸ’ VIP</span>`;
                else tierDisplay = `<span class="ml-1 text-gray-500 text-xs">Standard</span><a href="pricing.html" class="ml-2 text-[9px] bg-amber-500 text-white px-1.5 py-0.5 rounded uppercase font-bold hover:bg-amber-600">Upgrade</a>`;

                container.innerHTML = `
                <div class="relative ml-2">
                    <button id="profileTrigger" onclick="toggleProfileDropdown(event)" class="flex items-center space-x-2 focus:outline-none bg-white hover:bg-gray-50 rounded-full pl-1 pr-3 py-1 transition-colors border border-gray-200 shadow-sm">
                        <img src="${avatar}" class="w-8 h-8 rounded-full border border-gray-200 object-cover">
                        <span class="hidden sm:inline text-sm font-bold text-gray-700 max-w-[100px] truncate">${name.split(' ')[0]}</span>
                        <svg class="w-4 h-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </button>
                    
                    <div id="profileDropdown" class="absolute right-0 mt-3 w-64 bg-white rounded-2xl shadow-2xl border border-gray-100 py-2 hidden z-50 animate-fade-in-down">
                        <div class="px-5 py-3 border-b border-gray-100 mb-1">
                            <p class="text-xs text-gray-400 font-medium uppercase tracking-wider">áƒáƒœáƒ’áƒáƒ áƒ˜áƒ¨áƒ˜</p>
                            <p class="text-sm font-bold text-gray-900 truncate mt-0.5">${name}</p>
                            <div class="mt-1 flex items-center">${tierDisplay}</div>
                        </div>
                        <div class="py-1">
                            <a href="profile.html" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-amber-50 hover:text-amber-600 transition-colors">
                                <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                                áƒ©áƒ”áƒ›áƒ˜ áƒ’áƒáƒœáƒªáƒ®áƒáƒ“áƒ”áƒ‘áƒ”áƒ‘áƒ˜
                            </a>
                            <a href="bookings.html" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 transition-colors">
                                <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                                áƒ¯áƒáƒ•áƒ¨áƒœáƒ”áƒ‘áƒ˜ / áƒ™áƒáƒšáƒ”áƒœáƒ“áƒáƒ áƒ˜
                            </a>
                        </div>
                        <div class="border-t border-gray-100 py-1">
                            <button onclick="handleLogout()" class="flex w-full items-center px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition-colors">
                                <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"/></svg>
                                áƒ’áƒáƒ¡áƒ•áƒšáƒ
                            </button>
                        </div>
                    </div>
                </div>`;
            } else {
                container.innerHTML = `
                <button id="navAuthBtn" onclick="openAuthModal('register')"
                    class="bg-[#2d78b1] hover:bg-[#236a9e] text-white font-bold py-2 px-6 rounded-full transition-all shadow-sm">
                    áƒ¨áƒ”áƒ¡áƒ•áƒšáƒ
                </button>`;
            }
        }

        window.handleLogout = async function () { await supabaseClient.auth.signOut(); window.location.reload(); };

        window.toggleProfileDropdown = function (e) { e.stopPropagation(); const d = document.getElementById('profileDropdown'); if (d) d.classList.toggle('hidden'); };

        window.openAddModal = async () => {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) window.location.href = 'add-property.html';
            else window.location.href = 'index.html?auth=register';
        };

        window.openAuthModal = (type) => { window.location.href = `index.html?auth=${type}`; };

        document.addEventListener('click', (e) => {
            const d = document.getElementById('profileDropdown');
            const t = document.getElementById('profileTrigger');
            if (d && !d.classList.contains('hidden') && !d.contains(e.target) && (!t || !t.contains(e.target))) {
                d.classList.add('hidden');
            }
        });

        init();

        // --- Booking System Logic ---
        let BSTATE = {
            allBookings: [],
            selections: {} // { roomId: { start: null, end: null } }
        };

        document.getElementById('bookBtn').onclick = async function () {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                Swal.fire({
                    title: 'áƒáƒ•áƒ¢áƒáƒ áƒ˜áƒ–áƒáƒªáƒ˜áƒ',
                    text: 'áƒ¯áƒáƒ•áƒ¨áƒœáƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡ áƒ¡áƒáƒ­áƒ˜áƒ áƒáƒ áƒ¡áƒ˜áƒ¡áƒ¢áƒ”áƒ›áƒáƒ¨áƒ˜ áƒ¨áƒ”áƒ¡áƒ•áƒšáƒ.',
                    icon: 'info',
                    showCancelButton: true,
                    confirmButtonText: 'áƒ¨áƒ”áƒ¡áƒ•áƒšáƒ',
                    cancelButtonText: 'áƒ’áƒáƒ£áƒ¥áƒ›áƒ”áƒ‘áƒ',
                    confirmButtonColor: '#2d78b1'
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = 'index.html?auth=login';
                    }
                });
                return;
            }
            openBookingModal();
        };

        async function openBookingModal() {
            document.getElementById('bookingModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';

            const propId = GSTATE.property.id;

            // Fetch bookings for this property
            const today = new Date().toISOString().split('T')[0];
            const { data: bookings, error: bError } = await supabaseClient
                .from('bookings')
                .select('*')
                .eq('property_id', propId)
                .gte('end_date', today);

            if (bError) {
                console.error("Error fetching bookings:", bError);
            }

            BSTATE.allBookings = bookings || [];
            renderBookingRooms();
        }

        function closeBookingModal() {
            document.getElementById('bookingModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
            BSTATE.selections = {};
        }

        function renderBookingRooms() {
            const list = document.getElementById('bookingRoomsList');
            if (!GSTATE.rooms || GSTATE.rooms.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-12">
                        <p class="text-gray-500 text-lg font-medium">áƒáƒ› áƒáƒ‘áƒ˜áƒ”áƒ¥áƒ¢áƒ–áƒ” áƒáƒ—áƒáƒ®áƒ”áƒ‘áƒ˜ áƒáƒ áƒáƒ áƒ“áƒáƒ›áƒáƒ¢áƒ”áƒ‘áƒ£áƒšáƒ˜.</p>
                        <p class="text-gray-400 text-sm mt-2">áƒ“áƒáƒ£áƒ™áƒáƒ•áƒ¨áƒ˜áƒ áƒ“áƒ˜áƒ— áƒ›áƒáƒ¡áƒáƒ˜áƒœáƒ«áƒ”áƒšáƒ¡ áƒ“áƒ”áƒ¢áƒáƒšáƒ”áƒ‘áƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡.</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = GSTATE.rooms.map(room => `
                <div class="bg-white border border-gray-100 rounded-3xl overflow-hidden shadow-sm hover:shadow-md transition-shadow">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-0">
                        <!-- Info & Gallery Section -->
                        <div class="lg:col-span-2 p-6 flex flex-col md:flex-row gap-6">
                            <!-- Image Gallery -->
                            <div class="w-full md:w-1/2 space-y-3">
                                <div class="relative aspect-video rounded-2xl overflow-hidden bg-gray-100">
                                    <img id="hero-${room.id}" src="${(room.images && room.images[0]) || 'images/gh_logo.webp'}" 
                                         class="w-full h-full object-cover cursor-pointer hover:scale-105 transition-transform duration-500"
                                         onclick="expandImage(this.src)">
                                </div>
                                <div class="mb-4">
                                ${room.images && room.images.length > 0 ? `
                                    <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-3">áƒ¤áƒáƒ¢áƒáƒ”áƒ‘áƒ˜</h4>
                                    <div class="grid grid-cols-4 sm:grid-cols-6 gap-2">
                                        ${room.images.map((img, idx) => `
                                            <div class="aspect-square rounded-lg overflow-hidden border-2 transition-all ${idx === 0 ? 'border-amber-500 shadow-md' : 'border-transparent hover:border-gray-200'}">
                                                <img src="${img}" 
                                                     class="w-full h-full object-cover cursor-pointer"
                                                     onclick="updateRoomHero('${room.id}', this)">
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>

                            <!-- Room Details -->
                            <div class="flex-1 space-y-4">
                                <div class="flex items-center justify-between">
                                    <h3 class="text-xl font-extrabold text-gray-900">${room.name}</h3>
                                    <span class="bg-indigo-50 text-indigo-600 px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1">
                                        ğŸ›ï¸ ${room.beds} áƒ¡áƒáƒ¬áƒáƒšáƒ˜
                                    </span>
                                </div>
                                <div class="text-sm text-gray-500 leading-relaxed italic">
                                    ${room.description || 'áƒáƒ—áƒáƒ®áƒ˜áƒ¡ áƒáƒ¦áƒ¬áƒ”áƒ áƒ áƒáƒ  áƒáƒ áƒ˜áƒ¡.'}
                                </div>
                            </div>
                        </div>

                        <!-- Calendar Section -->
                        <div class="bg-gray-50/50 p-6 border-l border-gray-100">
                            <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">áƒáƒ˜áƒ áƒ©áƒ˜áƒ”áƒ— áƒáƒ”áƒ áƒ˜áƒáƒ“áƒ˜</h4>
                            <div id="calendar-${room.id}" class="mb-4">
                                ${renderMonthlyCalendar(room.id)}
                            </div>
                            <div class="flex justify-between items-center mb-4">
                                <div id="rangeText-${room.id}" class="text-xs font-bold text-gray-700">
                                    áƒ›áƒáƒœáƒ˜áƒ¨áƒœáƒ”áƒ— áƒ—áƒáƒ áƒ˜áƒ¦áƒ”áƒ‘áƒ˜
                                </div>
                                <button onclick="confirmRoomBooking('${room.id}')" 
                                        id="confirmBtn-${room.id}"
                                        class="bg-green-500 hover:bg-green-600 disabled:bg-gray-300 disabled:cursor-not-allowed text-white px-5 py-2 rounded-xl text-sm font-bold shadow-md transition-all active:scale-95"
                                        disabled>
                                    áƒ“áƒáƒ¯áƒáƒ•áƒ¨áƒœáƒ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        window.updateRoomHero = function (roomId, thumb) {
            const hero = document.getElementById(`hero-${roomId}`);
            hero.src = thumb.src;
            // Update border
            const parent = thumb.parentElement;
            parent.querySelectorAll('img').forEach(img => img.classList.remove('border-amber-500'));
            parent.querySelectorAll('img').forEach(img => img.classList.add('border-transparent'));
            thumb.classList.remove('border-transparent');
            thumb.classList.add('border-amber-500');
        };

        window.expandImage = function (src) {
            Swal.fire({
                imageUrl: src,
                imageAlt: 'Room Image',
                showConfirmButton: false,
                width: '80%',
                background: 'transparent',
                customClass: {
                    image: 'rounded-2xl shadow-2xl'
                }
            });
        };

        function renderMonthlyCalendar(roomId) {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();

            const firstDay = new Date(year, month, 1).getDay(); // 0 (Sun) - 6 (Sat)
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Adjust for Monday start (0: Mon, 6: Sun)
            let startOffset = (firstDay === 0) ? 6 : firstDay - 1;

            const days = [];

            // Header
            const weekDays = ['áƒ', 'áƒ¡', 'áƒ', 'áƒ®', 'áƒ', 'áƒ¨', 'áƒ™'];

            let html = `
                <div class="text-center font-bold text-xs text-indigo-600 mb-2 uppercase tracking-wide">
                    ${MONTHS[month]} ${year}
                </div>
                <div class="calendar-grid">
                    ${weekDays.map(d => `<div class="text-[10px] text-gray-300 font-bold text-center pb-2">${d}</div>`).join('')}
            `;

            const roomBookings = BSTATE.allBookings.filter(b => b.room_id == roomId);

            // Previous month empty slots
            for (let i = 0; i < startOffset; i++) {
                html += `<div class="calendar-day other-month"></div>`;
            }

            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const isBooked = roomBookings.some(b => dateStr >= b.start_date && dateStr <= b.end_date);
                const isToday = d === now.getDate();

                html += `
                    <div class="calendar-day ${isBooked ? 'booked' : ''} ${isToday ? 'today' : ''}" 
                         data-date="${dateStr}"
                         onclick="${isBooked ? '' : `handleDayClick('${roomId}', '${dateStr}')`}">
                        ${d}
                    </div>
                `;
            }

            html += `</div>`;
            return html;
        }

        window.handleDayClick = function (roomId, date) {
            if (!BSTATE.selections[roomId]) {
                BSTATE.selections[roomId] = { start: null, end: null };
            }

            const sel = BSTATE.selections[roomId];

            if (!sel.start || (sel.start && sel.end)) {
                // New selection
                sel.start = date;
                sel.end = null;
            } else if (sel.start && !sel.end) {
                if (date < sel.start) {
                    sel.start = date;
                } else if (date === sel.start) {
                    sel.start = null;
                } else {
                    // Check if any booked day is in between
                    if (isRangeBlocked(roomId, sel.start, date)) {
                        Swal.fire({
                            icon: 'warning',
                            title: 'áƒ¨áƒ”áƒ£áƒ«áƒšáƒ”áƒ‘áƒ”áƒšáƒ˜ áƒáƒ”áƒ áƒ˜áƒáƒ“áƒ˜',
                            text: 'áƒáƒ áƒ©áƒ”áƒ£áƒš áƒáƒ”áƒ áƒ˜áƒáƒ“áƒ¨áƒ˜ áƒáƒ áƒ˜áƒ¡ áƒ£áƒ™áƒ•áƒ” áƒ“áƒáƒ™áƒáƒ•áƒ”áƒ‘áƒ£áƒšáƒ˜ áƒ“áƒ¦áƒ”áƒ”áƒ‘áƒ˜.',
                            confirmButtonColor: '#111827'
                        });
                        return;
                    }
                    sel.end = date;
                }
            }

            updateCalendarUI(roomId);
        };

        function isRangeBlocked(roomId, start, end) {
            const roomBookings = BSTATE.allBookings.filter(b => b.room_id == roomId);
            return roomBookings.some(b => {
                // If a booking starts or ends or is within our selection
                return (b.start_date >= start && b.start_date <= end) ||
                    (b.end_date >= start && b.end_date <= end) ||
                    (start >= b.start_date && start <= b.end_date);
            });
        }

        function updateCalendarUI(roomId) {
            const container = document.getElementById(`calendar-${roomId}`);
            const sel = BSTATE.selections[roomId];
            const days = container.querySelectorAll('.calendar-day:not(.booked):not(.other-month)');

            days.forEach(day => {
                const d = day.getAttribute('data-date');
                day.classList.remove('selected', 'in-range');

                if (sel.start === d || sel.end === d) {
                    day.classList.add('selected');
                } else if (sel.start && sel.end && d > sel.start && d < sel.end) {
                    day.classList.add('in-range');
                }
            });

            const txt = document.getElementById(`rangeText-${roomId}`);
            const btn = document.getElementById(`confirmBtn-${roomId}`);

            if (sel.start && sel.end) {
                txt.innerText = `${sel.start} - ${sel.end}`;
                btn.disabled = false;
            } else if (sel.start) {
                txt.innerText = `áƒ›áƒáƒœáƒ˜áƒ¨áƒœáƒ”áƒ— áƒ“áƒáƒ¡áƒáƒ¡áƒ áƒ£áƒšáƒ˜`;
                btn.disabled = true;
            } else {
                txt.innerText = `áƒ›áƒáƒœáƒ˜áƒ¨áƒœáƒ”áƒ— áƒ—áƒáƒ áƒ˜áƒ¦áƒ”áƒ‘áƒ˜`;
                btn.disabled = true;
            }
        }

        window.confirmRoomBooking = async function (roomId) {
            const sel = BSTATE.selections[roomId];
            if (!sel.start || !sel.end) return;

            const { value: confirm } = await Swal.fire({
                title: 'áƒ“áƒáƒáƒ“áƒáƒ¡áƒ¢áƒ£áƒ áƒ”áƒ— áƒ¯áƒáƒ•áƒ¨áƒáƒœáƒ˜',
                text: `${sel.start}-áƒ“áƒáƒœ ${sel.end}-áƒ›áƒ“áƒ”`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'áƒ“áƒáƒ¡áƒ¢áƒ£áƒ áƒ˜',
                cancelButtonText: 'áƒ’áƒáƒ£áƒ¥áƒ›áƒ”áƒ‘áƒ',
                confirmButtonColor: '#22c55e',
                cancelButtonColor: '#6b7280'
            });

            if (!confirm) return;

            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (!session) {
                    Swal.fire({
                        title: 'áƒáƒ•áƒ¢áƒáƒ áƒ˜áƒ–áƒáƒªáƒ˜áƒ',
                        text: 'áƒ¯áƒáƒ•áƒ¨áƒœáƒ˜áƒ¡áƒ—áƒ•áƒ˜áƒ¡ áƒ¡áƒáƒ­áƒ˜áƒ áƒáƒ áƒ¡áƒ˜áƒ¡áƒ¢áƒ”áƒ›áƒáƒ¨áƒ˜ áƒ¨áƒ”áƒ¡áƒ•áƒšáƒ.',
                        icon: 'info',
                        showCancelButton: true,
                        confirmButtonText: 'áƒ¨áƒ”áƒ¡áƒ•áƒšáƒ',
                        cancelButtonText: 'áƒ’áƒáƒ£áƒ¥áƒ›áƒ”áƒ‘áƒ',
                        confirmButtonColor: '#2d78b1'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            window.location.href = 'index.html?auth=login';
                        }
                    });
                    return;
                }

                const { error } = await supabaseClient.from('bookings').insert({
                    property_id: GSTATE.property.id,
                    room_id: roomId,
                    start_date: sel.start,
                    end_date: sel.end,
                    user_id: session.user.id,
                    status: 'pending', // Default status
                    guest_name: session.user.user_metadata.full_name || session.user.email,
                    guest_phone: GSTATE.property.phone, // Or user phone if available
                    booking_code: 'BK' + Math.random().toString(36).substr(2, 6).toUpperCase()
                });

                if (error) throw error;

                await Swal.fire({
                    icon: 'success',
                    title: 'áƒ’áƒ˜áƒšáƒáƒªáƒáƒ•áƒ—!',
                    text: 'áƒ—áƒ¥áƒ•áƒ”áƒœáƒ˜ áƒ¯áƒáƒ•áƒ¨áƒáƒœáƒ˜ áƒ¬áƒáƒ áƒ›áƒáƒ¢áƒ”áƒ‘áƒ˜áƒ— áƒ’áƒáƒ˜áƒ’áƒ–áƒáƒ•áƒœáƒ. áƒ›áƒáƒ¡áƒáƒ˜áƒœáƒ«áƒ”áƒšáƒ˜ áƒ›áƒáƒšáƒ” áƒ“áƒáƒ’áƒ˜áƒ™áƒáƒ•áƒ¨áƒ˜áƒ áƒ“áƒ”áƒ‘áƒáƒ—.',
                    confirmButtonColor: '#22c55e'
                });

                closeBookingModal();
            } catch (err) {
                console.error(err);
                Swal.fire('áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ', 'áƒ¯áƒáƒ•áƒ¨áƒœáƒ˜áƒ¡ áƒ’áƒáƒ’áƒ–áƒáƒ•áƒœáƒ áƒ•áƒ”áƒ  áƒ›áƒáƒ®áƒ”áƒ áƒ®áƒ“áƒ: ' + err.message, 'error');
            }
        };

        document.addEventListener('click', (e) => {
            const d = document.getElementById('profileDropdown');
            const t = document.getElementById('profileTrigger');
            if (d && !d.classList.contains('hidden') && !d.contains(e.target) && (!t || !t.contains(e.target))) {
                d.classList.add('hidden');
            }
        });

        init();
    </script>
</body>

</html>