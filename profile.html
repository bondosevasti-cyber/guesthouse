<!DOCTYPE html>
<html lang="ka">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>მართვის პანელი - GeorgiaTravel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Georgian:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- FullCalendar -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <!-- Tippy.js -->
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/themes/light.css" />
    <!-- Flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
        body {
            font-family: 'Noto Sans Georgian', sans-serif;
        }

        /* Hide scrollbar for gallery */
        .hide-scroll::-webkit-scrollbar {
            display: none;
        }

        .hide-scroll {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">

    <!-- Navbar -->
    <!-- Navbar (Copied from index.html) -->
    <nav class="fixed top-0 left-0 w-full z-40 bg-white shadow-md py-3 transition-all duration-300" id="navbar">
        <div class="max-w-7xl mx-auto px-4 flex justify-between items-center">
            <a href="index.html">
                <img src="images/gh_logo.webp" alt="GeorgiaTravel"
                    class="h-10 max-h-[40px] w-auto drop-shadow-md object-contain cursor-pointer transition-transform hover:scale-105 active:scale-95">
            </a>
            <div class="flex items-center space-x-3">
                <!-- Auth Button / Dropdown Container -->
                <button id="navAuthBtn" onclick="window.location.href='index.html'"
                    class="bg-[#2d78b1] hover:bg-[#236a9e] text-white font-bold py-2 px-6 rounded-full transition-all shadow-sm">
                    მთავარი
                </button>
            </div>
        </div>
    </nav>
    <div class="h-20"></div> <!-- Spacer for fixed navbar -->

    <!-- Navigation Tabs -->
    <div class="max-w-7xl mx-auto px-4 mb-8">
        <div class="flex space-x-6 border-b border-gray-200">
            <button id="tabProp"
                class="pb-3 text-lg font-bold text-amber-600 border-b-2 border-amber-500 transition-colors cursor-default">
                ჩემი განცხადებები
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 pb-20">

        <!-- PROPERTIES TAB -->
        <div id="propertiesView">
            <!-- Header -->
            <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
                <div>
                    <!-- Title removed as it's in tabs now -->
                </div>
                <div class="flex-shrink-0">
                    <a href="add-property.html"
                        class="inline-flex items-center justify-center bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg shadow-amber-200 transition-all transform hover:-translate-y-0.5">
                        <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        ახალი განცხადება
                    </a>
                </div>
            </div>

            <!-- Status & Grid -->
            <div id="statusMessage" class="text-center py-20 text-gray-400 animate-pulse">
                ჯერ განცხადება არ არის...
            </div>

            <div id="listings-container" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Cards will be injected here -->
            </div>
        </div>

        <!-- BOOKINGS TAB REMOVED -->



        <!-- Booking Modal Removed -->

        <script>
            const CONFIG = {
                SUPABASE_URL: 'https://akmbyvovhubccznrzotv.supabase.co',
                SUPABASE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFrbWJ5dm92aHViY2N6bnJ6b3R2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3NTgwMTAsImV4cCI6MjA4MjMzNDAxMH0.oHLvbx5_4hYATF-hQkJvp0oxZ6ljUfGKYP-Mf7_CVtM'
            };

            const State = {
                supabase: supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY),
                user: null
            };

            let myProperties = [];

            async function init() {
                // Auth Listener
                State.supabase.auth.onAuthStateChange((event, session) => {
                    State.user = session ? session.user : null;
                    updateAuthUI();
                    if (event === 'SIGNED_OUT' || !session) window.location.href = 'index.html';
                });

                // Init Session Check
                const { data: { session } } = await State.supabase.auth.getSession();
                if (!session) {
                    window.location.href = 'index.html';
                    return;
                }
                State.user = session.user;
                updateAuthUI();
                loadUserListings();
            }

            async function loadUserListings() {
                try {
                    const { data, error } = await State.supabase
                        .from('guesthouse ge')
                        .select('*')
                        .eq('user_id', State.user.id)
                        .order('created_at', { ascending: false });

                    if (error) throw error;
                    myProperties = data || [];

                    const container = document.getElementById('listings-container');
                    const status = document.getElementById('statusMessage');

                    if (status) status.classList.add('hidden');
                    if (container) {
                        container.classList.remove('hidden');
                        if (myProperties.length === 0) {
                            container.innerHTML = `
                                <div class="col-span-full flex flex-col items-center justify-center py-20 bg-white rounded-3xl border-2 border-dashed border-gray-200">
                                    <h3 class="text-xl font-bold text-gray-900 mb-2">თქვენ ჯერ არ გაქვთ განცხადებები</h3>
                                    <p class="text-gray-500 mb-6 max-w-sm text-center">დაამატეთ ახალი განცხადება მთავარი გვერდიდან.</p>
                                    <a href="add-property.html" class="px-6 py-2 bg-amber-500 text-white rounded-xl font-bold">დამატება</a>
                                </div>`;
                        } else {
                            container.innerHTML = myProperties.map(createCardHTML).join('');
                        }
                    }
                } catch (err) {
                    console.error("Error loading listings:", err);
                }
            }

            // Helper to parsing prices
            function calculateCurrentPrice(p) {
                // Logic adapted from index.html normalizeProperty
                const currentMonthIndex = new Date().getMonth();
                let display = "შეთანხმებით";

                let seasonal = [];
                if (p.seasonal_prices) {
                    if (Array.isArray(p.seasonal_prices)) seasonal = p.seasonal_prices;
                    else if (typeof p.seasonal_prices === 'string') {
                        try { seasonal = JSON.parse(p.seasonal_prices); } catch (e) { }
                    }
                }

                if (seasonal.length > 0) {
                    const monthPrices = seasonal.map(s => s.prices[currentMonthIndex]).filter(price => price > 0);
                    if (monthPrices.length > 0) {
                        const minP = Math.min(...monthPrices);
                        const maxP = Math.max(...monthPrices);
                        display = minP === maxP ? `₾${minP}` : `₾${minP} - ₾${maxP}`;
                    }
                } else if (p.price) {
                    display = `₾${p.price}`;
                }
                return display;
            }

            function createCardHTML(p) {
                // 1. Image
                let image = "https://images.unsplash.com/photo-1566073771259-6a8506099945?w=500&q=80";
                if (p.images) {
                    let imgs = [];
                    if (Array.isArray(p.images)) imgs = p.images;
                    else if (typeof p.images === 'string') {
                        if (p.images.startsWith('{')) imgs = p.images.slice(1, -1).split(',');
                        else try { imgs = JSON.parse(p.images); } catch (e) { }
                    }
                    if (imgs.length > 0) image = imgs[0];
                }

                // 2. Price
                const priceDisplay = calculateCurrentPrice(p);

                // 3. Badges & Glow
                let badge = '';
                let glowClass = '';

                if (p.tier === 'super-vip') {
                    badge = '<span class="bg-gradient-to-r from-yellow-400 to-amber-500 text-white text-[10px] font-bold px-2 py-1 rounded shadow-sm uppercase tracking-wider ml-2 border border-white/20">SUPER VIP</span>';
                    glowClass = 'border-4 border-yellow-400 shadow-xl';
                } else if (p.tier === 'vip-plus') {
                    badge = '<span class="bg-indigo-600 text-white text-[10px] font-bold px-2 py-1 rounded shadow-sm uppercase tracking-wider ml-2">VIP +</span>';
                    glowClass = 'ring-4 ring-indigo-100 border-2 border-indigo-200 shadow-lg';
                } else if (p.tier === 'vip') {
                    badge = '<span class="bg-amber-500 text-white text-[10px] font-bold px-2 py-1 rounded shadow-sm uppercase tracking-wider ml-2">VIP</span>';
                    glowClass = 'border border-amber-200 shadow-md';
                }

                return `
                <div class="bg-white rounded-xl shadow-md hover:shadow-xl transition-all duration-300 overflow-hidden group ${glowClass} flex flex-col h-full">
                    <div class="relative h-48 overflow-hidden">
                        <img src="${image}" class="w-full h-full object-cover transform group-hover:scale-110 transition-transform duration-500">
                        <div class="absolute top-3 left-3 flex items-center">
                            <span class="bg-white/90 backdrop-blur-sm px-2 py-1 rounded-md text-xs font-bold text-gray-800 shadow-sm uppercase tracking-wide">${p.type}</span>
                            ${badge}
                        </div>
                        <div class="absolute bottom-3 right-3 bg-gray-900/80 backdrop-blur-sm text-white px-2 py-1 rounded-md text-sm font-bold flex items-center shadow-sm">
                             <span class="text-yellow-400 mr-1">★</span> ${p.rating || 5.0}
                        </div>
                    </div>
                    <div class="p-5 flex-1 flex flex-col">
                        <h3 class="font-bold text-lg text-gray-900 leading-tight mb-1 truncate group-hover:text-amber-600 transition-colors">${p.name}</h3>
                        <p class="text-sm text-gray-500 flex items-center mb-3">
                            <svg class="w-4 h-4 mr-1 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                            ${p.location}
                        </p>
                        <div class="flex justify-between items-center pt-3 border-t border-gray-100 mt-auto">
                           <div class="text-amber-600 font-bold text-xl">${priceDisplay}</div>
                        </div>
                        
                        <!-- Actions -->
                        <div class="grid grid-cols-2 gap-3 mt-4">
                            <a href="add-property.html?id=${p.id}" class="flex items-center justify-center px-4 py-2 border border-gray-200 rounded-lg text-sm font-bold text-gray-600 hover:bg-amber-50 hover:text-amber-600 hover:border-amber-200 transition-colors">
                                <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                                რედაქტირება
                            </a>
                            <button onclick="deleteProperty('${p.id}')" class="flex items-center justify-center px-4 py-2 border border-red-100 bg-red-50 rounded-lg text-sm font-bold text-red-600 hover:bg-red-100 hover:border-red-200 transition-colors">
                                <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                წაშლა
                            </button>
                        </div>
                    </div>
                </div>`;
            }

            // Sync Navbar UI
            function updateAuthUI() {
                const navBtn = document.getElementById('navAuthBtn');
                if (State.user) {
                    const avatarUrl = State.user.user_metadata.avatar_url || 'https://www.gravatar.com/avatar/?d=mp';
                    const name = State.user.user_metadata.full_name || 'მომხმარებელი';

                    const dropdownHTML = `
                        <div class="relative group" id="authDropdownContainer">
                            <button class="flex items-center space-x-2 focus:outline-none" id="userMenuBtn">
                                <img src="${avatarUrl}" class="w-10 h-10 rounded-full border-2 border-white shadow-md object-cover">
                                <span class="hidden md:block font-bold text-gray-700 text-sm">${name}</span>
                                <svg class="w-4 h-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </button>
                            <div class="absolute right-0 mt-2 w-56 pt-2">
                                <div class="bg-white rounded-xl shadow-xl border border-gray-100 overflow-hidden transform opacity-0 scale-95 pointer-events-none transition-all duration-200 z-50 origin-top-right group-hover:opacity-100 group-hover:scale-100 group-hover:pointer-events-auto">
                                    <div class="px-4 py-3 bg-gray-50 border-b border-gray-100">
                                        <p class="text-sm font-bold text-gray-900 truncate">${State.user.email}</p>
                                        <p class="text-xs text-green-600 font-medium">აქტიური</p>
                                    </div>
                                    <div class="py-1">
                                        <a href="profile.html" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-amber-50 hover:text-amber-600 transition-colors">
                                            <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                                            ჩემი განცხადებები
                                        </a>
                                        <a href="bookings.html" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 transition-colors">
                                            <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                                            ჯავშნები / კალენდარი
                                        </a>
                                    </div>
                                    <div class="border-t border-gray-100 py-1">
                                        <button onclick="handleLogout()" class="flex w-full items-center px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition-colors">
                                            <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"/></svg>
                                            გასვლა
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>`;

                    if (navBtn && navBtn.parentNode) {
                        navBtn.outerHTML = dropdownHTML;
                    }
                }
            }

            window.handleLogout = async function () {
                await State.supabase.auth.signOut();
            }

            window.deleteProperty = async function (id) {
                if (!confirm("ნამდვილად გსურთ წაშლა?")) return;
                try {
                    const { error } = await State.supabase.from('guesthouse ge').delete().eq('id', id);
                    if (error) throw error;
                    loadUserListings();
                } catch (e) {
                    alert('შეცდომა: ' + e.message);
                }
            }

            // Start
            init();
        </script>
</body>

</html>