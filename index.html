<!DOCTYPE html>
<html lang="ka">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeorgiaTravel - Booking Prototype</title>
    <link rel="icon" type="image/webp" href="images/gh_logo.webp">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Georgian:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <!-- Flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
        /* Flatpickr Customization */
        .flatpickr-day.prevMonthDay,
        .flatpickr-day.flatpickr-disabled,
        .flatpickr-day.flatpickr-disabled:hover {
            filter: grayscale(100%);
            opacity: 0.3;
            cursor: not-allowed;
            background: transparent;
            border-color: transparent;
        }

        .flatpickr-day.today {
            border: 2px solid #f97316 !important;
            color: #f97316 !important;
            background: transparent !important;
            font-weight: 700;
        }

        .flatpickr-day.today:hover {
            background: #f97316 !important;
            color: white !important;
        }

        body {
            font-family: 'Noto Sans Georgian', sans-serif;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        .hero-bg {
            background-image: linear-gradient(rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.4)), url('https://images.unsplash.com/photo-1565008576549-57569a49371d?q=80&w=2574&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        .fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .text-gradient {
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-image: linear-gradient(to right, #f59e0b, #fbbf24);
        }

        /* Modal Transitions */
        .modal-enter {
            opacity: 1 !important;
            transform: scale(1) !important;
        }

        .backdrop-enter {
            opacity: 1 !important;
        }

        .no-scroll {
            overflow: hidden;
        }

        .hide-scroll::-webkit-scrollbar {
            display: none;
        }

        .hide-scroll {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Auth specific overrides */
        .auth-tab-active {
            color: #f59e0b;
            border-bottom-color: #f59e0b;
        }

        .auth-tab-inactive {
            color: #6b7280;
            border-bottom-color: transparent;
        }

        /* Flag Wave Animation */
        @keyframes flagWave {
            0% {
                transform: rotate(0deg);
            }

            20% {
                transform: rotate(-5deg);
            }

            40% {
                transform: rotate(5deg);
            }

            60% {
                transform: rotate(-3deg);
            }

            80% {
                transform: rotate(3deg);
            }

            100% {
                transform: rotate(0deg);
            }
        }

        .animate-flag {
            animation: flagWave 2s infinite ease-in-out;
            transform-origin: top center;
        }

        /* Super VIP Golden Text */
        .super-vip-text {
            font-weight: 800;
            text-transform: uppercase;
            background: linear-gradient(to right, #BF953F 0%, #FCF6BA 25%, #B38728 50%, #FBF5B7 75%, #AA771C 100%);
            background-size: 200% auto;
            color: #b8860b;
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shine 3s linear infinite;
            filter: drop-shadow(0px 2px 2px rgba(0, 0, 0, 0.1));
        }

        @keyframes shine {
            to {
                background-position: 200% center;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-gray-50 min-h-screen">
    <div id="fb-root"></div>
    <script>
        window.fbAsyncInit = function () {
            FB.init({
                appId: '915840967780652',
                cookie: true,
                xfbml: true,
                version: 'v18.0'
            });
            FB.AppEvents.logPageView();

            // Check Facebook Login Status upon load
            FB.getLoginStatus(function (response) {
                statusChangeCallback(response);
            });
        };

        function statusChangeCallback(response) {
            console.log('Facebook Login Status:', response);
            if (response.status === 'connected') {
                console.log('User is connected to Facebook and your app.');
            } else if (response.status === 'not_authorized') {
                console.log('User is logged into Facebook but not your app.');
            } else {
                console.log('User is not logged into Facebook.');
            }
        }

        (function (d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) { return; }
            js = d.createElement(s); js.id = id;
            js.src = "https://connect.facebook.net/en_US/sdk.js";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));
    </script>

    <!-- Navbar -->
    <nav class="fixed top-0 left-0 w-full z-40 bg-white shadow-md py-3 transition-all duration-300" id="navbar">
        <div class="max-w-7xl mx-auto px-4 flex justify-between items-center">
            <img src="images/gh_logo.webp" alt="GeorgiaTravel" onclick="window.scrollTo({top: 0, behavior: 'smooth'})"
                class="h-10 max-h-[40px] w-auto drop-shadow-md object-contain cursor-pointer transition-transform hover:scale-105 active:scale-95">
            <div class="flex items-center space-x-3">
                <a href="pricing.html"
                    class="hidden md:flex items-center bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all animate-flag">
                    <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    ფასების ნახვა
                </a>
                <button onclick="openAddModal()"
                    class="bg-amber-500 hover:bg-amber-600 text-white font-bold p-2.5 rounded-full transition-all shadow-md hover:shadow-lg flex items-center justify-center transform hover:-translate-y-0.5"
                    title="დამატება">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                </button>
                <div id="navAuthBtnContainer">
                    <button id="navAuthBtn" onclick="openAuthModal('register')"
                        class="bg-[#2d78b1] hover:bg-[#236a9e] text-white font-bold py-2 px-6 rounded-full transition-all shadow-sm">
                        შესვლა
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <!-- Hero Section Wrapper -->
    <div class="relative min-h-[85vh] lg:h-[70vh] w-full">
        <!-- Layer 1: Background Image (Bottom) -->
        <div class="hero-bg absolute inset-0 w-full h-full z-0"></div>

        <!-- Layer 2: Content (Top) -->
        <div
            class="relative z-30 h-full w-full flex flex-col justify-center items-center px-4 pt-[160px] md:pt-16 pointer-events-none">

            <!-- Title Text -->
            <div class="text-center mb-8 fade-in pointer-events-auto">
                <h1 class="text-4xl md:text-6xl font-bold text-white mb-2 drop-shadow-md tracking-tight">GeorgiaTravel
                </h1>
                <p class="text-lg md:text-xl text-white/90 drop-shadow-sm font-medium">აღმოაჩინე შენი იდეალური
                    დასასვენებელი
                    ადგილი საქართველოში</p>
            </div>

            <!-- Search Interface -->
            <div
                class="glass-panel p-4 md:p-6 rounded-2xl w-full max-w-4xl grid grid-cols-1 md:grid-cols-12 gap-4 fade-in shadow-2xl pointer-events-auto">
                <!-- Location -->
                <div class="md:col-span-5 relative group z-[100]" id="locationDropdown">
                    <label for="locationInput"
                        class="block text-xs font-semibold text-white uppercase tracking-wider mb-1 ml-1 opacity-90">მდებარეობა</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                        </div>
                        <input type="text" id="locationInput"
                            class="block w-full pl-10 pr-3 py-3 border-none rounded-xl text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-amber-500 bg-white/95 hover:bg-white transition-colors cursor-pointer font-medium"
                            placeholder="აირჩიეთ ქალაქი..." readonly>
                    </div>
                    <div id="locationList"
                        class="absolute z-10 mt-1 w-full bg-white rounded-xl shadow-lg max-h-60 overflow-y-auto custom-scrollbar transform origin-top transition-all duration-300 ease-in-out opacity-0 scale-y-90 pointer-events-none -translate-y-2">
                        <div class="p-2">
                            <input type="text" id="locationSearch"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-amber-500"
                                placeholder="ძიება...">
                        </div>
                        <ul id="locationUL" class="py-1">
                            <!-- Locations will be injected here -->
                        </ul>
                    </div>
                </div>

                <!-- Type -->
                <div class="md:col-span-3 relative group z-[90]" id="typeDropdown">
                    <label
                        class="block text-xs font-semibold text-white uppercase tracking-wider mb-1 ml-1 opacity-90">ტიპი</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                            </svg>
                        </div>
                        <input type="text" id="typeInput" readonly placeholder="აირჩიე ტიპი"
                            class="w-full pl-10 pr-10 py-3 rounded-xl border-none focus:ring-0 cursor-pointer bg-white/90 backdrop-blur-sm text-gray-900 font-bold shadow-inner transition-all hover:bg-white truncate">
                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                            <svg class="h-4 w-4 text-gray-500 transition-transform duration-300 transform group-hover:rotate-180"
                                fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7" />
                            </svg>
                        </div>
                    </div>

                    <!-- Dropdown List -->
                    <ul id="typeList"
                        class="absolute z-50 w-full bg-white border border-gray-100 rounded-xl shadow-xl mt-2 max-h-60 overflow-y-auto custom-scrollbar transform origin-top transition-all duration-300 ease-in-out opacity-0 scale-y-90 pointer-events-none -translate-y-2">
                        <li class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-gray-900" data-value="">ყველა</li>
                        <li class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-gray-900" data-value="სასტუმრო">
                            სასტუმრო</li>
                        <li class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-gray-900"
                            data-value="საოჯახო სასტუმრო">საოჯახო სასტუმრო</li>
                        <li class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-gray-900" data-value="ბინა">ბინა</li>
                        <li class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-gray-900" data-value="კოტეჯი">კოტეჯი
                        </li>
                        <li class="px-4 py-2 hover:bg-gray-100 cursor-pointer text-gray-900" data-value="კერძო სახლი">
                            კერძო სახლი</li>
                    </ul>
                </div>

                <!-- Button (Visual) -->
                <div class="md:col-span-2 flex items-end mt-2 md:mt-0">
                    <button type="button" onclick="filterProperties()"
                        class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg transform transition hover:-translate-y-0.5">Live
                        Filter</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <main class="max-w-7xl mx-auto px-4 py-12 mt-12 md:-mt-20 relative z-10">
        <div id="resultsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- Cards injected here -->
        </div>

        <!-- Show More Button -->
        <div id="showMoreContainer" class="text-center mt-12 hidden">
            <button id="showMoreBtn"
                class="bg-white text-gray-800 border border-gray-200 font-bold py-3 px-8 rounded-full shadow-md hover:shadow-lg hover:border-amber-500 transition-all duration-300">
                მეტის ჩვენება (+<span id="remainingCount">0</span>)
            </button>
        </div>

        <!-- No Results -->
        <div id="noResults" class="hidden text-center py-20">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-100 mb-4">
                <svg class="w-8 h-8 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
            <h3 class="text-xl font-medium text-gray-900">ვერაფერი მოიძებნა</h3>
            <p class="text-gray-500 mt-1">სცადეთ შეცვალოთ ფილტრის პარამეტრები.</p>
        </div>
    </main>



    <!-- PROPERTY DETAIL MODAL -->
    <div id="propertyModal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
        <div id="modalBackdrop"
            class="absolute inset-0 bg-black/40 backdrop-blur-md opacity-0 transition-opacity duration-300"></div>
        <div class="absolute inset-0 z-10 flex justify-center items-center p-4 sm:p-6 pointer-events-none">
            <div id="modalContent"
                class="bg-white w-full max-w-5xl h-[85vh] rounded-[2rem] shadow-2xl overflow-hidden relative opacity-0 transform scale-95 transition-all duration-300 flex flex-col pointer-events-auto">
                <button onclick="closeModal()"
                    class="absolute top-4 right-4 z-20 bg-white/50 hover:bg-white text-gray-800 p-2 rounded-full backdrop-blur-md transition-colors">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                <div class="overflow-y-auto flex-grow custom-scrollbar">
                    <!-- Image Gallery Slider -->
                    <div class="relative h-64 md:h-96 w-full bg-gray-100 group">
                        <div id="modalGallery"
                            class="flex overflow-x-auto snap-x snap-mandatory w-full h-full scrollbar-hide">
                            <!-- Images injected here -->
                        </div>

                        <!-- Navigation Overlay (Optional, but scrolling is often enough for mobile) -->
                        <div
                            class="absolute inset-0 pointer-events-none flex justify-between items-center px-4 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button
                                onclick="document.getElementById('modalGallery').scrollBy({left: -300, behavior: 'smooth'})"
                                class="pointer-events-auto bg-black/50 text-white p-2 rounded-full hover:bg-black/70">
                                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15 19l-7-7 7-7" />
                                </svg>
                            </button>
                            <button
                                onclick="document.getElementById('modalGallery').scrollBy({left: 300, behavior: 'smooth'})"
                                class="pointer-events-auto bg-black/50 text-white p-2 rounded-full hover:bg-black/70">
                                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 5l7 7-7 7" />
                                </svg>
                            </button>
                        </div>

                        <div class="absolute bottom-6 left-6 md:left-10 text-white z-20 pointer-events-none">
                            <span id="modalTypeBadge"
                                class="bg-amber-500/90 backdrop-blur text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wide mb-2 inline-block shadow-sm">Hotel</span>
                            <h2 id="modalTitle" class="text-3xl md:text-5xl font-bold mb-1 drop-shadow-lg">Property Name
                            </h2>
                            <p id="modalLocation" class="flex items-center text-lg text-gray-100 drop-shadow-md">
                                <svg class="w-5 h-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                <span id="modalLocationText">Location</span>
                            </p>
                        </div>
                        <div
                            class="absolute inset-x-0 bottom-0 h-32 bg-gradient-to-t from-black/80 to-transparent pointer-events-none z-10">
                        </div>
                    </div>

                    <div class="px-6 py-8 md:px-10 grid grid-cols-1 lg:grid-cols-3 gap-10">
                        <div class="lg:col-span-2 space-y-8">
                            <!-- Dynamic Rooms Section -->
                            <div id="modalRoomSection" class="hidden fade-in">
                                <h3 class="text-xl font-bold text-gray-900 mb-3">აირჩიეთ ოთახი</h3>
                                <div id="modalRoomButtons" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
                            </div>

                            <div>
                                <h3 class="text-xl font-bold text-gray-900 mb-4">კეთილმოწყობა</h3>
                                <div id="modalAmenities" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-900 mb-3">აღწერა</h3>

                                <div id="modalDescription" class="text-gray-600 leading-relaxed text-lg"></div>

                                <!-- NEW: Room Tabs Container -->
                                <div class="mt-8 mb-6">
                                    <h3 class="text-lg font-bold text-gray-900 mb-4">დაათვალიერეთ სივრცეები</h3>
                                    <div class="flex space-x-2 overflow-x-auto pb-2 custom-scrollbar"
                                        id="roomTabsContainer"></div>
                                    <div id="activeRoomInfo" class="mt-3 hidden animate-fade-in">
                                        <div
                                            class="bg-amber-50 border border-amber-100 rounded-lg p-3 flex items-center text-amber-800 text-sm">
                                            <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24"
                                                stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M5 12h.01M12 12h.01M19 12h.01M6 21v-3a2 2 0 012-2h8a2 2 0 012 2v3M3 13h18l-1.5 8h-15L3 13zm8-5a4 4 0 100-8 4 4 0 000 8z" />
                                            </svg>
                                            <span id="roomBedInfo" class="font-bold"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-900 mb-4">სეზონური ფასები</h3>
                                <div
                                    class="bg-gray-50 rounded-2xl p-4 overflow-x-auto hide-scroll border border-gray-100">
                                    <div id="modalPricing" class="flex space-x-4 min-w-max"></div>
                                </div>
                            </div>
                        </div>
                        <div class="lg:col-span-1">
                            <div class="bg-gray-50 p-6 rounded-3xl border border-gray-100 sticky top-6">
                                <div class="flex items-center justify-between mb-6 border-b border-gray-200 pb-4">
                                    <div>
                                        <p class="text-sm text-gray-400 uppercase tracking-wider font-bold">1 ღამის ფასი
                                        </p>
                                        <p class="text-3xl font-bold text-gray-900" id="modalPrice">₾150</p>
                                    </div>
                                    <div class="flex items-center bg-white px-3 py-1 rounded-full shadow-sm">
                                        <span class="text-yellow-400 text-lg mr-1">★</span>
                                        <span class="font-bold text-gray-800" id="modalRating">4.8</span>
                                    </div>
                                </div>
                                <div class="space-y-3">
                                    <div class="flex items-center space-x-3 mb-4">
                                        <div class="w-12 h-12 bg-gray-200 rounded-full overflow-hidden">
                                            <img id="modalHostImage" src="" alt="Host"
                                                class="w-full h-full object-cover">
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-500">მასპინძელი</p>
                                            <p id="modalHostName" class="font-bold text-gray-900"></p>
                                        </div>
                                    </div>
                                    <button
                                        class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3.5 px-6 rounded-xl transition shadow-lg shadow-amber-200 flex items-center justify-center">
                                        <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                                        </svg>
                                        <span id="modalPhone">+995 555 00 11 22</span>
                                    </button>
                                    <!-- Calendar Container -->
                                    <div class="mb-4">
                                        <div id="bookingCalendar"
                                            class="w-full justify-center flex bg-gray-50 rounded-xl p-2 border border-gray-100">
                                        </div>
                                        <div class="flex justify-between items-center mt-2 px-2">
                                            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">არჩეული
                                                დღეები</p>
                                            <p id="selectedDaysText" class="text-amber-600 font-bold">0 ღამე</p>
                                        </div>
                                    </div>

                                    <button id="bookingSubmitBtn" onclick="handleBooking()"
                                        class="w-full bg-gray-900 hover:bg-black text-white font-bold py-3.5 px-6 rounded-xl transition shadow-lg flex items-center justify-center transform active:scale-95">
                                        დაჯავშნა
                                    </button>
                                    <p id="bookingStatus" class="mx-auto text-center text-sm font-bold mt-3 hidden"></p>
                                </div>
                                <p class="text-xs text-center text-gray-400 mt-4">გადახდა ხდება ადგილზე.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ADD PROPERTY MODAL -->
    <div id="addModal" class="fixed inset-0 z-[60] hidden" role="dialog" aria-modal="true">
        <div id="addBackdrop"
            class="absolute inset-0 bg-black/50 backdrop-blur-md opacity-0 transition-opacity duration-300">
        </div>
        <div class="absolute inset-0 flex justify-center items-center p-4 pointer-events-none">
            <div id="addContent"
                class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl p-6 relative opacity-0 transform scale-95 transition-all duration-300 pointer-events-auto max-h-[90vh] overflow-y-auto">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">ახალი განცხადების დამატება</h2>

                <form id="addPropertyForm" onsubmit="submitProperty(event)" class="space-y-4">
                    <!-- Name & Phone -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">სახელი</label>
                            <input type="text" id="addName" required
                                class="w-full px-4 py-2 border rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ტელეფონი</label>
                            <input type="text" id="addPhone" required placeholder="+995 ..."
                                class="w-full px-4 py-2 border rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none">
                        </div>
                    </div>

                    <!-- Location & Price Row -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">მდებარეობა</label>
                            <select id="addLocation" required
                                class="w-full px-4 py-2 border rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none bg-white">
                                <option value="">აირჩიეთ...</option>
                                <!-- Populated by JS -->
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ფასი (₾)</label>
                            <input type="number" id="addPrice" required min="1"
                                class="w-full px-4 py-2 border rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none">
                        </div>
                    </div>

                    <!-- Type & Tier Row -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ტიპი</label>
                            <select id="addType" required
                                class="w-full px-4 py-2 border rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none bg-white">
                                <option value="">აირჩიეთ...</option>
                                <option value="სასტუმრო">სასტუმრო</option>
                                <option value="საოჯახო სასტუმრო">საოჯახო სასტუმრო</option>
                                <option value="ბინა">ბინა</option>
                                <option value="კოტეჯი">კოტეჯი</option>
                                <option value="კერძო სახლი">კერძო სახლი</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">სტატუსი</label>
                            <select id="addTier" required
                                class="w-full px-4 py-2 border rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none bg-white">
                                <option value="regular">რეგულარული</option>
                                <option value="vip">VIP</option>
                                <option value="vip-plus">VIP +</option>
                                <option value="super-vip">SUPER VIP</option>
                            </select>
                        </div>
                    </div>

                    <!-- Description -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">აღწერა</label>
                        <textarea id="addDescription" required rows="3"
                            class="w-full px-4 py-2 border rounded-xl focus:ring-2 focus:ring-emerald-500 outline-none resize-none"></textarea>
                    </div>

                    <!-- Amenities Grid -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">კეთილმოწყობა</label>
                        <div id="addAmenitiesGrid" class="grid grid-cols-2 sm:grid-cols-4 gap-2">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- Seasonal Pricing Table -->
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <label class="block text-sm font-medium text-gray-700">სეზონური ფასები</label>
                            <button type="button" onclick="addSeasonalRow()"
                                class="text-xs bg-emerald-50 text-emerald-600 px-3 py-1 rounded-lg hover:bg-emerald-100 transition-colors font-medium">
                                + ოთახის დამატება
                            </button>
                        </div>
                        <div class="overflow-x-auto border border-gray-200 rounded-xl shadow-sm bg-white">
                            <table class="w-full text-sm text-center border-collapse">
                                <thead class="bg-gray-50 text-gray-500 font-medium text-xs uppercase">
                                    <tr>
                                        <th
                                            class="p-3 text-left min-w-[150px] sticky left-0 bg-gray-50 border-r border-gray-200 z-10">
                                            ოთახის ტიპი</th>
                                        <th class="p-2 w-10 bg-gray-50 border-r border-gray-200 z-10"
                                            title="ფასის გავრცელება">
                                            <svg class="w-4 h-4 mx-auto text-gray-400" fill="none" viewBox="0 0 24 24"
                                                stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M13 10V3L4 14h7v7l9-11h-7z" />
                                            </svg>
                                        </th>
                                        <th class="p-2 min-w-[60px]">იან</th>
                                        <th class="p-2 min-w-[60px]">თებ</th>
                                        <th class="p-2 min-w-[60px]">მარ</th>
                                        <th class="p-2 min-w-[60px]">აპრ</th>
                                        <th class="p-2 min-w-[60px]">მაი</th>
                                        <th class="p-2 min-w-[60px]">ივნ</th>
                                        <th class="p-2 min-w-[60px]">ივლ</th>
                                        <th class="p-2 min-w-[60px]">აგვ</th>
                                        <th class="p-2 min-w-[60px]">სექ</th>
                                        <th class="p-2 min-w-[60px]">ოქტ</th>
                                        <th class="p-2 min-w-[60px]">ნოე</th>
                                        <th class="p-2 min-w-[60px]">დეკ</th>
                                        <th class="p-2 min-w-[40px]"></th>
                                    </tr>
                                </thead>
                                <tbody id="seasonalPricesBody" class="divide-y divide-gray-100">
                                    <!-- Rows populated by JS -->
                                </tbody>
                            </table>
                        </div>
                        <p class="text-xs text-gray-400">მიუთითეთ ფასი თითოეული თვისთვის. ცარიელი უჯრები ჩაითვლება
                            საბაზისო ფასად.</p>
                    </div>

                    <!-- Multi-Image Upload -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">სურათები (მაქს. 30)</label>
                        <!-- Dynamic Image Grid -->
                        <div id="uploadGrid" class="grid grid-cols-3 sm:grid-cols-4 gap-2 mt-3 min-h-[100px]">
                            <!-- Add Button -->
                            <div id="uploadAddBtn" onclick="document.getElementById('addImages').click()"
                                class="aspect-square border-2 border-dashed border-gray-300 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:border-emerald-500 hover:bg-emerald-50 transition-all group">
                                <svg class="w-8 h-8 text-gray-400 group-hover:text-emerald-500 mb-1" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 4v16m8-8H4" />
                                </svg>
                                <span
                                    class="text-xs text-gray-500 font-medium group-hover:text-emerald-600">დამატება</span>
                            </div>
                            <!-- Thumbnails injected here -->
                        </div>
                        <input type="file" id="addImages" multiple accept="image/*" class="hidden"
                            onchange="handleImageSelection(this)">
                        <p class="text-xs text-gray-500 mt-2">მაქსიმუმ 30 სურათი.</p>
                    </div>

                    <!-- Buttons -->
                    <div class="flex justify-end space-x-3 pt-4 border-t mt-6">
                        <button type="button" onclick="closeAddModal()"
                            class="px-5 py-2 text-gray-600 font-medium hover:bg-gray-100 rounded-xl transition-colors">გაუქმება</button>
                        <button type="submit"
                            class="px-5 py-2 bg-emerald-500 text-white font-bold rounded-xl hover:bg-emerald-600 shadow-lg transition-transform transform active:scale-95">დამატება</button>
                    </div>
                </form>

                <button onclick="closeAddModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        //  CONFIGURATION & CONSTANTS
        // ==========================================
        const CONFIG = {
            SUPABASE_URL: 'https://akmbyvovhubccznrzotv.supabase.co',
            SUPABASE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFrbWJ5dm92aHViY2N6bnJ6b3R2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3NTgwMTAsImV4cCI6MjA4MjMzNDAxMH0.oHLvbx5_4hYATF-hQkJvp0oxZ6ljUfGKYP-Mf7_CVtM',
            DEFAULT_IMAGE: "https://images.unsplash.com/photo-1566073771259-6a8506099945?w=500&q=80",
            ITEMS_PER_PAGE: 15
        };

        const AMENITIES_DATA = [
            { key: "Wifi", label: "WiFi", iconPath: "M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0" },
            { key: "Tv", label: "ტელევიზორი", iconPath: "M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" },
            { key: "Snow", label: "კონდიციონერი", iconPath: "M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" },
            { key: "Flame", label: "გათბობა", iconPath: "M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z" },
            { key: "Parking", label: "პარკინგი", iconPath: "M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z" },
            { key: "Kitchen", label: "სამზარეულო", iconPath: "M3 3h18v18H3V3zm2 2v14h14V5H5zm2 2h10v2H7V7zm0 4h10v2H7v-2z" },
            { key: "Balcony", label: "აივანი", iconPath: "M3 3h18v18H3V3zm2 2v10h14V5H5zm2 12v2h10v-2H7z" },
            { key: "Pool", label: "აუზი", iconPath: "M6 3v12" }
        ];

        // ==========================================
        //  STATE MANAGEMENT
        // ==========================================
        const State = {
            supabase: null,
            user: null, // Track logged in user
            properties: [],
            filteredProperties: [],
            cities: [],
            visibleCount: CONFIG.ITEMS_PER_PAGE,
            pendingUploads: [], // Store processed image blobs
            currentGallery: [], // For fullscreen nav
            currentImageIndex: 0,
            filters: {
                location: '',
                type: ''
            }
        };

        // ==========================================
        //  DOM ELEMENTS
        // ==========================================
        const DOM = {
            navbar: document.getElementById('navbar'),
            // Filter Inputs
            locationInput: document.getElementById('locationInput'),
            locationList: document.getElementById('locationList'),
            locationUL: document.getElementById('locationUL'),
            locationSearch: document.getElementById('locationSearch'),
            locationDropdown: document.getElementById('locationDropdown'),
            typeInput: document.getElementById('typeInput'),
            typeList: document.getElementById('typeList'),
            typeDropdown: document.getElementById('typeDropdown'),
            // Results
            resultsGrid: document.getElementById('resultsGrid'),
            noResults: document.getElementById('noResults'),
            showMoreContainer: document.getElementById('showMoreContainer'),
            showMoreBtn: document.getElementById('showMoreBtn'),
            remainingCountSpan: document.getElementById('remainingCount'),
            // Modals
            propertyModal: document.getElementById('propertyModal'),
            modalBackdrop: document.getElementById('modalBackdrop'),
            modalContent: document.getElementById('modalContent'),
            addModal: document.getElementById('addModal'),
            addBackdrop: document.getElementById('addBackdrop'),
            addContent: document.getElementById('addContent'),
            addLocationSelect: document.getElementById('addLocation'),
            authModal: document.getElementById('authModal'),
            authBackdrop: document.getElementById('authBackdrop'),
            authContent: document.getElementById('authContent'),
            // Auth Tabs
            tabLogin: document.getElementById('tabLogin'),
            tabRegister: document.getElementById('tabRegister'),
            nameFieldContainer: document.getElementById('nameFieldContainer'),
            authSubmitText: document.getElementById('authSubmitText'),
            authFooterText: document.getElementById('authFooterText'),
            // Property Modal Detailed Elements
            mTitle: document.getElementById('modalTitle'),
            mImage: document.getElementById('modalImage'),
            mLocation: document.getElementById('modalLocation'),
            mPrice: document.getElementById('modalPrice'),
            mRating: document.getElementById('modalRating'),
            mDesc: document.getElementById('modalDescription'),
            mPhone: document.getElementById('modalPhone'),
            mBadge: document.getElementById('modalTypeBadge'),
            mAmenities: document.getElementById('modalAmenities'),
            mBadge: document.getElementById('modalTypeBadge'),
            mAmenities: document.getElementById('modalAmenities'),
            mPricing: document.getElementById('modalPricing'),
            mHostName: document.getElementById('modalHostName'),
            mHostImage: document.getElementById('modalHostImage')
        };



        // ==========================================
        //  DATA FETCHING
        // ==========================================
        async function fetchLocations() {
            // Hardcoded locations to prevent fetch errors
            const cities = [
                { name_ka: "თბილისი" }, { name_ka: "ბათუმი" }, { name_ka: "ქუთაისი" }, { name_ka: "რუსთავი" },
                { name_ka: "გორი" }, { name_ka: "ზუგდიდი" }, { name_ka: "ფოთი" }, { name_ka: "ქობულეთი" },
                { name_ka: "ხაშური" }, { name_ka: "სამტრედია" }, { name_ka: "სენაკი" }, { name_ka: "ზესტაფონი" },
                { name_ka: "მარნეული" }, { name_ka: "თელავი" }, { name_ka: "ახალციხე" }, { name_ka: "ოზურგეთი" },
                { name_ka: "კასპი" }, { name_ka: "ჭიათურა" }, { name_ka: "წყალტუბო" }, { name_ka: "საგარეჯო" },
                { name_ka: "გარდაბანი" }, { name_ka: "ბორჯომი" }, { name_ka: "ტყიბული" }, { name_ka: "ხონი" },
                { name_ka: "ბოლნისი" }, { name_ka: "ახალქალაქი" }, { name_ka: "გურჯაანი" }, { name_ka: "მცხეთა" },
                { name_ka: "ყვარელი" }, { name_ka: "ახმეტა" }, { name_ka: "ქარელი" }, { name_ka: "ლაგოდეხი" },
                { name_ka: "დედოფლისწყარო" }, { name_ka: "დუშეთი" }, { name_ka: "საჩხერე" }, { name_ka: "აბაშა" },
                { name_ka: "წნორი" }, { name_ka: "ნინოწმინდა" }, { name_ka: "თერჯოლა" }, { name_ka: "ხობი" },
                { name_ka: "მარტვილი" }, { name_ka: "ვალე" }, { name_ka: "ჯვარი" }, { name_ka: "ბაღდათი" },
                { name_ka: "ვანი" }, { name_ka: "თეთრიწყარო" }, { name_ka: "სნო" }, { name_ka: "სტეფანწმინდა" },
                { name_ka: "გუდაური" }, { name_ka: "ბაკურიანი" }, { name_ka: "მესტია" }, { name_ka: "სიღნაღი" },
                { name_ka: "ურეკი" }, { name_ka: "ანაკლია" }, { name_ka: "ბახმარო" }, { name_ka: "შოვი" },
                { name_ka: "საირმე" }, { name_ka: "აბასთუმანი" }, { name_ka: "სარფი" }, { name_ka: "გონიო" },
                { name_ka: "მწვანე კონცხი" }, { name_ka: "შეკვეთილი" }
            ];

            State.cities = cities.sort((a, b) => a.name_ka.localeCompare(b.name_ka));
            renderLocationList(State.cities);
            populateAddModalLocations();
        }

        // Helper for Image URLs
        function getFullImageUrl(path) {
            if (!path) return CONFIG.DEFAULT_IMAGE;
            if (path.startsWith('http') || path.startsWith('blob:')) return path;
            const { data } = State.supabase.storage.from('images').getPublicUrl(path);
            return data.publicUrl;
        }

        async function fetchProperties() {
            if (!State.supabase) {
                console.warn("Skipping fetch: Supabase not ready");
                return;
            }
            try {
                const { data, error } = await State.supabase
                    .from('guesthouse_ge')
                    .select('*, tier')
                    .eq('status', 'active');
                if (error) throw error;

                if (data) {
                    State.properties = data.map(normalizeProperty);
                    filterProperties(); // This calls render
                }
            } catch (error) {
                console.error('Error fetching properties:', error);
                DOM.resultsGrid.innerHTML = '<div class="col-span-full text-center text-red-500">მონაცემების ჩატვირთვა ვერ მოხერხდა.</div>';
            }
        }

        function normalizeProperty(p) {
            // Images Parsing
            let rawImages = [];
            if (p.images) {
                if (Array.isArray(p.images)) rawImages = p.images;
                else if (typeof p.images === 'string') {
                    try {
                        if (p.images.startsWith('{')) {
                            // Postgres array: {url1,url2}
                            rawImages = p.images.slice(1, -1).split(',');
                        } else {
                            // JSON: ["url1", "url2"]
                            rawImages = JSON.parse(p.images);
                        }
                    } catch (e) {
                        console.warn("Error parsing images:", e);
                        // Fallback
                        if (p.images.trim().length > 0) rawImages = [p.images];
                    }
                }
            }

            if (rawImages.length === 0 && p.image_url) {
                rawImages = [p.image_url];
            }

            // Convert to Full URLs
            const images = rawImages.map(img => {
                if (!img) return null;
                let clean = img.trim();
                // Remove quotes from postgres array parsing if simple split was used
                if ((clean.startsWith('"') && clean.endsWith('"')) || (clean.startsWith("'") && clean.endsWith("'"))) {
                    clean = clean.slice(1, -1);
                }
                return getFullImageUrl(clean);
            }).filter(Boolean);

            if (images.length === 0) images.push(CONFIG.DEFAULT_IMAGE);

            // Amenities
            let propAmenities = [];
            if (Array.isArray(p.amenities)) propAmenities = p.amenities;
            else if (typeof p.amenities === 'string') {
                try { propAmenities = JSON.parse(p.amenities); } catch (e) { }
            }

            // Seasonal Logic
            let seasonal = [];
            if (p.seasonal_prices) {
                if (Array.isArray(p.seasonal_prices)) seasonal = p.seasonal_prices;
                else if (typeof p.seasonal_prices === 'string') {
                    try { seasonal = JSON.parse(p.seasonal_prices); } catch (e) { }
                }
            }

            // Calculate Current Price Display
            const currentMonthIndex = new Date().getMonth();
            let currentPriceDisplay = "შეთანხმებით";

            if (p.price_display) {
                currentPriceDisplay = `₾${p.price_display}`;
            } else if (seasonal.length > 0) {
                const monthPrices = seasonal.map(s => s.prices[currentMonthIndex]).filter(p => p > 0);
                if (monthPrices.length > 0) {
                    const minP = Math.min(...monthPrices);
                    const maxP = Math.max(...monthPrices);
                    currentPriceDisplay = minP === maxP ? `₾${minP}` : `₾${minP} - ₾${maxP}`;
                }
            } else if (p.price) {
                currentPriceDisplay = `₾${p.price}`;
            }

            // Default Type Logic
            const houseType = p.type ? p.type : "Guesthouse";

            return {
                ...p,
                image: images[0],
                images: images,
                amenities: propAmenities,
                seasonal_prices: seasonal,
                currentPriceDisplay: currentPriceDisplay,
                tags: (houseType === "კოტეჯი" || houseType === "სასტუმრო") ? ["ხედი", "მთები"] : ["WiFi", "ცენტრი"],
                tier: p.tier || 'regular',
                rating: p.rating || 5.0,
                reviews: p.reviews || 0,
                description: p.description || `შესანიშნავი ${houseType} - ${p.name}`,
                phone: p.phone || "+995 555 000 000",
                type: houseType
            };
        }

        function generateMockPrices(base) {
            const months = ["იან", "თებ", "მარ", "აპრ", "მაი", "ივნ", "ივლ", "აგვ", "სექ", "ოქტ", "ნოე", "დეკ"];
            return months.map(m => ({
                month: m,
                price: Math.max(50, base + Math.floor(Math.random() * 40) - 20)
            }));
        }

        // ==========================================
        //  RENDERING & UI LOGIC
        // ==========================================
        function render() {
            const grid = DOM.resultsGrid;
            grid.innerHTML = '';

            if (State.filteredProperties.length === 0) {
                grid.classList.add('hidden');
                DOM.noResults.classList.remove('hidden');
                DOM.showMoreContainer.classList.add('hidden');
                return;
            }

            grid.classList.remove('hidden');
            DOM.noResults.classList.add('hidden');

            const toShow = State.filteredProperties.slice(0, State.visibleCount);
            toShow.forEach(prop => {
                grid.insertAdjacentHTML('beforeend', createCardHTML(prop));
            });

            const remaining = State.filteredProperties.length - State.visibleCount;
            if (remaining > 0) {
                DOM.showMoreContainer.classList.remove('hidden');
                DOM.remainingCountSpan.textContent = remaining;
            } else {
                DOM.showMoreContainer.classList.add('hidden');
            }
        }

        function createCardHTML(p) {
            // Updated Click handler to navigate to the new details page
            const clickAttr = `onclick="window.location.href='property-details.html?id=${p.id}'"`;

            let badge = '';
            if (p.tier === 'super_vip') {
                badge = '<span class="bg-gradient-to-r from-cyan-400 to-blue-600 text-white text-[10px] font-bold px-2.5 py-1 rounded-full shadow-lg uppercase tracking-wider ml-2 border border-white/20 animate-pulse">SUPER VIP</span>';
            } else if (p.tier === 'vip') {
                badge = '<span class="bg-gradient-to-r from-amber-400 to-orange-500 text-white text-[10px] font-bold px-2.5 py-1 rounded-full shadow-lg uppercase tracking-wider ml-2 border border-white/10">VIP</span>';
            }

            // Super VIP Layout (Featured)
            if (p.tier === 'super_vip') {
                return `
    <div ${clickAttr} class="col-span-1 sm:col-span-2 lg:col-span-3 bg-white rounded-3xl shadow-2xl overflow-hidden cursor-pointer group border-2 border-cyan-400 transform hover:scale-[1.01] transition-all duration-500 relative">
        <div class="flex flex-col md:flex-row h-full md:h-80 relative z-10">
            <div class="md:w-2/3 h-64 md:h-full relative overflow-hidden">
                <img src="${p.image || p.image_url}" class="w-full h-full object-cover transform group-hover:scale-110 transition-transform duration-1000">
                <div class="absolute top-5 left-5 flex items-center">
                    <span class="bg-white/95 backdrop-blur-md px-3 py-1.5 rounded-xl text-xs font-black text-gray-800 shadow-xl uppercase tracking-widest">${p.type}</span>
                    ${badge}
                </div>
            </div>
            <div class="md:w-1/3 p-8 flex flex-col justify-center bg-gradient-to-br from-white to-blue-50">
                <div class="flex items-center gap-1 mb-3 text-cyan-600 font-bold text-xs uppercase tracking-widest">
                    <span>✨ რჩეული განცხადება</span>
                </div>
                <h3 class="font-black text-3xl mb-2 text-gray-900 group-hover:text-blue-600 transition-colors leading-tight">${p.name}</h3>
                <p class="text-gray-500 mb-6 flex items-center font-medium">
                    <svg class="w-5 h-5 mr-1.5 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    ${p.location}
                </p>
                <div class="mt-auto flex items-end justify-between">
                    <div>
                        <p class="text-[10px] text-gray-400 font-bold uppercase tracking-tighter">ფასი იწყება</p>
                        <div class="text-blue-600 font-black text-3xl">${p.currentPriceDisplay}</div>
                    </div>
                    <span class="bg-blue-600 text-white p-3 rounded-2xl shadow-lg group-hover:translate-x-1 transition-transform">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/></svg>
                    </span>
                </div>
            </div>
        </div>
    </div>`;
            }

            // Standard / VIP Layout
            let glowClass = 'border border-gray-100 shadow-sm';
            if (p.tier === 'vip') glowClass = 'ring-2 ring-amber-100 border-2 border-amber-200 shadow-xl';

            return `
<div ${clickAttr} class="bg-white rounded-3xl ${glowClass} hover:shadow-2xl transition-all duration-500 overflow-hidden cursor-pointer group flex flex-col h-full">
    <div class="relative h-64 overflow-hidden">
        <img src="${p.image || p.image_url}" class="w-full h-full object-cover transform group-hover:scale-110 transition-transform duration-700">
        <div class="absolute top-4 left-4 flex items-center gap-2">
            <span class="bg-white/95 backdrop-blur-sm px-2.5 py-1.5 rounded-xl text-[10px] font-black text-gray-800 shadow-xl uppercase tracking-widest">${p.type}</span>
            ${badge}
        </div>
        <div class="absolute bottom-4 right-4 bg-white/90 backdrop-blur-sm px-2 py-1 rounded-lg text-xs font-bold flex items-center shadow-lg text-gray-900">
            <span class="text-amber-500 mr-1">★</span> ${p.rating}
        </div>
    </div>
    <div class="p-6 flex flex-col flex-grow">
        <h3 class="font-bold text-xl text-gray-900 leading-tight mb-2 group-hover:text-amber-600 transition-colors line-clamp-1">${p.name}</h3>
        <p class="text-sm text-gray-500 flex items-center mb-6 font-medium">
            <svg class="w-4 h-4 mr-1 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            ${p.location}
        </p>
        <div class="mt-auto flex justify-between items-center pt-4 border-t border-gray-50">
           <div>
               <p class="text-[10px] text-gray-400 font-bold uppercase tracking-tighter">ფასი</p>
               <div class="text-gray-900 font-black text-2xl">${p.currentPriceDisplay}</div>
           </div>
           <span class="w-10 h-10 bg-gray-50 rounded-xl flex items-center justify-center text-gray-400 group-hover:bg-amber-500 group-hover:text-white transition-all shadow-sm">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
           </span>
        </div>
    </div>
</div>`;
        }

        function renderLocationList(cities) {
            DOM.locationUL.innerHTML = '';
            const liAll = document.createElement('li');
            liAll.className = 'px-4 py-2 hover:bg-gray-100 cursor-pointer text-gray-900';
            liAll.textContent = "ყველა";
            liAll.dataset.value = "";
            liAll.onclick = () => selectLocation("", "ყველა");
            DOM.locationUL.appendChild(liAll);

            cities.forEach(city => {
                const li = document.createElement('li');
                li.className = 'px-4 py-2 hover:bg-gray-100 cursor-pointer text-gray-900';
                li.textContent = city.name_ka;
                li.dataset.value = city.name_ka;
                li.onclick = () => selectLocation(city.name_ka, city.name_ka);
                DOM.locationUL.appendChild(li);
            });
        }

        function populateAddModalLocations() {
            if (!DOM.addLocationSelect) return;
            DOM.addLocationSelect.innerHTML = '<option value="">აირჩიეთ...</option>';
            State.cities.forEach(city => {
                const option = document.createElement('option');
                option.value = city.name_ka;
                option.textContent = city.name_ka;
                DOM.addLocationSelect.appendChild(option);
            });
        }

        function populateAddModalAmenities() {
            const grid = document.getElementById('addAmenitiesGrid');
            if (!grid) return;
            grid.innerHTML = AMENITIES_DATA.map(a => `
                <label class="flex items-center space-x-2 cursor-pointer p-2 border rounded-lg hover:bg-gray-50 bg-white">
                    <input type="checkbox" name="amenities" value="${a.key}" class="form-checkbox text-emerald-500 rounded focus:ring-emerald-500">
                    <span class="text-xs font-medium text-gray-700 line-clamp-1" title="${a.label}">${a.label}</span>
                </label>
            `).join('');
        }

        function filterProperties() {
            const tierOrder = { 'super_vip': 0, 'vip-plus': 1, 'vip': 2, 'regular': 3 };

            State.filteredProperties = State.properties.filter(p => {
                const locMatch = !State.filters.location || p.location === State.filters.location;
                const typeMatch = !State.filters.type || p.type === State.filters.type;
                return locMatch && typeMatch;
            }).sort((a, b) => {
                const tierOrder = { 'super_vip': 0, 'vip-plus': 1, 'vip': 2, 'regular': 3 };
                const scoreA = tierOrder[a.tier] !== undefined ? tierOrder[a.tier] : 3;
                const scoreB = tierOrder[b.tier] !== undefined ? tierOrder[b.tier] : 3;

                if (scoreA !== scoreB) {
                    return scoreA - scoreB;
                }
                // Secondary sort: Newest first (assuming higher ID is newer)
                return (b.id || 0) - (a.id || 0);
            });

            State.visibleCount = CONFIG.ITEMS_PER_PAGE;
            render();
        }

        // ==========================================
        //  INTERACTIONS & HANDLERS
        // ==========================================
        function toggleDropdown(list, show) {
            if (show) {
                list.classList.remove('opacity-0', 'scale-y-90', 'pointer-events-none', '-translate-y-2', 'hidden');
                list.classList.add('opacity-100', 'scale-y-100', 'pointer-events-auto', 'translate-y-0');
            } else {
                list.classList.remove('opacity-100', 'scale-y-100', 'pointer-events-auto', 'translate-y-0');
                list.classList.add('opacity-0', 'scale-y-90', 'pointer-events-none', '-translate-y-2');
                // Optional: add 'hidden' after transition if needed, but keeping opacity transition is smoother
            }
        }

        function selectLocation(val, text) {
            State.filters.location = val;
            DOM.locationInput.value = text === "ყველა" ? "" : text;
            toggleDropdown(DOM.locationList, false);
            filterProperties();
        }

        function selectType(val, text) {
            State.filters.type = val;
            DOM.typeInput.value = val ? text : "";
            toggleDropdown(DOM.typeList, false);
            filterProperties();
        }

        // Initialize Calendar when modal opens
        let bookingCalendar;
        function initBookingCalendar() {
            if (bookingCalendar) return;
            const calendarEl = document.getElementById("bookingCalendar");
            if (!calendarEl) return;

            bookingCalendar = flatpickr(calendarEl, {
                mode: "range",
                inline: true,
                dateFormat: "Y-m-d",
                minDate: "today",
                locale: {
                    firstDayOfWeek: 1
                },
                onChange: function (selectedDates) {
                    const countEl = document.getElementById('selectedDaysText');
                    if (selectedDates.length === 2) {
                        const diff = Math.abs(selectedDates[1] - selectedDates[0]);
                        const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
                        if (countEl) countEl.textContent = days + " ღამე";
                    } else {
                        if (countEl) countEl.textContent = "0 ღამე";
                    }
                }
            });
        }

        // --- PROPERTY MODAL ---
        window.openModal = function (id) {
            const prop = State.properties.find(p => p.id === id);
            if (!prop) return;

            State.currentProperty = prop; // Save for booking
            configureModalContent(prop);
            DOM.propertyModal.classList.remove('hidden');
            setTimeout(() => {
                DOM.modalBackdrop.classList.remove('opacity-0');
                DOM.modalContent.classList.remove('opacity-0', 'scale-95');
                DOM.modalContent.classList.add('modal-enter');
                initBookingCalendar();
            }, 10);
            document.body.classList.add('no-scroll');
        };

        // Global Calendar Instance
        // let bookingCalendar; // Moved up

        window.closeModal = function () {
            DOM.modalBackdrop.classList.add('opacity-0');
            DOM.modalContent.classList.remove('modal-enter');
            DOM.modalContent.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                DOM.propertyModal.classList.add('hidden');
                document.body.classList.remove('no-scroll');
                if (bookingCalendar) bookingCalendar.clear();
            }, 300);
        };

        // Initialize Calendar when modal opens
        function initBookingCalendar() {
            if (bookingCalendar) return;
            bookingCalendar = flatpickr("#bookingCalendar", {
                mode: "range",
                inline: true,
                dateFormat: "Y-m-d",
                minDate: "today",
                locale: {
                    firstDayOfWeek: 1
                },
                onChange: function (selectedDates) {
                    const countEl = document.getElementById('selectedDaysText');
                    if (selectedDates.length === 2) {
                        const diff = Math.abs(selectedDates[1] - selectedDates[0]);
                        const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
                        countEl.textContent = days + " ღამე";
                    } else {
                        countEl.textContent = "0 ღამე";
                    }
                }
            });
        }

        // Hook into openModal to init calendar
        const originalOpenModal = window.openModal;
        window.openModal = function (id) {
            originalOpenModal(id);
            setTimeout(initBookingCalendar, 50);
        }

        // --- BOOKING LOGIC ---
        window.handleBooking = async function () {
            const btn = document.getElementById('bookingSubmitBtn');
            const statusEl = document.getElementById('bookingStatus');

            // 1. Auth Check
            if (!State.user) {
                window.location.href = 'auth.html';
                return;
            }

            // 2. Validation
            const selectedDates = bookingCalendar.selectedDates;
            if (selectedDates.length !== 2) {
                alert("გთხოვთ მონიშნოთ შესვლის და გასვლის თარიღები");
                return;
            }

            // Format Dates
            const checkIn = flatpickr.formatDate(selectedDates[0], "Y-m-d");
            const checkOut = flatpickr.formatDate(selectedDates[1], "Y-m-d");

            // 3. Prepare Data
            const prop = State.currentProperty;
            // Parse price from display (e.g. "150₾" -> 150)
            const priceText = document.getElementById('modalPrice').textContent.replace(/[^0-9.]/g, '');
            const pricePerNight = parseFloat(priceText) || 0;

            const oneDay = 24 * 60 * 60 * 1000;
            const diffDays = Math.round(Math.abs((new Date(checkOut) - new Date(checkIn)) / oneDay));
            const totalPrice = pricePerNight * diffDays;

            if (totalPrice <= 0) {
                alert("ფასის გამოთვლა ვერ მოხერხდა");
                return;
            }

            // 4. UI Loading
            const originalText = btn.innerHTML;
            btn.innerHTML = `<svg class="animate-spin h-5 w-5 mr-2" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> მუშავდება...`;
            btn.disabled = true;
            statusEl.className = "text-center text-sm font-bold mt-3 hidden";

            try {
                // 5. Insert to Supabase (Webhook will handle notification)
                const bookingCode = '#' + 'BK-' + Math.floor(10000 + Math.random() * 90000);

                const bookingData = {
                    property_id: prop.id,
                    room_id: State.selectedRoom ? State.selectedRoom.id : null,
                    check_in: checkIn,
                    check_out: checkOut,
                    guest_name: State.user.user_metadata.full_name || State.user.user_metadata.first_name || 'Guest',
                    guest_phone: State.user.user_metadata.phone || prop.phone,
                    total_price: totalPrice,
                    status: 'pending',
                    user_id: State.user.id,
                    booking_code: bookingCode
                };

                const { error } = await State.supabase
                    .from('bookings')
                    .insert([bookingData]);

                if (error) throw error;

                // 6. Success UI
                statusEl.textContent = "ჯავშანი მიღებულია! მფლობელი დაგიკავშირდებათ";
                statusEl.className = "text-center text-sm font-bold mt-3 text-emerald-600 block";
                btn.innerHTML = `<svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg> დაჯავშნილია`;

                // Reset after delay
                setTimeout(() => {
                    closeModal();
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    statusEl.classList.add('hidden');
                    if (bookingCalendar) bookingCalendar.clear();
                }, 3000);

            } catch (err) {
                console.error("Booking Error:", err);
                statusEl.textContent = "შეცდომა: " + err.message;
                statusEl.className = "text-center text-sm font-bold mt-3 text-red-500 block";
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        // --- FULLSCREEN MODAL ---
        // --- FULLSCREEN MODAL ---
        window.openFullscreen = function (index) {
            const modal = document.getElementById('fullscreenModal');
            const img = document.getElementById('fullscreenImage');
            if (!modal || !img) return;

            State.currentImageIndex = index;
            updateFullscreenImage();

            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
            }, 10);

            // Add keyboard listener
            document.addEventListener('keydown', handleFullscreenKeydown);
        };

        window.closeFullscreen = function () {
            const modal = document.getElementById('fullscreenModal');
            if (!modal) return;

            modal.classList.add('opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                document.getElementById('fullscreenImage').src = '';
            }, 300);

            // Remove keyboard listener
            document.removeEventListener('keydown', handleFullscreenKeydown);
        };

        function handleFullscreenKeydown(e) {
            if (e.key === 'ArrowLeft') navigateFullscreen(-1);
            if (e.key === 'ArrowRight') navigateFullscreen(1);
            if (e.key === 'Escape') closeFullscreen();
        }

        window.navigateFullscreen = function (step, event) {
            if (event) event.stopPropagation();
            const newIndex = State.currentImageIndex + step;
            if (newIndex >= 0 && newIndex < State.currentGallery.length) {
                State.currentImageIndex = newIndex;
                updateFullscreenImage();
            }
        };

        function updateFullscreenImage() {
            const img = document.getElementById('fullscreenImage');
            const url = State.currentGallery[State.currentImageIndex];
            if (img && url) {
                // simple fade effect could be added here
                img.style.opacity = '0.5';
                img.src = url;
                setTimeout(() => img.style.opacity = '1', 150);

                // Update nav buttons visibility
                const prev = document.getElementById('fsPrev');
                const next = document.getElementById('fsNext');
                if (prev) prev.style.display = State.currentImageIndex > 0 ? 'block' : 'none';
                if (next) next.style.display = State.currentImageIndex < State.currentGallery.length - 1 ? 'block' : 'none';

                // Update Counter
                const counter = document.getElementById('fsCounter');
                if (counter) {
                    counter.textContent = `${State.currentImageIndex + 1} / ${State.currentGallery.length}`;
                }
            }
        }

        // Swipe Support
        let touchStartX = 0;
        let touchEndX = 0;

        function initSwipeGestures() {
            const modal = document.getElementById('fullscreenModal');
            if (!modal) return;

            modal.addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
            }, { passive: true });

            modal.addEventListener('touchend', e => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            }, { passive: true });
        }

        function handleSwipe() {
            const diff = touchStartX - touchEndX;
            if (Math.abs(diff) > 50) { // Threshold
                if (diff > 0) {
                    // Swipe Left -> Next
                    navigateFullscreen(1);
                } else {
                    // Swipe Right -> Prev
                    navigateFullscreen(-1);
                }
            }
        }

        // Call init once
        document.addEventListener('DOMContentLoaded', initSwipeGestures);

        // Helper to render gallery
        function renderGallery(images) {
            const gallery = document.getElementById('modalGallery');
            if (!gallery) return;

            State.currentGallery = images;
            gallery.innerHTML = images.map((imgUrl, index) => `
                <div class="min-w-full h-full snap-center relative group/img">
                    <img src="${imgUrl}" class="w-full h-full object-cover" alt="Gallery Image ${index + 1}">
                    <button onclick="openFullscreen(${index})" class="absolute bottom-4 right-4 bg-black/50 hover:bg-black/70 text-white p-2 rounded-lg backdrop-blur-sm opacity-0 group-hover/img:opacity-100 transition-opacity duration-300">
                         <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        async function configureModalContent(prop) {
            DOM.mTitle.style.display = 'none';

            const locationText = document.getElementById('modalLocationText');
            if (locationText) locationText.textContent = `${prop.location}, საქართველო`;

            DOM.mPrice.textContent = prop.currentPriceDisplay;
            DOM.mRating.textContent = prop.rating;
            DOM.mDesc.textContent = prop.description || prop.name;
            DOM.mPhone.textContent = prop.phone || "+995 555 000 000";
            DOM.mBadge.textContent = prop.type;

            // Host Info
            if (DOM.mHostName) {
                DOM.mHostName.textContent = prop.host_name || (prop.name ? prop.name.split(' ')[0] + " Host" : "Host");
            }
            if (DOM.mHostImage) DOM.mHostImage.src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${prop.id}`;

            // Reset Room Section (Legacy)
            const roomSection = document.getElementById('modalRoomSection');
            if (roomSection) roomSection.classList.add('hidden'); // Hide old section if present


            // Render Default Gallery immediately
            renderGallery(prop.images || [CONFIG.DEFAULT_IMAGE]);

            // Fetch & Render Rooms
            try {
                // If rooms are not passed in prop (dependent on how we call it), fetch them.
                let rooms = prop.rooms;
                if (!rooms) {
                    const { data } = await State.supabase
                        .from('rooms')
                        .select('*')
                        .eq('property_id', prop.id);
                    rooms = data || [];
                }

                initRoomTabs(prop, rooms);

            } catch (err) {
                console.error("Error fetching rooms:", err);
            }

            // --- FUNCTION DEFINITIONS INSIDE SCOPE ---

            function initRoomTabs(property, rooms) {
                // VIpოვოთ სად ჩავსვათ: ვეძებთ "კეთილმოწყობის" სექციას
                const allElements = document.querySelectorAll('h2, h3, label, div');
                let amenitiesHeader = null;

                for (const el of allElements) {
                    if (el.textContent && (el.textContent.includes('კეთილმოწყობა') || el.textContent.includes('კომფორტი'))) {
                        amenitiesHeader = el.closest('div'); // ვიღებთ მშობელ დივს უსაფრთხოებისთვის
                        break;
                    }
                }

                // Fallback if not found inside modal (restrict search if possible, but user provided generic selector)
                // Let's refine search to be inside the modal to avoid false positives
                if (!amenitiesHeader) {
                    const modal = document.getElementById('propertyModal');
                    if (modal) {
                        // Fallback: append to description container if standard header not found
                        amenitiesHeader = modal.querySelector('.description-container');
                    }
                }

                // შევქმნათ ტაბების კონტეინერი
                let section = document.getElementById('roomTabsSection');
                if (!section) {
                    section = document.createElement('div');
                    section.id = 'roomTabsSection';
                    section.className = 'mb-8 mt-6';

                    // ჩავსვათ კეთილმოწყობის წინ
                    if (amenitiesHeader && amenitiesHeader.parentNode) {
                        amenitiesHeader.parentNode.insertBefore(section, amenitiesHeader);
                    } else {
                        // Absolute fallback
                        const dest = document.querySelector('#modalAmenitiesGrid')?.parentElement;
                        if (dest) dest.parentNode.insertBefore(section, dest);
                    }
                }

                // თუ ოთახები არ არის, არაფერს ვაკეთებთ (ან ვმალავთ თუ უკვე არსებობს)
                if (!rooms || rooms.length === 0) {
                    section.style.display = 'none';
                    return;
                }
                section.style.display = 'block';

                // HTML-ის გენერაცია
                section.innerHTML = `
                    <h3 class="text-lg font-bold text-gray-900 mb-3 flex items-center">
                        <span class="bg-amber-100 text-amber-600 p-1 rounded mr-2">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                        </span>
                        დაათვალიერეთ სივრცეები
                    </h3>
                    <div class="flex space-x-2 overflow-x-auto pb-2 custom-scrollbar" id="tabsContainer">
                    </div>
                    <div id="roomInfoDisplay" class="hidden mt-3 bg-gray-50 border border-gray-100 rounded-xl p-4 animate-fade-in"></div>
                `;

                const container = section.querySelector('#tabsContainer');

                // 1. მთავარი ღილაკი (გარე ვიზუალი)
                const mainBtn = document.createElement('button');
                mainBtn.className = 'tab-btn active px-5 py-2.5 bg-gray-900 text-white rounded-full text-sm font-bold shadow-lg transform transition-all hover:-translate-y-0.5';
                mainBtn.innerHTML = '🏡 გარე ვიზუალი';
                mainBtn.onclick = () => switchGalleryView('main', property.images, null, mainBtn);
                container.appendChild(mainBtn);

                // 2. ოთახების ღილაკები
                rooms.sort((a, b) => a.created_at?.localeCompare(b.created_at)); // სორტირება
                rooms.forEach(room => {
                    const btn = document.createElement('button');
                    btn.className = 'tab-btn px-5 py-2.5 bg-white text-gray-600 border border-gray-200 rounded-full text-sm font-bold shadow-sm hover:bg-gray-50 transition-all whitespace-nowrap';
                    btn.innerHTML = `🛏️ ${room.name}`;

                    // Prepare images for room
                    let rImages = [];
                    if (room.images && Array.isArray(room.images) && room.images.length > 0) rImages = room.images;
                    else if (room.image_url) rImages = [room.image_url];
                    else rImages = [CONFIG.DEFAULT_IMAGE];

                    btn.onclick = () => switchGalleryView('room', rImages, room, btn);
                    container.appendChild(btn);
                });

                // შევინახოთ მთავარი სურათები გლობალურად
                window.mainPropertyImages = property.images || [CONFIG.DEFAULT_IMAGE];
                window.defaultImages = window.mainPropertyImages;
            }

            window.switchGalleryView = function (type, images, roomData, btn) {
                // ღილაკების სტილები
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.className = 'tab-btn px-5 py-2.5 bg-white text-gray-600 border border-gray-200 rounded-full text-sm font-bold shadow-sm hover:bg-gray-50 transition-all whitespace-nowrap';
                });
                btn.className = 'tab-btn active px-5 py-2.5 bg-gray-900 text-white rounded-full text-sm font-bold shadow-lg transform transition-all hover:-translate-y-0.5';

                // სურათების შეცვლა
                if (window.renderGallery) {
                    window.renderGallery(images || []);
                } else {
                    console.error("renderGallery function not found!");
                }

                // ოთახის ინფოს ჩვენება/დამალვა
                const infoBox = document.getElementById('roomInfoDisplay');
                if (!infoBox) return;

                if (type === 'room' && roomData) {
                    infoBox.classList.remove('hidden');
                    infoBox.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-bold text-gray-900 text-lg">${roomData.name}</h4>
                                <p class="text-sm text-gray-500 flex items-center mt-1">
                                    <svg class="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h.01M12 12h.01M19 12h.01M6 21v-3a2 2 0 012-2h8a2 2 0 012 2v3M3 13h18l-1.5 8h-15L3 13zm8-5a4 4 0 100-8 4 4 0 000 8z" /></svg>
                                    ${roomData.beds} საწოლი
                                </p>
                            </div>
                        </div>
                    `;
                } else {
                    infoBox.classList.add('hidden');
                }
            }


            // Amenities
            const amenityIcons = {
                'WiFi': '<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0" /></svg>',
                'პარკინგი': '<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" /></svg>',
                'აუზი': '<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>',
                'საუზმე': '<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>',
                'ბუხარი': '<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z" /></svg>',
                'ხედი': '<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>'
            };

            DOM.mAmenities.innerHTML = prop.amenities.map(am => {
                const label = typeof am === 'object' ? am.label : am;
                const key = typeof am === 'object' ? am.key : am;

                return `
                <div class="flex flex-col items-center justify-center p-3 bg-gray-50 rounded-xl">
                    <div class="w-10 h-10 bg-emerald-100 rounded-full flex items-center justify-center text-emerald-600 mb-2">
                        ${amenityIcons[key] || '<svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>'}
                    </div>
                    <span class="text-xs font-medium text-gray-700">${label}</span>
                </div>`;
            }).join('');

            // Seasonal Prices Table
            if (prop.seasonal_prices && prop.seasonal_prices.length > 0) {
                const months = ['იან', 'თებ', 'მარ', 'აპრ', 'მაი', 'ივნ', 'ივლ', 'აგვ', 'სექ', 'ოქტ', 'ნოე', 'დეკ'];
                const currentMonthIndex = new Date().getMonth();

                DOM.mPricing.innerHTML = `
                    <div class="w-full overflow-x-auto border border-gray-100 rounded-xl shadow-sm bg-white">
                        <table class="w-full text-sm text-center">
                            <thead class="bg-gray-50 text-gray-500 font-medium text-xs uppercase">
                                <tr>
                                    <th class="p-3 text-left sticky left-0 bg-gray-50 border-r border-gray-100 z-10 min-w-[120px]">ოთახის ტიპი</th>
                                    ${months.map((m, i) => `<th class="p-2 min-w-[60px] ${i === currentMonthIndex ? 'text-emerald-600 bg-emerald-50' : ''}">${m}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                ${prop.seasonal_prices.map(row => `
                                    <tr class="hover:bg-gray-50">
                                        <td class="p-3 text-left font-medium text-gray-800 sticky left-0 bg-white border-r border-gray-100 z-10">${row.label}</td>
                                        ${row.prices.map((price, i) => `
                                            <td class="p-2 ${i === currentMonthIndex ? 'bg-emerald-50/50 font-bold text-emerald-700' : 'text-gray-600'}">
                                                ${price > 0 ? price : '-'}
                                            </td>
                                        `).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                DOM.mPricing.innerHTML = `<p class="text-center text-gray-400 text-sm py-4">სეზონური ფასები არ არის მითითებული</p>`;
            }
        }

        // --- ADD MODAL ---
        // --- ADD MODAL ---
        window.openAddModal = function () {
            // If user is logged in -> Redirect to Add Property Page
            if (State.user) {
                window.location.href = 'add-property.html';
            } else {
                // Not logged in -> Show Bridge Modal (Pre-Auth)
                const preModal = document.getElementById('preAuthModal');
                if (preModal) {
                    preModal.classList.remove('hidden');
                    setTimeout(() => {
                        preModal.querySelector('div[class*="transform"]').classList.remove('opacity-0', 'scale-95');
                        preModal.querySelector('div[class*="transform"]').classList.add('opacity-100', 'scale-100');
                    }, 10);
                }
            }
        };

        window.closePreAuthModal = function () {
            const preModal = document.getElementById('preAuthModal');
            if (preModal) {
                const content = preModal.querySelector('div[class*="transform"]');
                content.classList.remove('opacity-100', 'scale-100');
                content.classList.add('opacity-0', 'scale-95');
                setTimeout(() => {
                    preModal.classList.add('hidden');
                }, 300);
            }
        };

        window.openAuthFromPre = function () {
            closePreAuthModal();
            setTimeout(() => {
                openAuthModal('register');
            }, 300);
        };

        window.closeAddModal = function () {
            DOM.addBackdrop.classList.add('opacity-0');
            DOM.addContent.classList.remove('modal-enter');
            DOM.addContent.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                DOM.addModal.classList.add('hidden');
                document.body.classList.remove('no-scroll');
                // Clear state and UI
                State.pendingUploads = [];
                renderUploadGrid();
            }, 300);
        };

        // --- IMAGE PROCESSING ---
        // --- IMAGE PROCESSING & GRID ---
        window.handleImageSelection = async function (input) {
            const files = Array.from(input.files);
            if (!files.length) return;

            // Process each file
            for (const file of files) {
                if (State.pendingUploads.length >= 30) {
                    alert("max 30 images allowed");
                    break;
                }
                try {
                    const processed = await processImage(file);
                    State.pendingUploads.push(processed);
                } catch (error) {
                    console.error("Image processing failed:", error);
                    alert(`Skipped ${file.name}: ${error.message}`);
                }
            }

            input.value = ''; // Reset input to allow re-selecting same file
            renderUploadGrid();
        };

        function renderUploadGrid() {
            const grid = document.getElementById('uploadGrid');
            const addButton = document.getElementById('uploadAddBtn');
            if (!grid || !addButton) return;

            // Clear grid but keep reference to everything? No, easiest is to detach button, clear, then re-append.
            // But we must be careful not to lose the event listeners on the button if any (onclick is inline, so fine).

            // 1. Detach Add Button
            addButton.remove();

            // 2. Clear Grid HTML (removes old images)
            grid.innerHTML = '';

            // 3. Render Images
            State.pendingUploads.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = "relative aspect-square rounded-xl overflow-hidden shadow-sm border border-gray-200 group animate-fade-in";

                // Image
                const img = document.createElement('img');
                img.src = URL.createObjectURL(item.blob);
                img.className = "w-full h-full object-cover";

                // Delete Button
                const delBtn = document.createElement('button');
                delBtn.className = "absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 shadow-md opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600 focus:outline-none";
                delBtn.innerHTML = `<svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>`;
                delBtn.type = "button"; // Prevent form submit
                delBtn.onclick = (e) => {
                    e.stopPropagation();
                    removeImage(index);
                };

                // Size Badge
                const sizeBadge = document.createElement('div');
                sizeBadge.className = "absolute bottom-1 left-1 bg-black/50 backdrop-blur-sm text-white text-[10px] px-1.5 py-0.5 rounded opacity-0 group-hover:opacity-100 transition-opacity";
                sizeBadge.textContent = `${(item.blob.size / 1024).toFixed(0)}KB`;

                div.appendChild(img);
                div.appendChild(delBtn);
                div.appendChild(sizeBadge);

                grid.appendChild(div);
            });

            // 4. Re-append Add Button if limit not reached
            if (State.pendingUploads.length < 30) {
                addButton.classList.remove('hidden');
                grid.appendChild(addButton);
            } else {
                // If limit reached, we can either hide it or just not append it.
                // Better to append and hide, or just hide if it's external? 
                // It's inside the grid. So we must append it to keep it in DOM for next time?
                // Actually, if we remove() it, and don't append, it's GONE from DOM.
                // We must append it but hide it.
                addButton.classList.add('hidden');
                grid.appendChild(addButton);
            }
        }

        window.removeImage = function (index) {
            State.pendingUploads.splice(index, 1);
            renderUploadGrid();
        };

        function processImage(file) {
            return new Promise((resolve, reject) => {
                const MAX_WIDTH = 1920;
                const MAX_SIZE_MB = 5;
                const ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/webp'];

                if (!ALLOWED_TYPES.includes(file.type)) {
                    reject(new Error("არასწორი ფაილის ტიპი"));
                    return;
                }

                const img = new Image();
                img.src = URL.createObjectURL(file);

                img.onload = () => {
                    URL.revokeObjectURL(img.src);
                    let width = img.width;
                    let height = img.height;

                    // Resize logic
                    if (width > MAX_WIDTH) {
                        height = Math.round(height * (MAX_WIDTH / width));
                        width = MAX_WIDTH;
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // Convert to WebP with compression
                    canvas.toBlob((blob) => {
                        if (!blob) {
                            reject(new Error("კონვერტაცია ვერ მოხერხდა"));
                            return;
                        }

                        if (blob.size > MAX_SIZE_MB * 1024 * 1024) {
                            reject(new Error(`ფაილი დიდია (${(blob.size / 1024 / 1024).toFixed(2)}MB). მაქსიმუმი: ${MAX_SIZE_MB}MB`));
                            return;
                        }

                        // Create a new File object for upload
                        const newFile = new File([blob], file.name.replace(/\.[^/.]+$/, "") + ".webp", {
                            type: "image/webp",
                            lastModified: Date.now(),
                        });

                        resolve({ blob: newFile, original: file });

                    }, 'image/webp', 0.8); // Quality 0.8
                };

                img.onerror = () => reject(new Error("სურათის ჩატვირთვა ვერ მოხერხდა"));
            });
        }

        // --- SEASONAL PRICING LOGIC ---
        window.addSeasonalRow = function () {
            const tbody = document.getElementById('seasonalPricesBody');
            if (!tbody) return;
            const rowId = 'sp-row-' + Date.now();
            const tr = document.createElement('tr');
            tr.className = "hover:bg-gray-50 transition-colors group";
            tr.id = rowId;

            tr.innerHTML = `
                <td class="p-2 sticky left-0 bg-white group-hover:bg-gray-50 border-r border-gray-100 z-10">
                    <input type="text" placeholder="მაგ: 2 ადგილიანი" class="w-full px-2 py-1.5 text-xs border border-gray-200 rounded focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 outline-none">
                </td>
                <td class="p-1 text-center bg-white group-hover:bg-gray-50 border-r border-gray-100 z-10">
                    <button type="button" onclick="fillSeasonalRow(this)" class="p-1 text-emerald-500 hover:bg-emerald-50 rounded transition-colors" title="იანვრის ფასის ყველგან გავრცელება">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" /></svg>
                    </button>
                </td>
                ${Array(12).fill(0).map(() => `
                    <td class="p-1">
                        <input type="number" min="0" class="w-full px-1 py-1.5 text-xs text-center border border-gray-200 rounded focus:border-emerald-500 outline-none" placeholder="-">
                    </td>
                `).join('')}
                <td class="p-2 text-center">
                    <button type="button" onclick="document.getElementById('${rowId}').remove()" class="text-gray-300 hover:text-red-500 transition-colors">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        };

        window.fillSeasonalRow = function (btn) {
            const tr = btn.closest('tr');
            const inputs = tr.querySelectorAll('input[type="number"]');
            if (inputs.length === 0) return;

            const firstVal = inputs[0].value;
            if (!firstVal) {
                alert("ჯერ მიუთითეთ იანვრის ფასი");
                return;
            }

            inputs.forEach(input => input.value = firstVal);
        };

        // --- ENHANCED SUBMIT PROPERTY (OVERRIDES PREVIOUS) ---
        window.submitProperty = async function (e) {
            e.preventDefault();

            // Validate Super VIP availability
            const newTier = document.getElementById('addTier').value;
            const newLocation = document.getElementById('addLocation').value;

            if (newTier === 'super-vip') {
                const { data: existingSVIP, error: checkError } = await State.supabase
                    .from('guesthouse_ge')
                    .select('id')
                    .eq('location', newLocation)
                    .eq('tier', 'super-vip');

                if (existingSVIP && existingSVIP.length > 0) {
                    alert(`ქალაქში "${newLocation}" უკვე არის Super VIP განცხადება. გთხოვთ აირჩიოთ სხვა სტატუსი.`);
                    return;
                }
            }

            if (State.pendingUploads.length === 0) {
                alert("გთხოვთ ატვირთოთ მინიმუმ 1 სურათი");
                return;
            }

            const btn = e.target.querySelector('button[type="submit"]');
            const origText = btn.innerHTML;
            btn.innerHTML = `<svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> იტვირთება...`;
            btn.disabled = true;

            try {
                // 1. Upload Images
                const uploadedUrls = [];
                for (const item of State.pendingUploads) {
                    const file = item.blob;
                    const uniqueId = Math.random().toString(36).substring(2, 9);
                    const safeName = file.name.replace(/[^a-zA-Z0-9.-]/g, '');
                    const fileName = `${Date.now()}_${uniqueId}_${safeName}`;

                    const { data, error } = await State.supabase.storage
                        .from('images') // Correct bucket
                        .upload(fileName, file, { contentType: 'image/webp' });

                    if (error) throw error;

                    const { data: { publicUrl } } = State.supabase.storage
                        .from('images')
                        .getPublicUrl(fileName);

                    uploadedUrls.push(publicUrl);
                }

                // 2. Collect Seasonal Prices
                const seasonalPrices = [];
                document.querySelectorAll('#seasonalPricesBody tr').forEach(row => {
                    const labelInput = row.querySelector('input[type="text"]');
                    if (labelInput && labelInput.value.trim()) {
                        const prices = Array.from(row.querySelectorAll('input[type="number"]')).map(inp => parseInt(inp.value) || 0);
                        seasonalPrices.push({
                            label: labelInput.value.trim(),
                            prices: prices
                        });
                    }
                });

                if (seasonalPrices.length === 0) throw new Error("გთხოვთ დაამატოთ მინიმუმ ერთი ოთახის ტიპი და ფასები.");

                const selectedAmenities = Array.from(document.querySelectorAll('input[name="amenities"]:checked')).map(cb => cb.value);

                const newProp = {
                    name: document.getElementById('addName').value,
                    location: document.getElementById('addLocation').value,
                    type: document.getElementById('addType').value,
                    tier: document.getElementById('addTier').value,
                    seasonal_prices: seasonalPrices, // JSONB
                    image_url: uploadedUrls[0],
                    images: uploadedUrls,
                    amenities: selectedAmenities,
                    description: document.getElementById('addDescription').value,
                    phone: document.getElementById('addPhone').value,
                    rating: 5.0,
                    reviews: 0,
                    created_at: new Date(),
                    user_id: State.user ? State.user.id : null // Bind to user
                };

                const { error: insError } = await State.supabase.from('guesthouse_ge').insert([newProp]);
                if (insError) throw insError;

                alert("წარმატებით დაემატა!");
                document.getElementById('addPropertyForm').reset();
                State.pendingUploads = [];
                renderUploadGrid();
                document.getElementById('seasonalPricesBody').innerHTML = '';
                addSeasonalRow();
                closeAddModal();
                fetchProperties();
            } catch (err) {
                console.error(err);
                alert("შეცდომა: " + err.message);
            } finally {
                btn.innerHTML = origText;
                btn.disabled = false;
            }
        };

        // --- AUTH MODAL ---
        window.openAuthModal = function (mode) {
            DOM.authModal.classList.remove('hidden');
            setTimeout(() => {
                DOM.authBackdrop.classList.remove('opacity-0');
                DOM.authContent.classList.remove('opacity-0', 'scale-95');
                DOM.authContent.classList.add('modal-enter');
            }, 10);
            document.body.classList.add('no-scroll');
            switchAuthTab(mode);
        };

        window.closeAuthModal = function () {
            DOM.authBackdrop.classList.add('opacity-0');
            DOM.authContent.classList.remove('modal-enter');
            DOM.authContent.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                DOM.authModal.classList.add('hidden');
                document.body.classList.remove('no-scroll');
            }, 300);
        };

        window.switchAuthTab = function (mode) {
            if (mode === 'login') {
                DOM.tabLogin.classList.replace('auth-tab-inactive', 'auth-tab-active');
                DOM.tabRegister.classList.replace('auth-tab-active', 'auth-tab-inactive');
                DOM.nameFieldContainer.classList.add('hidden');
                DOM.authSubmitText.textContent = 'შესვლა';
                DOM.authFooterText.textContent = 'დაგავიწყდათ პაროლი?';
                DOM.authFooterText.onclick = null;
            } else {
                DOM.tabRegister.classList.replace('auth-tab-inactive', 'auth-tab-active');
                DOM.tabLogin.classList.replace('auth-tab-active', 'auth-tab-inactive');
                DOM.nameFieldContainer.classList.remove('hidden');
                DOM.authSubmitText.textContent = 'რეგისტრაცია';
                DOM.authFooterText.textContent = 'უკვე გაქვთ ანგარიში? შესვლა';
                DOM.authFooterText.onclick = () => switchAuthTab('login');
            }
        };

        // --- GOOGLE AUTH & LOGOUT ---
        window.signInWithGoogle = async function () {
            try {
                const { error } = await State.supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: window.location.origin
                    }
                });
                if (error) throw error;
            } catch (err) {
                console.error("Google Login Error:", err.message);
                alert("Login failed: " + err.message);
            }
        };



        window.handleLogout = async function () {
            try {
                const { error } = await State.supabase.auth.signOut();
                if (error) throw error;
                // UI will update via onAuthStateChange
            } catch (err) {
                console.error("Logout Error:", err.message);
            }
        };

        // --- AUTH UI HANDLER ---
        async function updateAuthUI() {
            const container = document.getElementById('navAuthBtnContainer');
            if (!container) return;

            const { data: { session } } = await State.supabase.auth.getSession();
            const user = session ? session.user : null;

            if (user) {
                const name = user.user_metadata.full_name || user.email;
                const avatar = user.user_metadata.avatar_url || 'https://www.gravatar.com/avatar/?d=mp';

                // პაკეტის შემოწმება
                let tier = 'Free';
                try {
                    const { data } = await State.supabase.from('profiles').select('subscription_tier').eq('id', user.id).single();
                    if (data) tier = data.subscription_tier || 'Free';
                } catch (e) { console.error(e); }

                let tierDisplay = '';
                if (tier === 'super_vip') tierDisplay = `<span class="ml-1 text-amber-500 font-extrabold text-xs uppercase">✨ Super VIP</span>`;
                else if (tier === 'vip') tierDisplay = `<span class="ml-1 text-indigo-600 font-bold text-xs uppercase">💎 VIP</span>`;
                else tierDisplay = `<span class="ml-1 text-gray-500 text-xs">Standard</span><a href="pricing.html" class="ml-2 text-[9px] bg-amber-500 text-white px-1.5 py-0.5 rounded uppercase font-bold hover:bg-amber-600">Upgrade</a>`;

                container.innerHTML = `
                <div class="relative ml-2">
                    <button id="profileTrigger" onclick="toggleProfileDropdown(event)" class="flex items-center space-x-2 focus:outline-none bg-white hover:bg-gray-50 rounded-full pl-1 pr-3 py-1 transition-colors border border-gray-200 shadow-sm">
                        <img src="${avatar}" class="w-8 h-8 rounded-full border border-gray-200 object-cover">
                        <span class="hidden sm:inline text-sm font-bold text-gray-700 max-w-[100px] truncate">${name.split(' ')[0]}</span>
                        <svg class="w-4 h-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </button>
                    
                    <div id="profileDropdown" class="absolute right-0 mt-3 w-64 bg-white rounded-2xl shadow-2xl border border-gray-100 py-2 hidden z-50 animate-fade-in-down">
                        <div class="px-5 py-3 border-b border-gray-100 mb-1">
                            <p class="text-xs text-gray-400 font-medium uppercase tracking-wider">ანგარიში</p>
                            <p class="text-sm font-bold text-gray-900 truncate mt-0.5">${name}</p>
                            <div class="mt-1 flex items-center">${tierDisplay}</div>
                        </div>
                        <div class="py-1">
                            <a href="profile.html" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-amber-50 hover:text-amber-600 transition-colors">
                                <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                                ჩემი განცხადებები
                            </a>
                            <a href="bookings.html" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-indigo-50 hover:text-indigo-600 transition-colors">
                                <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                                ჯავშნები / კალენდარი
                            </a>
                        </div>
                        <div class="border-t border-gray-100 py-1">
                            <button onclick="handleLogout()" class="flex w-full items-center px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition-colors">
                                <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"/></svg>
                                გასვლა
                            </button>
                        </div>
                    </div>
                </div>`;
            } else {
                container.innerHTML = `
                <button onclick="window.location.href='auth.html'" class="bg-[#2d78b1] hover:bg-[#236a9e] text-white font-bold py-2 px-6 rounded-full transition-all shadow-sm">
                    შესვლა
                </button>`;
            }
        }

        // --- DROPDOWN LOGIC ---
        window.toggleProfileDropdown = function (e) { e.stopPropagation(); const d = document.getElementById('profileDropdown'); if (d) d.classList.toggle('hidden'); };

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const d = document.getElementById('profileDropdown');
            const t = document.getElementById('profileTrigger');
            if (d && !d.classList.contains('hidden') && !d.contains(e.target) && (!t || !t.contains(e.target))) {
                d.classList.add('hidden');
            }
        });

        // ==========================================
        //  EVENT LISTENERS ATTACHMENT
        // ==========================================

        function attachEventListeners() {
            // Dropdown Toggler with Explicit Logic
            function toggleList(listElement, show) {
                if (!listElement) return;

                if (show) {
                    // SHOW
                    listElement.classList.remove('opacity-0', 'scale-y-90', 'pointer-events-none', 'hidden');
                    listElement.classList.add('opacity-100', 'scale-y-100', 'pointer-events-auto', 'translate-y-0');
                    // Force High Z-Index
                    listElement.style.zIndex = '9999';
                    listElement.style.pointerEvents = 'auto';
                } else {
                    // HIDE
                    listElement.classList.remove('opacity-100', 'scale-y-100', 'pointer-events-auto', 'translate-y-0');
                    listElement.classList.add('opacity-0', 'scale-y-90', 'pointer-events-none');
                    // Reset Z-Index
                    listElement.style.zIndex = '';
                    listElement.style.pointerEvents = '';
                    // Optional delay for display:none if you want, but opacity is enough
                }
            }

            // Location Input Click
            if (DOM.locationInput) {
                DOM.locationInput.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isClosed = DOM.locationList.classList.contains('opacity-0');
                    toggleList(DOM.typeList, false);      // Close Type
                    toggleList(DOM.locationList, isClosed); // Toggle Location
                });
            }

            // Location Search Input Click
            if (DOM.locationSearch) {
                DOM.locationSearch.addEventListener('click', e => e.stopPropagation());
                DOM.locationSearch.addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase();
                    const filtered = State.cities.filter(c => c.name_ka.toLowerCase().includes(term));
                    renderLocationList(filtered);
                });
            }

            // Type Input Click (Parent Wrapper)
            if (DOM.typeInput) {
                DOM.typeInput.parentElement.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isClosed = DOM.typeList.classList.contains('opacity-0');
                    toggleList(DOM.locationList, false);  // Close Location
                    toggleList(DOM.typeList, isClosed);     // Toggle Type
                });
            }

            // Type List Item Selection
            if (DOM.typeList) {
                DOM.typeList.addEventListener('click', (e) => {
                    // Handle <li> clicks
                    if (e.target.tagName === 'LI') {
                        selectType(e.target.dataset.value, e.target.textContent.trim());
                    }
                    // Handle clicks on children of <li>
                    const li = e.target.closest('li');
                    if (li) {
                        selectType(li.dataset.value, li.textContent.trim());
                    }
                });
            }

            // Global Click Outside
            document.addEventListener('click', (e) => {
                // Check if click is outside Location Group
                const outsideLoc = DOM.locationDropdown && !DOM.locationDropdown.contains(e.target);
                if (outsideLoc) toggleList(DOM.locationList, false);

                // Check if click is outside Type Group
                const outsideType = DOM.typeDropdown && !DOM.typeDropdown.contains(e.target);
                if (outsideType) toggleList(DOM.typeList, false);
            });

            // Navbar Scroll
            window.addEventListener('scroll', () => {
                // Navbar is always white now
            });

            // Show More
            if (DOM.showMoreBtn) {
                DOM.showMoreBtn.addEventListener('click', () => {
                    State.visibleCount += CONFIG.ITEMS_PER_PAGE;
                    render();
                });
            }

            // Modal Backdrops
            if (DOM.modalBackdrop) DOM.modalBackdrop.addEventListener('click', window.closeModal);
            if (DOM.authBackdrop) DOM.authBackdrop.addEventListener('click', window.closeAuthModal);
            if (DOM.addBackdrop) DOM.addBackdrop.addEventListener('click', window.closeAddModal);

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    window.closeModal();
                    window.closeAuthModal();
                    window.closeAddModal();
                }
            });
        }

        // --- INITIALIZATION ---
        async function init() {
            try {
                State.supabase = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);

                // Auth Listener
                State.supabase.auth.onAuthStateChange((event, session) => {
                    State.user = session ? session.user : null;
                    updateAuthUI();
                });

                // Check Session
                const { data: { session } } = await State.supabase.auth.getSession();
                State.user = session ? session.user : null;
                updateAuthUI();

                // Initial Fetch
                // Initial Fetch
                // Initial Fetch
                if (typeof fetchLocations === 'function') await fetchLocations();
                if (typeof fetchProperties === 'function') await fetchProperties();

                const params = new URLSearchParams(window.location.search);
                if (params.get('auth')) window.location.href = 'auth.html';
                if (typeof populateAddModalAmenities === 'function') populateAddModalAmenities();

                // Attach Interactions
                attachEventListeners();

            } catch (e) {
                console.error("Init Error:", e);
            }
        }
        document.addEventListener('DOMContentLoaded', init);
    </script>
    <!-- PRE-AUTH BRIDGE MODAL -->
    <div id="preAuthModal" class="fixed inset-0 z-[80] hidden" aria-modal="true" role="dialog">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closePreAuthModal()">
        </div>

        <!-- Modal Content -->
        <div class="absolute inset-0 flex items-center justify-center p-4 pointer-events-none">
            <div
                class="bg-white rounded-3xl shadow-2xl w-full max-w-sm overflow-hidden pointer-events-auto transform transition-all duration-300 opacity-0 scale-95">
                <!-- Header Icon/Image -->
                <div class="bg-amber-100 p-6 flex justify-center">
                    <div class="w-20 h-20 bg-amber-200 rounded-full flex items-center justify-center shadow-inner">
                        <svg class="w-10 h-10 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                    </div>
                </div>

                <!-- Text Content -->
                <div class="p-8 text-center">
                    <h3 class="text-2xl font-bold text-gray-900 mb-2">გსურთ განცხადების დამატება?</h3>
                    <p class="text-gray-600 mb-8 leading-relaxed">
                        განცხადების განსათავსებლად, გთხოვთ, ჯერ გაიაროთ ავტორიზაცია ან რეგისტრაცია.
                    </p>

                    <!-- Action Buttons -->
                    <button onclick="window.location.href='auth.html'"
                        class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3.5 px-6 rounded-xl shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-0.5 mb-3 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
                        </svg>
                        შესვლა
                    </button>
                    <button onclick="closePreAuthModal()"
                        class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-3 px-6 rounded-xl transition-colors">
                        გაუქმება
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- FULLSCREEN IMAGE MODAL -->
    <div id="fullscreenModal"
        class="fixed inset-0 z-[70] hidden opacity-0 transition-opacity duration-300 bg-black/95 backdrop-blur-xl"
        onclick="closeFullscreen()">
        <!-- Close Button -->
        <button onclick="closeFullscreen()"
            class="absolute top-4 right-4 bg-black/60 text-white hover:bg-red-500 hover:scale-110 shadow-lg border border-white/10 backdrop-blur-sm transition-all duration-300 p-2 z-50 rounded-full">
            <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>

        <!-- Navigation Buttons -->
        <button id="fsPrev" onclick="navigateFullscreen(-1, event)"
            class="absolute left-4 top-1/2 transform -translate-y-1/2 bg-black/60 text-white hover:bg-emerald-500 hover:scale-110 shadow-lg border border-white/10 backdrop-blur-sm transition-all duration-300 p-3 z-50 rounded-full">
            <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
        </button>
        <button id="fsNext" onclick="navigateFullscreen(1, event)"
            class="absolute right-4 top-1/2 transform -translate-y-1/2 bg-black/60 text-white hover:bg-emerald-500 hover:scale-110 shadow-lg border border-white/10 backdrop-blur-sm transition-all duration-300 p-3 z-50 rounded-full">
            <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
        </button>

        <!-- Counter -->
        <div id="fsCounter"
            class="absolute bottom-6 left-1/2 transform -translate-x-1/2 text-white/90 bg-black/40 backdrop-blur-md px-4 py-1 rounded-full text-sm font-medium z-50 pointer-events-none">

        </div>

        <div class="w-full h-full flex items-center justify-center p-4">
            <img id="fullscreenImage" src=""
                class="max-w-full max-h-full object-contain rounded shadow-2xl transition-opacity duration-150"
                onclick="event.stopPropagation()">
        </div>
    </div>
</body>

</html>